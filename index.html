<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#7A9163">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ok Snap">
    <title>Ok Snap - Discover Food Through Your Lens</title>
    <script>
        // Only load icons and manifest if not using file:// protocol (avoids CORS/file errors)
        if (window.location.protocol !== 'file:') {
            // Add favicon
            const favicon = document.createElement('link');
            favicon.rel = 'icon';
            favicon.type = 'image/png';
            favicon.href = 'icon-192.png';
            document.head.appendChild(favicon);
            
            // Add Apple touch icons
            const appleIcon1 = document.createElement('link');
            appleIcon1.rel = 'apple-touch-icon';
            appleIcon1.href = 'icon-192.png';
            document.head.appendChild(appleIcon1);
            
            const appleIcon2 = document.createElement('link');
            appleIcon2.rel = 'apple-touch-icon';
            appleIcon2.sizes = '512x512';
            appleIcon2.href = 'icon-512.png';
            document.head.appendChild(appleIcon2);
            
            // Add manifest
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = 'manifest.json';
            document.head.appendChild(manifestLink);
        } else {
            // Fallback: use logo files if available when using file://
            const logoIcon = document.createElement('link');
            logoIcon.rel = 'icon';
            logoIcon.type = 'image/png';
            logoIcon.href = 'logo-light.png';
            document.head.appendChild(logoIcon);
        }
    </script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+KR:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Design System Color Palette */
            --primary: #7A9163;
            --secondary: #E6E2D3;
            --accent: #D4CBBE;
            --background: #FFFFFF;
            --text-primary: #2F2F2F;
            --text-secondary: #777777;
            --text-link: #7A9163;
            --status-success: #7A9163;
            --status-warning: #E4C46A;
            --status-error: #E97A7A;
            
            /* Legacy support */
            --bg: #FFFFFF;
            --surface: #FFFFFF;
            --text: #2F2F2F;
            --text-light: #777777;
            --border: #E6E2D3;
            --success: #7A9163;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-lg: rgba(0, 0, 0, 0.12);
        }

        :root[data-theme="dark"] {
            --primary: #7A9163;
            --secondary: #3A3A3A;
            --accent: #4A4A4A;
            --background: #1E1E1E;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --text-link: #9AB87A;
            --bg: #1E1E1E;
            --surface: #2A2A2A;
            --text: #FFFFFF;
            --text-light: #B0B0B0;
            --border: #3A3A3A;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-lg: rgba(0, 0, 0, 0.5);
        }

        html {
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            transition: background 200ms ease-in-out;
            font-size: 1rem;
            font-weight: 400;
            overflow-x: hidden;
            position: relative;
            padding-bottom: env(safe-area-inset-bottom);
        }

        [data-theme="dark"] body {
            background: #1E1E1E;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 16px;
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
            display: flex;
            flex-direction: column;
            gap: 24px;
            width: 100%;
            box-sizing: border-box;
        }

        header {
            background: var(--background);
            padding: 4px 16px;
            padding-top: max(4px, env(safe-area-inset-top));
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: all 200ms ease-in-out;
            width: 100%;
            box-sizing: border-box;
            min-height: 80px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
        }

        .app-logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-image {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            object-fit: contain;
            flex-shrink: 0;
            transition: opacity 0.3s ease;
        }
        
        /* Show light logo by default, hide dark logo */
        .logo-light {
            display: block !important;
        }
        
        .logo-dark {
            display: none !important;
        }
        
        /* In dark mode, show dark logo and hide light logo */
        [data-theme="dark"] .logo-light {
            display: none !important;
        }
        
        [data-theme="dark"] .logo-dark {
            display: block !important;
        }
        
        /* Legacy monogram logo (kept for fallback if images don't load) */
        .monogram-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, #9AB87A 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: -1px;
            box-shadow: 0 2px 8px rgba(122, 145, 99, 0.3);
            flex-shrink: 0;
        }

        .scan-counter-header {
            transition: all 200ms ease-in-out;
        }

        .auth-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .premium-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        .premium-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .premium-btn:active {
            transform: translateY(0);
        }

        .profile-greeting {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 200ms ease;
        }
        
        .profile-greeting:hover {
            background: var(--accent);
            transform: translateY(-1px);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .login-btn {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 16px;
            min-height: 44px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 400;
            font-size: 0.875rem;
            transition: all 200ms ease-in-out;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .login-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(122, 145, 99, 0.1);
        }

        .language-toggle {
            background: transparent;
            border: 1px solid var(--border);
            padding: 10px 12px;
            min-height: 44px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: all 200ms ease-in-out;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .language-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .hero-card {
            background: var(--background);
            border-radius: 24px;
            padding: 32px 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            animation: fadeInUp 300ms ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-section {
            width: 100%;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 48px 24px;
            min-height: 200px;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            background: var(--secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            width: 100%;
            box-sizing: border-box;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: var(--accent);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: var(--accent);
            transform: scale(1.01);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.7;
            color: var(--text-secondary);
        }

        .upload-text {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .upload-hint {
            color: var(--text-primary);
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #fileInput {
            display: none;
        }

        .scan-limit-info {
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--secondary);
            font-weight: 500;
            transition: all 200ms ease-in-out;
            margin-bottom: 12px;
        }

        .scan-limit.guest {
            color: var(--text-secondary);
        }

        .scan-limit.free {
            color: var(--primary);
        }

        .scan-limit.premium {
            color: #FFD700;
            font-weight: 600;
        }

        .scan-limit.limit-low {
            background: #FFF4E6;
            color: #E67E22;
        }

        .scan-limit.limit-exceeded {
            background: #FFE6E6;
            color: var(--status-error);
            font-weight: 600;
        }

        .upload-options {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .camera-btn {
            background: var(--secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 12px 24px;
            min-height: 44px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 400;
            font-size: 0.875rem;
            transition: all 200ms ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            flex: 1;
        }

        .camera-btn:hover {
            background: var(--accent);
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .camera-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Camera Modal */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-container {
            position: relative;
            width: 90%;
            max-width: 600px;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #cameraVideo {
            width: 100%;
            display: block;
            max-height: 80vh;
            object-fit: contain;
        }

        .camera-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding: 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            align-items: center;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 5px solid white;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
        }

        .capture-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 255, 255, 0.5);
        }

        .capture-btn:active {
            transform: scale(0.95);
        }

        .capture-btn::after {
            content: '';
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
        }

        .camera-close-btn, .camera-flip-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 0.8rem 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .camera-close-btn:hover, .camera-flip-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .camera-error {
            color: white;
            text-align: center;
            padding: 2rem;
        }

        .camera-error h3 {
            margin-bottom: 1rem;
        }

        #previewContainer {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .preview-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .remove-preview {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .remove-preview:hover {
            background: rgba(211, 47, 47, 0.9);
            transform: scale(1.1);
        }

        #uploadPlaceholder {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 32px;
            min-height: 44px;
            font-size: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(122, 145, 99, 0.2);
            margin-top: 8px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(122, 145, 99, 0.3);
            opacity: 0.95;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            display: none;
            background: var(--surface);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            animation: fadeInUp 300ms ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .result-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .confidence-badge {
            background: var(--status-success);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 400;
            font-size: 0.875rem;
        }

        .confidence-badge.medium {
            background: var(--status-warning);
        }

        .confidence-badge.low {
            background: var(--status-error);
        }

        .dish-image {
            width: 100%;
            max-width: 100%;
            border-radius: 16px;
            margin: 0 auto 16px;
            display: block;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .dish-description {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding: 16px;
            background: var(--secondary);
            border-radius: 12px;
        }

        .alternatives {
            margin: 2rem 0;
        }

        .alternatives-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .alternative-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .chip {
            background: var(--secondary);
            padding: 10px 16px;
            min-height: 44px;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 200ms ease-in-out;
            font-size: 0.875rem;
            color: var(--text-primary);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: inline-flex;
            align-items: center;
        }

        .chip:hover {
            border-color: var(--primary);
            background: var(--accent);
            transform: scale(1.02);
        }

        .nutrition-section {
            margin-top: 16px;
            padding: 16px;
            background: var(--secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .nutrition-item {
            text-align: center;
        }

        .nutrition-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .nutrition-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recipe-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .recipe-links {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .recipe-link {
            display: inline-flex;
            align-items: center;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            padding: 0.875rem 1rem;
            min-height: 44px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            transition: all 200ms ease-in-out;
            background: var(--background);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            width: 100%;
            justify-content: space-between;
        }

        .recipe-link:hover {
            color: var(--text-link);
            background: var(--secondary);
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(122, 145, 99, 0.15);
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            width: 100%;
        }

        .action-buttons .btn-secondary {
            min-width: 0;
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 12px 24px;
            min-height: 44px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            font-weight: 400;
            font-size: 0.875rem;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.02);
        }

        .btn-secondary.active {
            background: var(--primary);
            color: white;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
            padding: 12px 24px;
            min-height: 44px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            font-weight: 600;
            font-size: 0.875rem;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            width: 100%;
            margin-top: 0.5rem;
        }

        .btn-primary:hover {
            background: #6a8055;
            transform: scale(1.02);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Bottom Navigation */
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 420px;
            background: var(--background);
            border-top: 1px solid var(--border);
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px 0;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            z-index: 100;
            box-sizing: border-box;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 16px;
            min-height: 44px;
            min-width: 44px;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            border: none;
            background: transparent;
            color: #A0A0A0;
            font-size: 0.75rem;
            font-weight: 400;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            flex: 1;
        }

        .nav-item:hover {
            color: var(--primary);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            stroke-width: 1.5;
        }

        .nav-item.active svg {
            stroke-width: 2;
        }

        .tab-content {
            display: none;
            padding-bottom: calc(80px + env(safe-area-inset-bottom)); /* Space for bottom navigation + safe area */
        }

        .tab-content.active {
            display: block;
        }

        /* Feature Row */
        .feature-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 16px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .feature-item svg {
            width: 16px;
            height: 16px;
            color: var(--primary);
        }

        .history-section, .favorites-section, .settings-section, .calorie-log-section {
            background: var(--surface);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .daily-totals {
            background: var(--secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .total-item {
            text-align: center;
            margin-bottom: 16px;
        }

        .total-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .total-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nutrition-breakdown {
            display: flex;
            justify-content: space-around;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .breakdown-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .breakdown-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .breakdown-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .log-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .log-item {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-item-info {
            flex: 1;
        }

        .log-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .log-item-nutrition {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .log-item-calories {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            margin-left: 16px;
        }

        .log-item-delete {
            background: transparent;
            border: none;
            color: var(--status-error);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px 8px;
            margin-left: 8px;
        }

        .settings-section {
            max-width: 100%;
        }
        
        .profile-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border);
        }
        
        .profile-card-header {
            margin-bottom: 20px;
        }
        
        .profile-card-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .profile-card-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .profile-picture-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .profile-picture-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid var(--primary);
        }
        
        .profile-picture-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-picture-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        .profile-picture-placeholder svg {
            width: 60px;
            height: 60px;
        }
        
        .profile-form-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .profile-form-section label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .settings-label h3 {
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 600;
        }

        .settings-label p {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            min-width: 50px;
            flex-shrink: 0;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .language-select {
            padding: 0.6rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }

        .version-info {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-grid, .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.5rem;
        }

        .history-item, .favorite-item {
            background: var(--secondary);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            border: 1px solid var(--border);
        }

        .history-item:hover, .favorite-item:hover {
            border-color: var(--primary);
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(122, 145, 99, 0.15);
        }

        .item-thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .item-name {
            font-weight: 400;
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 4px;
        }

        .item-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.3;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.875rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .feedback-tooltip {
            position: fixed;
            background: var(--text-primary);
            color: var(--background);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(5px);
            transition: opacity 300ms ease, transform 300ms ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            max-width: 90vw;
            white-space: normal;
            text-align: center;
        }

        .feedback-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        .feedback-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--text-primary);
        }

        .error-message {
            background: rgba(233, 122, 122, 0.1);
            border-left: 3px solid var(--status-error);
            padding: 16px;
            border-radius: 8px;
            color: var(--status-error);
            margin: 16px 0;
            font-size: 0.875rem;
        }

        .warm-message {
            background: var(--secondary);
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            border-left: 3px solid var(--primary);
            font-style: italic;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        /* Login Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: 24px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            animation: slideUp 200ms ease-in-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: var(--bg);
            color: var(--text);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 400;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            min-height: 44px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 200ms ease-in-out;
            background: var(--background);
            color: var(--text-primary);
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
            touch-action: manipulation;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(122, 145, 99, 0.1);
        }

        .auth-divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
            color: var(--text-light);
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .auth-divider::before {
            left: 0;
        }

        .auth-divider::after {
            right: 0;
        }

        .google-btn {
            width: 100%;
            background: var(--background);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 14px 20px;
            min-height: 44px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 400;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 200ms ease-in-out;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            margin-top: 1rem;
        }

        .google-btn:hover {
            border-color: var(--primary);
            background: var(--secondary);
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .error-text {
            color: var(--primary);
            font-size: 0.85rem;
            margin-top: -0.5rem;
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .auth-switch a {
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                gap: 20px;
            }

            header {
                padding: 14px 16px;
                padding-top: max(14px, env(safe-area-inset-top));
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }

            .header-content {
                gap: 12px;
            }

            .app-logo {
                font-size: 1.25rem;
                gap: 8px;
            }

            .logo-image {
                width: 72px;
                height: 72px;
            }
            
            .monogram-logo {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .auth-section {
                gap: 6px;
            }

            .login-btn, .language-toggle {
                padding: 10px 14px;
                font-size: 0.813rem;
            }

            .hero-card {
                padding: 24px 20px;
                border-radius: 20px;
                gap: 20px;
            }

            .upload-section {
                padding: 0;
                width: 100%;
            }

            .upload-area {
                padding: 40px 20px;
                min-height: 180px;
                border-radius: 16px;
            }

            .upload-icon {
                width: 56px;
                height: 56px;
            }

            .upload-text {
                font-size: 1.25rem;
                margin-bottom: 6px;
            }

            .upload-hint {
                font-size: 0.813rem;
            }

            .upload-options {
                flex-direction: column;
                gap: 12px;
                width: 100%;
            }

            .camera-btn, .btn {
                width: 100%;
                font-size: 0.938rem;
            }

            .result-section {
                padding: 20px;
                border-radius: 20px;
                margin-bottom: 20px;
            }

            .result-header {
                flex-wrap: wrap;
                gap: 12px;
                margin-bottom: 16px;
                padding-bottom: 12px;
            }

            .result-title {
                font-size: 1.25rem;
                line-height: 1.4;
            }

            .confidence-badge {
                font-size: 0.813rem;
                padding: 6px 10px;
            }

            .dish-image {
                border-radius: 16px;
                margin-bottom: 16px;
                max-height: 300px;
                object-fit: contain;
            }

            .dish-description {
                font-size: 0.938rem;
                padding: 16px;
                line-height: 1.6;
                margin-bottom: 16px;
            }

            .recipe-section {
                margin-top: 20px;
                padding-top: 20px;
            }

            .recipe-links {
                gap: 0.75rem;
            }

            .recipe-link {
                padding: 12px 16px;
                font-size: 0.938rem;
            }

            .action-buttons {
                gap: 12px;
                flex-direction: column;
            }

            .action-buttons .btn-secondary {
                width: 100%;
            }

            .history-section, .favorites-section, .settings-section {
                padding: 20px;
                border-radius: 20px;
                margin-bottom: 20px;
            }

            .history-grid, .favorites-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 12px;
            }

            .history-item, .favorite-item {
                min-height: 120px;
            }

            .modal {
                padding: 24px 20px;
                max-width: 90%;
                margin: 20px;
                border-radius: 20px;
            }

            .modal-header {
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 18px;
            }

            .form-input {
                padding: 12px 16px;
                font-size: 1rem;
                min-height: 44px;
            }

            .google-btn {
                padding: 14px 20px;
                min-height: 44px;
                font-size: 0.938rem;
            }

            .camera-container {
                width: 100%;
                max-width: 100%;
                border-radius: 0;
            }

            .camera-controls {
                padding: 20px 16px;
                padding-bottom: max(20px, calc(16px + env(safe-area-inset-bottom)));
            }

            .capture-btn {
                width: 64px;
                height: 64px;
                min-height: 64px;
            }

            .capture-btn::after {
                width: 44px;
                height: 44px;
            }

            .camera-close-btn, .camera-flip-btn {
                padding: 10px 16px;
                min-height: 44px;
                font-size: 0.875rem;
            }

            .feature-row {
                flex-wrap: wrap;
                gap: 12px;
                padding: 12px 16px;
                font-size: 0.813rem;
            }

            .bottom-navigation {
                padding: 10px 0;
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }

            .nav-item {
                padding: 8px 12px;
                font-size: 0.688rem;
                min-height: 48px;
            }

            .nav-item svg {
                width: 22px;
                height: 22px;
            }

            .settings-item {
                padding: 1.25rem 0;
            }

            .settings-label h3 {
                font-size: 1rem;
            }

            .settings-label p {
                font-size: 0.813rem;
            }
        }

        /* Small Phone Optimizations */
        @media (max-width: 480px) {
            .container {
                padding: 12px;
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
                gap: 16px;
            }

            header {
                padding: 12px;
                padding-top: max(12px, env(safe-area-inset-top));
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
            }

            .app-logo {
                font-size: 1.125rem;
                gap: 6px;
            }

            .logo-image {
                width: 64px;
                height: 64px;
            }
            
            .monogram-logo {
                width: 32px;
                height: 32px;
                font-size: 0.938rem;
            }

            .auth-section {
                gap: 4px;
            }

            .login-btn, .language-toggle {
                padding: 8px 12px;
                font-size: 0.75rem;
                min-height: 40px;
            }

            .hero-card {
                padding: 20px 16px;
                border-radius: 16px;
                gap: 16px;
            }

            .upload-area {
                padding: 32px 16px;
                min-height: 160px;
                border-radius: 12px;
            }

            .upload-icon {
                width: 48px;
                height: 48px;
                margin-bottom: 12px;
            }

            .upload-text {
                font-size: 1.125rem;
                margin-bottom: 4px;
            }

            .upload-hint {
                font-size: 0.75rem;
                line-height: 1.5;
            }

            .btn {
                padding: 12px 24px;
                font-size: 0.938rem;
                width: 100%;
            }

            .camera-btn {
                padding: 12px 20px;
                font-size: 0.875rem;
            }

            .result-section {
                padding: 16px;
                border-radius: 16px;
                margin-bottom: 16px;
            }

            .result-title {
                font-size: 1.125rem;
            }

            .confidence-badge {
                font-size: 0.75rem;
                padding: 5px 8px;
            }

            .dish-image {
                border-radius: 12px;
                margin-bottom: 12px;
                max-height: 250px;
            }

            .dish-description {
                font-size: 0.875rem;
                padding: 14px;
                margin-bottom: 12px;
            }

            .alternatives-title {
                font-size: 0.938rem;
                margin-bottom: 10px;
            }

            .chip {
                padding: 8px 14px;
                font-size: 0.813rem;
                min-height: 40px;
            }

            .recipe-section {
                margin-top: 16px;
                padding-top: 16px;
            }

            .recipe-links {
                gap: 0.625rem;
            }

            .recipe-link {
                padding: 10px 14px;
                font-size: 0.875rem;
                min-height: 40px;
            }

            .action-buttons {
                gap: 10px;
                margin-top: 1.25rem;
            }

            .btn-secondary {
                padding: 12px 20px;
                font-size: 0.875rem;
            }

            .history-section, .favorites-section, .settings-section {
                padding: 16px;
                border-radius: 16px;
                margin-bottom: 16px;
            }

            .history-grid, .favorites-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 10px;
            }

            .history-item, .favorite-item {
                min-height: 110px;
                border-radius: 12px;
                padding: 10px;
            }

            .item-name {
                font-size: 0.813rem;
            }

            .item-time {
                font-size: 0.688rem;
            }

            .modal {
                padding: 20px 16px;
                max-width: 95%;
                margin: 16px;
                border-radius: 16px;
            }

            .modal-title {
                font-size: 1.25rem;
            }

            .form-input {
                padding: 12px 14px;
                font-size: 0.938rem;
            }

            .google-btn {
                padding: 12px 16px;
                font-size: 0.875rem;
            }

            .camera-controls {
                padding: 16px;
                padding-bottom: max(16px, calc(16px + env(safe-area-inset-bottom)));
                gap: 0.75rem;
            }

            .capture-btn {
                width: 60px;
                height: 60px;
                min-height: 60px;
            }

            .capture-btn::after {
                width: 40px;
                height: 40px;
            }

            .camera-close-btn, .camera-flip-btn {
                padding: 8px 14px;
                font-size: 0.813rem;
                min-height: 40px;
            }

            .feature-row {
                gap: 10px;
                padding: 10px 12px;
                font-size: 0.75rem;
            }

            .bottom-navigation {
                padding: 8px 0;
                padding-bottom: max(8px, env(safe-area-inset-bottom));
            }

            .nav-item {
                padding: 6px 8px;
                font-size: 0.625rem;
                min-height: 44px;
                gap: 3px;
            }

            .nav-item svg {
                width: 20px;
                height: 20px;
            }

            .settings-item {
                padding: 1rem 0;
            }

            .settings-label h3 {
                font-size: 0.938rem;
            }

            .settings-label p {
                font-size: 0.75rem;
            }

            .toggle-switch {
                width: 46px;
                height: 26px;
            }

            .section-title {
                font-size: 1.125rem;
            }

            .warm-message {
                padding: 14px 16px;
                border-radius: 12px;
                font-size: 0.875rem;
            }
        }

        /* Ensure images never overflow */
        img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .preview-image, .dish-image {
            max-width: 100%;
            width: 100%;
            height: auto;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="app-logo" id="appLogo" style="cursor: pointer;">
                <img src="logo-light.png" alt="Ok Snap" class="logo-image logo-light" id="logoLight">
                <img src="logo-dark.png" alt="Ok Snap" class="logo-image logo-dark" id="logoDark">
            </div>
            <div class="auth-section" id="authSection">
                <div class="scan-counter-header" id="scanCounterHeader" style="display: flex; align-items: center; margin-right: 12px; padding: 6px 12px; background: var(--secondary); border-radius: 20px; font-size: 0.875rem; font-weight: 500;">
                    <span id="scanCounterText">3 scans left</span>
                </div>
                <div class="user-profile" id="userProfile" style="display: none;">
                    <div class="profile-greeting" id="profileGreeting" style="cursor: pointer;">
                        <span id="greetingText"></span>
                    </div>
                    <button class="login-btn" id="logoutBtn" style="display: none;">Logout</button>
                </div>
                <button class="premium-btn" id="premiumBtn"> Premium</button>
                <button class="login-btn" id="loginBtn">Login</button>
            </div>
        </div>
    </header>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Login</h2>
                <button class="close-modal" id="closeModal"></button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="auth-info" style="text-align: center; margin-bottom: 24px; color: var(--text-secondary);">
                    <p>Sign in to save your favorite dishes</p>
                </div>
                
                <form id="emailLoginForm" style="margin-bottom: 1.5rem;">
                    <input 
                        type="email" 
                        id="loginEmail" 
                        class="form-input" 
                        placeholder="Email address" 
                        required 
                        autocomplete="email"
                        style="margin-bottom: 12px;">
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="form-input" 
                        placeholder="Password" 
                        required 
                        autocomplete="current-password"
                        style="margin-bottom: 12px;">
                    <button type="submit" class="btn" style="width: 100%; margin-top: 8px;" id="emailLoginBtn">
                        Sign In
                    </button>
                    <div style="text-align: center; margin-top: 12px;">
                        <button type="button" id="forgotPasswordBtn" style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; font-size: 0.9rem;">Forgot password?</button>
                    </div>
                </form>
                
                <div style="text-align: center; margin-top: 1rem;">
                    <span style="color: var(--text-secondary);">Don't have an account? </span>
                    <button type="button" id="switchToSignup" style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; font-weight: 600;">Sign up</button>
                </div>
                
                <div class="error-text" id="loginError"></div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <div class="auth-info" style="text-align: center; margin-bottom: 24px; color: var(--text-secondary);">
                    <p>Create an account to save your favorite dishes</p>
                </div>
                
                <form id="emailSignupForm" style="margin-bottom: 1.5rem;">
                    <input 
                        type="text" 
                        id="signupNickname" 
                        class="form-input" 
                        placeholder="Nickname" 
                        required 
                        autocomplete="nickname"
                        style="margin-bottom: 12px;">
                    <input 
                        type="email" 
                        id="signupEmail" 
                        class="form-input" 
                        placeholder="Email address" 
                        required 
                        autocomplete="email"
                        style="margin-bottom: 12px;">
                    <input 
                        type="password" 
                        id="signupPassword" 
                        class="form-input" 
                        placeholder="Password (min. 6 characters)" 
                        required 
                        autocomplete="new-password"
                        minlength="6"
                        style="margin-bottom: 12px;">
                    <button type="submit" class="btn" style="width: 100%; margin-top: 8px;" id="emailSignupBtn">
                        Sign Up
                    </button>
                </form>
                
                <div style="text-align: center; margin-top: 1rem;">
                    <span style="color: var(--text-secondary);">Already have an account? </span>
                    <button type="button" id="switchToLogin" style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; font-weight: 600;">Sign in</button>
                </div>
                
                <div class="error-text" id="signupError"></div>
            </div>
        </div>
    </div>

    <!-- Premium Subscription Modal -->
    <div class="modal-overlay" id="premiumModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title"> Upgrade to Premium</h2>
                <button class="close-modal" id="closePremiumModal"></button>
            </div>
            
            <div style="padding: 24px;">
                <!-- Premium Benefits -->
                <div style="margin-bottom: 32px;">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.25rem;">Unlock Premium Features</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">50 Scans Per Day</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">5x more than free users</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Ad-Free Experience</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">No interruptions, just food discovery</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Unlimited Favorites</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Save all your favorite dishes</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Advanced Analytics</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Track your nutrition trends</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Priority Support</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Get help when you need it</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div style="background: var(--secondary); padding: 24px; border-radius: 12px; margin-bottom: 24px; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary); margin-bottom: 8px;">
                        $9.99
                    </div>
                    <div style="color: var(--text-secondary); margin-bottom: 16px;">per month</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        Cancel anytime  No hidden fees
                    </div>
                </div>

                <!-- CTA Buttons -->
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn" id="subscribePremiumBtn" style="width: 100%; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; font-weight: 600; padding: 14px;">
                         Subscribe to Premium
                    </button>
                    
                    <div style="text-align: center; margin-top: 16px;">
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 8px;">
                            Already have Premium?
                        </p>
                        <button type="button" id="checkPremiumStatusBtn" style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; font-size: 0.9rem;">
                            Check Premium Status
                        </button>
                    </div>
                </div>

                <!-- Free Trial Info -->
                <div style="margin-top: 24px; padding: 16px; background: #E8F5E9; border-radius: 8px; text-align: center;">
                    <div style="font-weight: 600; color: #2E7D32; margin-bottom: 4px;">
                         7-Day Free Trial
                    </div>
                    <div style="font-size: 0.875rem; color: #388E3C;">
                        Try Premium free for 7 days, then $9.99/month
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- Discover Tab -->
        <div class="tab-content active" id="discoverTab">
            <!-- Hero Card -->
            <div class="hero-card">
                <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div id="previewContainer" style="display: none;" onclick="event.stopPropagation()">
                        <img id="previewImage" class="preview-image" alt="Preview">
                        <button type="button" class="remove-preview" id="removePreview" title="Remove image"></button>
                    </div>
                    <div id="uploadPlaceholder">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <div class="upload-text" id="uploadText">Upload a photo of food</div>
                        <div class="upload-hint" id="uploadHint">Drag and drop or click to browse  Korean dishes emphasized</div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                <div class="upload-options">
                    <div class="scan-limit-info" id="scanLimitDisplay" style="text-align: center; margin-bottom: 12px; font-size: 0.875rem; color: var(--text-secondary);">
                        3/3 scans (Guest)
                    </div>
                    <button class="btn" id="analyzeBtn" disabled>Discover Your Dish</button>
                    <button class="camera-btn" id="cameraBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        <span id="cameraBtnText">Use Camera</span>
                    </button>
                </div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="analyzingText" style="color: var(--text-light); font-size: 1.1rem;">Analyzing your photo... This might take a moment.</p>
            </div>

            <!-- Result Section -->
            <div class="result-section" id="resultSection">
                <div class="result-header">
                    <h2 class="result-title" id="dishName"></h2>
                    <span class="confidence-badge" id="confidenceBadge"></span>
                </div>
                <img class="dish-image" id="dishImage" alt="Uploaded dish">
                <div class="dish-description" id="dishDescription"></div>
                
                <!-- Nutrition Info Section -->
                <div class="nutrition-section" id="nutritionSection" style="display: none;">
                    <h3 id="nutritionTitle" style="margin-bottom: 0.75rem; color: var(--text); font-size: 1.1rem;">Nutrition (per serving)</h3>
                    <div class="nutrition-grid" id="nutritionGrid">
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="nutritionCalories">0</div>
                            <div class="nutrition-label">Calories</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="nutritionProtein">0g</div>
                            <div class="nutrition-label">Protein</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="nutritionCarbs">0g</div>
                            <div class="nutrition-label">Carbs</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="nutritionFat">0g</div>
                            <div class="nutrition-label">Fat</div>
                        </div>
                    </div>
                </div>
                
                <div class="alternatives" id="alternativesSection" style="display: none;">
                    <div class="alternatives-title" id="couldAlsoBe">Could also be:</div>
                    <div class="alternative-chips" id="alternativeChips"></div>
                </div>
                <div class="recipe-section">
                    <h3 id="readyToCook" style="margin-bottom: 1rem; color: var(--text);">Ready to cook?</h3>
                    <div class="recipe-links" id="recipeLinks">
                        <!-- Recipe links will be populated here -->
                    </div>
                    <div class="action-buttons">
                        <button class="btn-secondary" id="favoriteBtn"> Save to Favorites</button>
                        <button class="btn-secondary" id="shareBtn"> Share Discovery</button>
                        <button class="btn-primary" id="addToLogBtn" style="display: none;"> Add to Today's Log</button>
                    </div>
                </div>
            </div>

            <!-- Warm Message (shown when user has history) -->
            <div class="warm-message" id="warmMessage" style="display: none;">
                <p id="warmMessageText"></p>
            </div>
            
            <!-- Feature Row -->
            <div class="feature-row">
                <div class="feature-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5"></path>
                        <path d="M2 12l10 5 10-5"></path>
                    </svg>
                    <span>Powered by AI</span>
                </div>
                <div class="feature-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <span>Korean Focus</span>
                </div>
                <div class="feature-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    <span>Cultural Stories</span>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="historyTab">
            <div class="history-section">
                <h2 class="section-title" id="recentDiscoveries"> Your Recent Discoveries</h2>
                <div class="history-grid" id="historyGrid">
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p id="historyEmpty">Your exploration history will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Favorites Tab -->
        <div class="tab-content" id="favoritesTab">
            <div class="favorites-section">
                <h2 class="section-title" id="favoriteDishes"> Your Favorite Dishes</h2>
                <div class="favorites-grid" id="favoritesGrid">
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <p id="favoritesEmpty">Save dishes you love to revisit them later</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calorie Log Tab -->
        <div class="tab-content" id="calorieLogTab">
            <div class="calorie-log-section">
                <h2 class="section-title" id="calorieLogTitle"> Today's Calorie Log</h2>
                
                <!-- Daily Totals -->
                <div class="daily-totals" id="dailyTotals">
                    <div class="total-item">
                        <div class="total-value" id="totalCalories">0</div>
                        <div class="total-label">Total Calories</div>
                    </div>
                    <div class="nutrition-breakdown">
                        <div class="breakdown-item">
                            <span class="breakdown-label">Protein:</span>
                            <span class="breakdown-value" id="totalProtein">0g</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Carbs:</span>
                            <span class="breakdown-value" id="totalCarbs">0g</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Fat:</span>
                            <span class="breakdown-value" id="totalFat">0g</span>
                        </div>
                    </div>
                </div>

                <!-- Log Items List -->
                <div class="log-items" id="logItems">
                    <div class="empty-state" id="logEmpty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        <p id="logEmptyText">No items logged today. Add dishes from the Discover page!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settingsTab">
            <div class="settings-section">
                <h2 class="section-title" id="settingsTitle"> Settings</h2>
                
                <!-- Profile Card -->
                <div class="profile-card" id="profileCard" style="display: none;">
                    <div class="profile-card-header">
                        <h3 id="profileCardTitle">Profile</h3>
                    </div>
                    <div class="profile-card-content">
                        <div class="profile-picture-section">
                            <div class="profile-picture-container">
                                <img id="profilePicture" src="" alt="Profile" style="display: none;">
                                <div class="profile-picture-placeholder" id="profilePicturePlaceholder">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </div>
                            </div>
                            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                            <button class="btn-secondary" id="uploadPictureBtn" style="margin-top: 12px;">Upload Picture</button>
                        </div>
                        <div class="profile-form-section">
                            <label for="profileNicknameInput" id="profileNicknameLabel">Nickname</label>
                            <input 
                                type="text" 
                                id="profileNicknameInput" 
                                class="form-input" 
                                placeholder="Enter your nickname">
                            <button class="btn" id="saveProfileBtn" style="width: 100%; margin-top: 16px;">Save Profile</button>
                        </div>
                    </div>
                </div>
                
                <!-- Night Mode Toggle -->
                <div class="settings-item">
                    <div class="settings-label">
                        <h3 id="nightModeLabel">Night Mode</h3>
                        <p id="nightModeDesc">Toggle dark theme for better viewing in low light</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="nightModeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Language Selection -->
                <div class="settings-item">
                    <div class="settings-label">
                        <h3 id="languageLabel">Language</h3>
                        <p id="languageDesc">Choose your preferred language</p>
                    </div>
                    <select class="language-select" id="languageSelect">
                        <option value="en">English</option>
                        <option value="ko"> (Korean)</option>
                        <option value="es">Espaol (Spanish)</option>
                        <option value="fr">Franais (French)</option>
                        <option value="zh"> (Chinese)</option>
                    </select>
                </div>

                <!-- App Version -->
                <div class="settings-item">
                    <div class="settings-label">
                        <h3 id="appVersionLabel">App Version</h3>
                        <p id="appVersionDesc">Current version of BiteSight</p>
                    </div>
                    <div class="version-info" id="appVersion">1.0.13</div>
                </div>
            </div>
        </div>

        <!-- Camera Modal -->
        <div class="camera-modal" id="cameraModal">
            <div class="camera-container">
                <video id="cameraVideo" autoplay playsinline></video>
                <div class="camera-controls">
                    <button class="camera-close-btn" id="closeCameraBtn">Close</button>
                    <button class="capture-btn" id="captureBtn" title="Capture photo"></button>
                    <button class="camera-flip-btn" id="flipCameraBtn">Flip</button>
                </div>
                <div class="camera-error" id="cameraError" style="display: none;">
                    <h3 id="cameraAccessDeniedTitle">Camera Access Denied</h3>
                    <p id="cameraAccessDeniedMsg">Please allow camera access to use this feature.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-navigation">
        <button class="nav-item active" data-tab="discover" id="navDiscover">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <span id="navDiscoverText">Discover</span>
        </button>
        <button class="nav-item" data-tab="history" id="navHistory">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3h18v18H3zM9 9h6v6H9z"></path>
                <path d="M3 9h18M9 3v18"></path>
            </svg>
            <span id="navHistoryText">History</span>
        </button>
        <button class="nav-item" data-tab="favorites" id="navFavorites">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <span id="navFavoritesText">Favorites</span>
        </button>
        <button class="nav-item" data-tab="calorieLog" id="navCalorieLog">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"></path>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span id="navCalorieLogText">Log</span>
        </button>
        <button class="nav-item" data-tab="settings" id="navSettings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
            </svg>
            <span id="navSettingsText">Settings</span>
        </button>
    </nav>

    <script>
        // ============================================
        // CONFIGURATION - Add your API keys here
        // ============================================
        const CONFIG = {
            // Backend API endpoint - API key is now stored securely on the server
            // For mobile devices, use your computer's IP address instead of localhost
            // Find your IP with: ipconfig (Windows) or ifconfig (Mac/Linux)
            BACKEND_URL: 'http://192.168.2.16:3000', // Change this to your computer's IP if different
            
            // Recipe links now point directly to recipe websites
            // No API keys needed - using direct website search URLs

            // Supabase Configuration
            // Get your Supabase credentials from: https://app.supabase.com/
            // Steps to get the credentials:
            // 1. Go to https://app.supabase.com/ and create a project (or use existing)
            // 2. Go to Project Settings > API
            // 3. Copy the "Project URL" (SUPABASE_URL)
            // 4. Copy the "anon public" key (SUPABASE_ANON_KEY)
            // 5. Make sure Email authentication is enabled in Authentication > Providers
            SUPABASE_URL: 'https://qiyprefzhprjzgemvqeu.supabase.co', // e.g., 'https://xxxxx.supabase.co'
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpeXByZWZ6aHByanpnZW12cWV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MTY0NDgsImV4cCI6MjA3NTA5MjQ0OH0.RZAXhSFG3MOfAJkERaoD8Qv91_lWgkbWUBymtKjjFmU' // e.g., 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let currentImage = null;
        let currentDishData = null;
        let supabaseClient = null;
        let currentUser = null;
        let userScanInfo = { remaining: 3, limit: 3, level: 'guest' }; // Default for guest
        
        // Check if user is premium (from user metadata)
        function isPremiumUser() {
            if (!currentUser) return false;
            return currentUser.user_metadata?.premium === true || 
                   currentUser.user_metadata?.is_premium === true ||
                   currentUser.user_metadata?.tier === 'premium';
        }
        
        // Get remaining scans from server
        async function updateScanLimit() {
            try {
                const backendUrl = CONFIG.BACKEND_URL || 'http://localhost:3000';
                const userId = currentUser?.id || null;
                const premium = isPremiumUser();
                
                const response = await fetch(`${backendUrl}/api/scan-limit?userId=${userId || ''}&isPremium=${premium}`);
                if (response.ok) {
                    userScanInfo = await response.json();
                }
            } catch (error) {
                console.error('Error fetching scan limit:', error);
            }
        }
        let cameraStream = null;
        let facingMode = 'environment'; // 'user' for front, 'environment' for back
        
        // Navigation state tracking
        let navigationHistory = [];
        let currentRoute = 'discover'; // 'discover', 'history', 'favorites', 'settings', 'result', 'historyDetail', 'favoriteDetail'
        let isShowingResult = false;

        // ============================================
        // SUPABASE INITIALIZATION
        // ============================================
        function initializeSupabase() {
            // Check if Supabase config is valid
            const supabaseUrl = CONFIG.SUPABASE_URL;
            const supabaseKey = CONFIG.SUPABASE_ANON_KEY;
            
            if (!supabaseUrl || supabaseUrl.includes('YOUR_') || !supabaseKey || supabaseKey.includes('YOUR_')) {
                console.warn('Supabase not configured correctly. Login features will not work.');
                console.warn('Please get your Supabase credentials from: https://app.supabase.com/');
                console.warn('Go to Project Settings > API to get your URL and anon key.');
                return false;
            }

            // Validate URL format
            if (!supabaseUrl.startsWith('https://') || !supabaseUrl.includes('.supabase.co')) {
                console.error('Invalid Supabase URL format. URL should be: https://xxxxx.supabase.co');
                console.error('Current URL:', supabaseUrl);
                alert('Invalid Supabase URL format.\n\nPlease check your SUPABASE_URL in the CONFIG.\n\nIt should be: https://xxxxx.supabase.co');
                return false;
            }

            try {
                // Initialize Supabase client
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                
                console.log('Supabase client initialized');
                
                // Test connection by trying to get session (this will fail if URL is wrong)
                supabaseClient.auth.getSession().then(({ data: { session }, error }) => {
                    if (error) {
                        console.error('Supabase connection error:', error);
                        if (error.message && error.message.includes('Failed to fetch')) {
                            console.error(' Cannot reach Supabase URL. Please verify:');
                            console.error('1. The URL is correct: ' + supabaseUrl);
                            console.error('2. The project exists and is active');
                            console.error('3. There are no network/firewall issues');
                            alert('Cannot connect to Supabase.\n\nPlease verify:\n1. Your Supabase URL is correct\n2. Your project exists and is active\n3. Check your internet connection\n\nCurrent URL: ' + supabaseUrl);
                        }
                        return;
                    }
                    
                    currentUser = session?.user || null;
                    updateAuthUI();
                    if (currentUser) {
                        console.log(' User logged in:', currentUser.email);
                        const loginModal = document.getElementById('loginModal');
                        if (loginModal) loginModal.classList.remove('active');
                    }
                }).catch((error) => {
                    console.error('Supabase connection failed:', error);
                    if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                        console.error(' DNS/Network error. The Supabase URL may be incorrect or the project may not exist.');
                        console.error('Please verify your Supabase URL at: https://app.supabase.com/');
                        console.error('Go to: Project Settings > API > Project URL');
                    }
                });
                
                // Listen for auth state changes
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log('Auth state changed:', event);
                    
                    // Always update currentUser from session
                    currentUser = session?.user || null;
                    
                    // Always update UI when auth state changes
                    updateAuthUI();
                    
                    if (event === 'SIGNED_IN' && currentUser) {
                        console.log(' SIGNED_IN event - User signed in:', currentUser.email);
                        // Close login modal if open
                        const loginModal = document.getElementById('loginModal');
                        if (loginModal) {
                            loginModal.classList.remove('active');
                        }
                        // Double-check session is stored
                        setTimeout(async () => {
                            const { data: { session: verifySession } } = await supabaseClient.auth.getSession();
                            if (verifySession && verifySession.user) {
                                currentUser = verifySession.user;
                                updateAuthUI();
                            }
                        }, 500);
                    } else if (event === 'INITIAL_SESSION' && currentUser) {
                        console.log(' INITIAL_SESSION event - User already logged in:', currentUser.email);
                        // Close login modal if open
                        const loginModal = document.getElementById('loginModal');
                        if (loginModal) {
                            loginModal.classList.remove('active');
                        }
                    } else if (event === 'SIGNED_OUT') {
                        console.log('User signed out');
                        currentUser = null;
                        updateAuthUI();
                    } else if (event === 'TOKEN_REFRESHED') {
                        // Refresh user data
                        setTimeout(async () => {
                            const { data: { session: refreshSession } } = await supabaseClient.auth.getSession();
                            if (refreshSession && refreshSession.user) {
                                currentUser = refreshSession.user;
                                updateAuthUI();
                            }
                        }, 100);
                    } else if (event === 'USER_UPDATED') {
                        setTimeout(async () => {
                            const { data: { session: updatedSession } } = await supabaseClient.auth.getSession();
                            if (updatedSession && updatedSession.user) {
                                currentUser = updatedSession.user;
                                updateAuthUI();
                            }
                        }, 100);
                    } else if (!session && event === 'INITIAL_SESSION') {
                    }
                    
                });
                
                console.log(' Supabase client initialized!');
                
                // Check for existing session on app start
                supabaseClient.auth.getSession().then(({ data }) => {
                    if (data.session) {
                        console.log(' Existing session found');
                        currentUser = data.session.user;
                        updateAuthUI();
                    } else {
                        console.log('No existing session');
                        updateUIToLoggedOutState();
                    }
                });
                
                return true;
            } catch (error) {
                console.error('Supabase initialization error:', error);
                console.error('Error details:', error.message);
                alert('Supabase configuration error. Please check your config values.\n\nError: ' + error.message);
                return false;
            }
        }

        // ============================================
        // EMAIL/PASSWORD AUTHENTICATION FUNCTIONS
        // ============================================
        
        // Sign up with email and password (instant login, no email confirmation)
        async function signUpEmail(email, password, nickname) {
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            if (!nickname || nickname.trim() === '') {
                alert('Please enter a nickname');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            if (!supabaseClient) {
                alert('Supabase not initialized. Please check your configuration.');
                return;
            }

            try {
                const emailSignupBtn = document.getElementById('emailSignupBtn');
                if (emailSignupBtn) {
                    emailSignupBtn.disabled = true;
                    emailSignupBtn.textContent = 'Creating account...';
                }

                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            nickname: nickname.trim(),
                            full_name: nickname.trim()
                        }
                    }
                    // Removed options.emailRedirectTo - Supabase will create session if email confirmation is disabled
                });

                if (error) {
                    console.error("Sign-up error:", error.message);
                    alert(error.message);
                    return;
                }

                // Check if session was created (email confirmation disabled) or if we need to log in
                if (data.user) {
                    if (data.session) {
                        // Session exists - user is already logged in (email confirmation disabled)
                        console.log("User created and logged in automatically.");
                        currentUser = data.user;
                        updateAuthUI();
                        const loginModal = document.getElementById('loginModal');
                        if (loginModal) loginModal.classList.remove('active');
                        clearErrors();
                        alert("Account created successfully! You are now logged in.");
                    } else {
                        // No session - this means email confirmation is enabled in Supabase
                        // Wait a brief moment and try to get session (sometimes there's a delay)
                        console.log("No session after signup, waiting briefly and checking session...");
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                        if (session && session.user) {
                            // Session found after delay
                            console.log("Session found after delay!");
                            currentUser = session.user;
                            updateAuthUI();
                            const loginModal = document.getElementById('loginModal');
                            if (loginModal) loginModal.classList.remove('active');
                            clearErrors();
                            alert("Account created successfully! You are now logged in.");
                        } else {
                            // Still no session - email confirmation is required
                            console.warn("Email confirmation is enabled in Supabase. User must confirm email before login.");
                            alert("Account created! However, email confirmation is enabled in your Supabase settings. Please disable 'Enable email confirmations' in Supabase Dashboard  Authentication  Settings to allow instant login.");
                            
                            // Try login anyway in case it works
                            const loginResult = await loginEmail(email, password);
                            if (!loginResult) {
                                // Login failed - show helpful message
                                const signupError = document.getElementById('signupError');
                                if (signupError) {
                                    signupError.textContent = 'Please disable email confirmation in Supabase Dashboard to enable instant login.';
                                    signupError.style.color = 'var(--status-warning)';
                                }
                            }
                        }
                    }
                }
            } catch (err) {
                console.error("Sign-up error:", err);
                alert(err.message || "An error occurred during sign-up");
            } finally {
                const emailSignupBtn = document.getElementById('emailSignupBtn');
                if (emailSignupBtn) {
                    emailSignupBtn.disabled = false;
                    emailSignupBtn.textContent = 'Sign Up';
                }
            }
        }

        // Login with email and password
        async function loginEmail(email, password) {
            if (!email) {
                email = document.getElementById('loginEmail')?.value.trim();
            }
            if (!password) {
                password = document.getElementById('loginPassword')?.value;
            }

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            if (!supabaseClient) {
                alert('Supabase not initialized. Please check your configuration.');
                return;
            }

            try {
                const emailLoginBtn = document.getElementById('emailLoginBtn');
                if (emailLoginBtn) {
                    emailLoginBtn.disabled = true;
                    emailLoginBtn.textContent = 'Signing in...';
                }

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password,
                });

                if (error) {
                    console.error("Login error:", error.message);
                    alert("Incorrect email or password.");
                    const loginError = document.getElementById('loginError');
                    if (loginError) {
                        loginError.textContent = getErrorMessage(error);
                    }
                    return false; // Return failure
                }

                if (data.session && data.user) {
                    console.log("Logged in successfully:", data.user);
                    currentUser = data.user;
                    updateAuthUI();
                    const loginModal = document.getElementById('loginModal');
                    if (loginModal) loginModal.classList.remove('active');
                    clearErrors();
                    return true; // Return success
                }
                return false; // No session/user
            } catch (err) {
                console.error("Login error:", err);
                alert(err.message || "An error occurred during login");
                return false; // Return failure
            } finally {
                const emailLoginBtn = document.getElementById('emailLoginBtn');
                if (emailLoginBtn) {
                    emailLoginBtn.disabled = false;
                    emailLoginBtn.textContent = 'Sign In';
                }
            }
        }

        // Logout
        async function logout() {
            if (!supabaseClient) {
                console.error('Supabase not initialized.');
                return;
            }

            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) {
                    console.error('Logout error:', error);
                    alert('Error logging out: ' + error.message);
                    return;
                }
                
                // Clear local history and favorites
                localStorage.removeItem('biteSightHistory');
                localStorage.removeItem('biteSightFavorites');
                localStorage.removeItem('biteSightUsername');
                
                // Clear current state
                currentUser = null;
                currentDishData = null;
                currentImage = null;
                isShowingResult = false;
                
                // Reload history and favorites displays
                loadHistory();
                loadFavorites();
                
                // Reset to blank slate
                resetToBlankSlate();
                
                updateUIToLoggedOutState();
                console.log(' Logged out successfully');
            } catch (err) {
                console.error('Logout error:', err);
                alert('Error logging out: ' + err.message);
            }
        }

        // Reset password
        async function resetPassword(email) {
            if (!email) {
                email = document.getElementById('loginEmail')?.value.trim();
            }

            if (!email) {
                alert('Please enter your email address');
                return;
            }

            if (!supabaseClient) {
                alert('Supabase not initialized. Please check your configuration.');
                return;
            }

            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
                if (error) {
                    console.error("Password reset error:", error.message);
                    alert(error.message);
                    return;
                }

                alert("Password reset link sent to your email.");
            } catch (err) {
                console.error("Password reset error:", err);
                alert(err.message || "An error occurred while sending password reset email");
            }
        }

        // Update UI to logged out state
        function updateUIToLoggedOutState() {
            currentUser = null;
            userScanInfo = { remaining: 3, limit: 3, level: 'guest' };
            updateScanLimitDisplay();
            updateAuthUI();
        }
        
        // Update scan limit display in UI
        function updateScanLimitDisplay() {
            const scanLimitDisplay = document.getElementById('scanLimitDisplay');
            const scanCounterHeader = document.getElementById('scanCounterHeader');
            const scanCounterText = document.getElementById('scanCounterText');
            
            const level = userScanInfo.level || 'guest';
            const remaining = userScanInfo.remaining || 0;
            const limit = userScanInfo.limit || 3;
            
            // Update main scan limit display (below upload area)
            if (scanLimitDisplay) {
                let levelText = '';
                if (level === 'guest') {
                    levelText = 'Guest';
                } else if (level === 'free') {
                    levelText = 'Free';
                } else if (level === 'premium') {
                    levelText = 'Premium';
                }
                
                scanLimitDisplay.textContent = `${remaining}/${limit} scans (${levelText})`;
                scanLimitDisplay.className = `scan-limit ${level}`;
                
                // Show warning if low on scans
                if (remaining === 0) {
                    scanLimitDisplay.classList.add('limit-exceeded');
                } else if (remaining <= 2) {
                    scanLimitDisplay.classList.add('limit-low');
                }
            }
            
            // Update header counter
            if (scanCounterHeader && scanCounterText) {
                if (remaining === 0) {
                    scanCounterText.textContent = 'No scans left';
                    scanCounterHeader.style.background = '#FFE6E6';
                    scanCounterHeader.style.color = 'var(--status-error)';
                } else if (remaining === 1) {
                    scanCounterText.textContent = '1 scan left';
                    scanCounterHeader.style.background = '#FFF4E6';
                    scanCounterHeader.style.color = '#E67E22';
                } else {
                    scanCounterText.textContent = `${remaining} scans left`;
                    if (level === 'premium') {
                        scanCounterHeader.style.background = '#FFF9E6';
                        scanCounterHeader.style.color = '#FFD700';
                    } else {
                        scanCounterHeader.style.background = 'var(--secondary)';
                        scanCounterHeader.style.color = 'var(--text-primary)';
                    }
                }
                scanCounterHeader.style.display = 'flex';
            }
        }

        // ============================================
        // AUTHENTICATION UI
        // ============================================
        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const premiumBtn = document.getElementById('premiumBtn');
            const userProfile = document.getElementById('userProfile');
            const greetingText = document.getElementById('greetingText');
            const logoutBtn = document.getElementById('logoutBtn');
            const loginModal = document.getElementById('loginModal');

            if (currentUser) {
                // User is logged in
                if (loginBtn) loginBtn.style.display = 'none';
                if (premiumBtn) {
                    if (isPremiumUser()) {
                        premiumBtn.textContent = ' Premium Active';
                        premiumBtn.style.background = '#4CAF50';
                        premiumBtn.style.color = '#fff';
                    } else {
                        premiumBtn.textContent = ' Premium';
                        premiumBtn.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                        premiumBtn.style.color = '#000';
                    }
                    premiumBtn.style.display = 'block';
                }
                if (userProfile) userProfile.style.display = 'flex';
                
                const nickname = currentUser.user_metadata?.nickname || currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User';
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                
                if (greetingText) {
                    greetingText.textContent = `${t.hello || 'Hello'}, ${nickname}`;
                }
                if (logoutBtn) logoutBtn.style.display = 'block';
                if (loginModal) loginModal.classList.remove('active');
                
                // Load user data from DB
                loadUserHistoryAndFavorites();
                
                // Update scan limits (async, don't await)
                updateScanLimit().then(() => {
                    updateScanLimitDisplay();
                });
                
                // Show profile card
                initializeProfileCard();
            } else {
                // User is not logged in
                if (loginBtn) loginBtn.style.display = 'block';
                if (premiumBtn) {
                    premiumBtn.style.display = 'block';
                    premiumBtn.textContent = ' Premium';
                    premiumBtn.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                    premiumBtn.style.color = '#000';
                }
                if (userProfile) userProfile.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'none';
                
                // Reset to guest limits
                userScanInfo = { remaining: 3, limit: 3, level: 'guest' };
                updateScanLimit().then(() => {
                    updateScanLimitDisplay();
                });
                
                // Remove premium features
                removePremiumFeatures();
            }
            
            // Update scan limit display
            updateScanLimitDisplay();
        }
        
        // Apply premium features (ad-free, etc.)
        function applyPremiumFeatures() {
            if (isPremiumUser()) {
                // Premium users get no ads - add class for styling
                document.body.classList.add('premium-user');
            } else {
                document.body.classList.remove('premium-user');
            }
        }
        
        function removePremiumFeatures() {
            document.body.classList.remove('premium-user');
        }
        
        // Handle premium subscription
        function handlePremiumSubscribe() {
            if (!currentUser) {
                // User not logged in - prompt to login first
                const premiumModal = document.getElementById('premiumModal');
                if (premiumModal) premiumModal.classList.remove('active');
                
                const loginModal = document.getElementById('loginModal');
                if (loginModal) {
                    loginModal.classList.add('active');
                    showLoginForm();
                }
                alert('Please sign in first to subscribe to Premium!');
                return;
            }
            
            // TODO: Integrate with payment provider (Stripe, PayPal, etc.)
            // For now, show a message
            alert('Premium subscription coming soon! For now, you can manually upgrade users in Supabase by setting user_metadata.premium = true');
            
            // In production, this would:
            // 1. Redirect to payment page (Stripe Checkout, PayPal, etc.)
            // 2. After successful payment, update user metadata in Supabase
            // 3. Refresh user session
            // 4. Show success message
        }
        
        // Check premium status
        function checkPremiumStatus() {
            if (!currentUser) {
                alert('Please sign in to check your Premium status.');
                return;
            }
            
            if (isPremiumUser()) {
                alert(' You are a Premium member! Enjoy all Premium features.');
            } else {
                alert('You are currently on the free plan. Upgrade to Premium to unlock all features!');
                const premiumModal = document.getElementById('premiumModal');
                if (premiumModal) premiumModal.classList.add('active');
            }
        }

        // ============================================
        // MANUAL SESSION REFRESH (for debugging)
        // ============================================
        async function refreshSession() {
            console.log('=== Manual session refresh ===');
            if (!supabaseClient) {
                console.error('Supabase client not initialized');
                return false;
            }
            
            try {
                // Try to get current session
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                if (error) {
                    console.error('Error getting session:', error);
                    return false;
                }
                
                if (session && session.user) {
                    console.log(' Session found:', session.user.email);
                    currentUser = session.user;
                    updateAuthUI();
                    return true;
                } else {
                    console.log('No session found');
                    // Try refreshing
                    const { data: { session: refreshedSession }, error: refreshError } = await supabaseClient.auth.refreshSession();
                    if (refreshError) {
                        console.error('Error refreshing session:', refreshError);
                        return false;
                    }
                    if (refreshedSession && refreshedSession.user) {
                        console.log(' Session found after refresh:', refreshedSession.user.email);
                        currentUser = refreshedSession.user;
                        updateAuthUI();
                        return true;
                    }
                    return false;
                }
            } catch (error) {
                console.error('Error in refreshSession:', error);
                return false;
            }
        }
        
        // Make refreshSession available globally for debugging
        window.refreshSession = refreshSession;

        // ============================================
        // BOTTOM NAVIGATION
        // ============================================
        function switchTab(tabName, skipHistory = false) {
            const navItems = document.querySelectorAll('.nav-item');
            const tabContents = document.querySelectorAll('.tab-content');

            // Track navigation history
            if (!skipHistory && currentRoute !== tabName) {
                navigationHistory.push(currentRoute);
                // Keep only last 10 routes
                if (navigationHistory.length > 10) {
                    navigationHistory.shift();
                }
            }

            // Remove active class from all nav items and contents
            navItems.forEach(nav => nav.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to target nav item and corresponding content
            const targetNavItem = document.querySelector(`[data-tab="${tabName}"]`);
            const targetTabContent = document.getElementById(tabName + 'Tab');
            
            if (targetNavItem) targetNavItem.classList.add('active');
            if (targetTabContent) targetTabContent.classList.add('active');
            
            currentRoute = tabName;
            
            // Handle result display based on tab
            const resultSection = document.getElementById('resultSection');
            
            if (tabName === 'calorieLog') {
                // Load calorie log when switching to this tab
                loadCalorieLog();
            } else if (tabName === 'discover') {
                // When switching back to discover tab, show result if it exists
                if (isShowingResult && currentDishData && resultSection) {
                    // Just show the result section, don't re-render (to avoid duplicate history states)
                    resultSection.style.display = 'block';
                    // Scroll to result if needed
                    setTimeout(() => {
                        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else if (resultSection) {
                    // Hide result if no result data
                    resultSection.style.display = 'none';
                }
            } else {
                // Hide result section when switching to other tabs (but keep the state)
                if (resultSection && isShowingResult) {
                    resultSection.style.display = 'none';
                    // Don't set isShowingResult = false, keep it true so we can restore later
                }
            }
            
            // Update profile card visibility when switching to settings
            if (tabName === 'settings') {
                initializeProfileCard();
            }
        }
        
        // ============================================
        // BACK NAVIGATION HANDLER
        // ============================================
        function handleBackNavigation() {
            // If showing result on discover tab, reset to blank slate
            if (currentRoute === 'discover' && isShowingResult) {
                resetToBlankSlate();
                // Replace current state to prevent creating new history entry
                window.history.replaceState({ route: 'discover', isBlankSlate: true }, '', window.location.href);
                return true; // Handled
            }
            
            // If we have navigation history, go back
            if (navigationHistory.length > 0) {
                const previousRoute = navigationHistory.pop();
                switchTab(previousRoute, true); // Skip adding to history
                // Replace current state
                window.history.replaceState({ route: previousRoute }, '', window.location.href);
                return true; // Handled
            }
            
            // Default behavior - reset to blank slate on discover tab
            if (currentRoute === 'discover') {
                resetToBlankSlate();
                window.history.replaceState({ route: 'discover', isBlankSlate: true }, '', window.location.href);
                return true;
            }
            
            return false;
        }
        
        // Initialize back button handler
        function initializeBackNavigation() {
            // Push initial state if none exists
            if (window.history.state === null) {
                window.history.replaceState({ route: 'discover', isBlankSlate: true }, '', window.location.href);
            }
            
            // Handle browser back button
            window.addEventListener('popstate', (e) => {
                const state = e.state;
                
                // Handle the navigation based on state
                if (state && state.isBlankSlate) {
                    // Coming back to blank slate - ensure it's reset
                    resetToBlankSlate();
                } else if (state && state.showingResult) {
                    // This shouldn't happen when going back, but handle it
                    // If we're going back from a result, reset to blank slate
                    resetToBlankSlate();
                    // Replace state to blank slate
                    window.history.replaceState({ route: 'discover', isBlankSlate: true }, '', window.location.href);
                } else if (state && state.route) {
                    // Navigate to the route in state
                    switchTab(state.route, true);
                } else {
                    // Handle our custom navigation logic
                    const handled = handleBackNavigation();
                    if (!handled) {
                        // If not handled, ensure we're on discover tab
                        switchTab('discover', true);
                        resetToBlankSlate();
                    }
                }
            });
            
            // Handle Android hardware back button via Capacitor if available
            if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.App) {
                window.Capacitor.Plugins.App.addListener('backButton', ({ canGoBack }) => {
                    // Always handle our custom logic first
                    if (currentRoute === 'discover' && isShowingResult) {
                        // Reset to blank slate
                        resetToBlankSlate();
                        window.history.replaceState({ route: 'discover', isBlankSlate: true }, '', window.location.href);
                    } else if (navigationHistory.length > 0) {
                        // Go back in navigation history
                        const previousRoute = navigationHistory.pop();
                        switchTab(previousRoute, true);
                        window.history.replaceState({ route: previousRoute }, '', window.location.href);
                    } else if (!canGoBack) {
                        // Can't go back, exit app
                        window.Capacitor.Plugins.App.exitApp();
                    } else {
                        // Let browser handle it
                        window.history.back();
                    }
                });
            }
        }
        
        // Reset to blank slate (clear scan result)
        function resetToBlankSlate() {
            currentDishData = null;
            currentImage = null;
            isShowingResult = false;
            
            // Clear navigation history when resetting
            navigationHistory = [];
            
            // Hide result section
            const resultSection = document.getElementById('resultSection');
            if (resultSection) {
                resultSection.style.display = 'none';
                // Clear result content to prevent refresh showing old data
                const dishImage = document.getElementById('dishImage');
                const dishName = document.getElementById('dishName');
                const dishDescription = document.getElementById('dishDescription');
                const alternativesSection = document.getElementById('alternativesSection');
                
                if (dishImage) dishImage.src = '';
                if (dishName) dishName.textContent = '';
                if (dishDescription) dishDescription.textContent = '';
                if (alternativesSection) {
                    alternativesSection.style.display = 'none';
                    alternativesSection.innerHTML = '';
                }
            }
            
            // Reset upload area
            const previewContainer = document.getElementById('previewContainer');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const fileInput = document.getElementById('fileInput');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            if (previewContainer) previewContainer.style.display = 'none';
            if (uploadPlaceholder) uploadPlaceholder.style.display = 'flex';
            if (fileInput) fileInput.value = '';
            if (analyzeBtn) analyzeBtn.disabled = true;
            
            // Hide loading
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'none';
            
            // Reset favorite button state
            updateFavoriteButtonState();
        }

        function initializeTabs() {
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetTab = item.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });
        }

        // ============================================
        // TRANSLATIONS
        // ============================================
        const translations = {
            en: {
                // Header
                login: "Login",
                logout: "Logout",
                hello: "Hello",
                headerSubtitle: "Every meal has a story. Let's uncover the one in your photo.",
                headerSubtitleSmall: "Special expertise in Korean cuisine ",
                
                // Tabs
                discover: "Discover",
                history: "History",
                favorites: "Favorites",
                settings: "Settings",
                
                // Upload Section
                uploadText: "Upload a photo of food",
                uploadHint: "Drag and drop or click to browse  Korean dishes emphasized",
                discoverDish: "Discover Your Dish",
                useCamera: "Use Camera",
                
                // Loading
                analyzing: "Analyzing your photo... This might take a moment.",
                
                // Results
                readyToCook: "Ready to cook?",
                viewRecipe: "View Recipe & Cultural Story ",
                saveToFavorites: " Save to Favorites",
                saved: " Saved!",
                shareDiscovery: " Share Discovery",
                addToLog: " Add to Today's Log",
                addToLogError: "Failed to add to log. Please try again.",
                calorieLogTitle: " Today's Calorie Log",
                totalCalories: "Total Calories",
                logEmptyText: "No items logged today. Add dishes from the Discover page!",
                couldAlsoBe: "Could also be:",
                
                // History
                recentDiscoveries: " Your Recent Discoveries",
                historyEmpty: "No history yet  discover dishes to see them here",
                
                // Favorites
                favoriteDishes: " Your Favorite Dishes",
                favoritesEmpty: "No favorites yet  discover dishes to add them here",
                
                // Settings
                settingsTitle: " Settings",
                nightMode: "Night Mode",
                nightModeDesc: "Toggle dark theme for better viewing in low light",
                language: "Language",
                languageDesc: "Choose your preferred language",
                appVersion: "App Version",
                appVersionDesc: "Current version of Ok Snap",
                
                // Auth
                signUp: "Sign Up",
                signupTitle: "Sign Up",
                dontHaveAccount: "Don't have an account?",
                alreadyHaveAccount: "Already have an account?",
                or: "or",
                email: "Email",
                password: "Password",
                name: "Name",
                yourName: "Your name",
                
                // Camera
                close: "Close",
                flip: "Flip",
                cameraAccessDenied: "Camera Access Denied",
                cameraAccessDeniedMsg: "Please allow camera access to use this feature.",
                
                // Time
                justNow: "Just now",
                minutesAgo: "m ago",
                hoursAgo: "h ago",
                daysAgo: "d ago",
                
                // Errors and messages
                confident: "confident",
                couldNotRecognize: "I couldn't recognize any food in this image. Try another angle or make sure the food is clearly visible.",
                analysisError: "Unable to analyze the image. Please check your internet connection and try again.",
                apiError: "Unable to connect to the analysis service. Please check your internet connection and try again.",
                networkError: "Network error. Please check your internet connection and try again.",
                lowConfidenceMessage: "I'm not completely sure, but this could be <strong>${dishName}</strong>${cuisine ? `  a ${cuisine} dish` : ''}. Which one looks closer to yours?",
                alternativeSelected: "You selected: ${alt}. This feature can be enhanced to search for this dish.",
                pleaseSelectImage: "Please select an image first.",
                apiKeyError: "Please configure your OpenAI API key in the CONFIG section of the code."
            },
            ko: {
                login: "",
                logout: "",
                hello: "",
                headerSubtitle: "   .    .",
                headerSubtitleSmall: "   ",
                discover: "",
                history: "",
                favorites: "",
                settings: "",
                uploadText: "  ",
                uploadHint: "         ",
                discoverDish: " ",
                useCamera: " ",
                analyzing: "  ...  .",
                readyToCook: "  ?",
                viewRecipe: "     ",
                saveToFavorites: "  ",
                saved: " !",
                shareDiscovery: "  ",
                addToLog: "   ",
                addToLogError: "  .  .",
                calorieLogTitle: "   ",
                totalCalories: " ",
                logEmptyText: "   .    !",
                couldAlsoBe: "  :",
                recentDiscoveries: "  ",
                historyEmpty: "       ",
                favoriteDishes: "  ",
                favoritesEmpty: "      ",
                settingsTitle: " ",
                nightMode: " ",
                nightModeDesc: "        ",
                language: "",
                languageDesc: "  ",
                appVersion: " ",
                appVersionDesc: "Ok Snap  ",
                signUp: "",
                signupTitle: "",
                dontHaveAccount: " ?",
                alreadyHaveAccount: "  ?",
                continueWithGoogle: "Google ",
                or: "",
                email: "",
                password: "",
                name: "",
                yourName: " ",
                close: "",
                flip: "",
                cameraAccessDenied: "  ",
                cameraAccessDeniedMsg: "     .",
                justNow: " ",
                minutesAgo: " ",
                hoursAgo: " ",
                daysAgo: " ",
                
                // Errors and messages
                confident: "",
                couldNotRecognize: "     .       .",
                analysisError: "   .     .",
                apiError: "    .     .",
                networkError: "  .     .",
                lowConfidenceMessage: "   ,  <strong>${dishName}</strong>${cuisine ? `  ${cuisine} ` : ''}  .     ?",
                alternativeSelected: "${alt}() .          .",
                pleaseSelectImage: "  .",
                apiKeyError: "CONFIG  OpenAI API  ."
            },
            es: {
                login: "Iniciar sesin",
                logout: "Cerrar sesin",
                hello: "Hola",
                headerSubtitle: "Cada comida tiene una historia. Descubramos la de tu foto.",
                headerSubtitleSmall: "Especialidad en cocina coreana ",
                discover: "Descubrir",
                history: "Historial",
                favorites: "Favoritos",
                settings: "Configuracin",
                uploadText: "Sube una foto de comida",
                uploadHint: "Arrastra y suelta o haz clic para navegar  Platos coreanos destacados",
                discoverDish: "Descubre Tu Plato",
                useCamera: "Usar Cmara",
                analyzing: "Analizando tu foto... Esto puede tomar un momento.",
                readyToCook: "Listo para cocinar?",
                viewRecipe: "Ver Receta e Historia Cultural ",
                saveToFavorites: " Guardar en Favoritos",
                saved: " Guardado!",
                shareDiscovery: " Compartir Descubrimiento",
                addToLog: " Agregar al Registro de Hoy",
                addToLogError: "Error al agregar al registro. Por favor, intntalo de nuevo.",
                calorieLogTitle: " Registro de Caloras de Hoy",
                totalCalories: "Caloras Totales",
                logEmptyText: "No hay elementos registrados hoy. Agrega platos desde la pgina Descubrir!",
                couldAlsoBe: "Tambin podra ser:",
                recentDiscoveries: " Tus Descubrimientos Recientes",
                historyEmpty: "An no hay historial  descubre platos para verlos aqu",
                favoriteDishes: " Tus Platos Favoritos",
                favoritesEmpty: "An no hay favoritos  descubre platos para agregarlos aqu",
                settingsTitle: " Configuracin",
                nightMode: "Modo Nocturno",
                nightModeDesc: "Activa el tema oscuro para una mejor visualizacin con poca luz",
                language: "Idioma",
                languageDesc: "Elige tu idioma preferido",
                appVersion: "Versin de la App",
                appVersionDesc: "Versin actual de Ok Snap",
                signUp: "Registrarse",
                signupTitle: "Registrarse",
                dontHaveAccount: "No tienes una cuenta?",
                alreadyHaveAccount: "Ya tienes una cuenta?",
                continueWithGoogle: "Continuar con Google",
                or: "o",
                email: "Correo electrnico",
                password: "Contrasea",
                name: "Nombre",
                yourName: "Tu nombre",
                close: "Cerrar",
                flip: "Voltear",
                cameraAccessDenied: "Acceso a la Cmara Denegado",
                cameraAccessDeniedMsg: "Por favor, permite el acceso a la cmara para usar esta funcin.",
                justNow: "Ahora mismo",
                minutesAgo: "hace min",
                hoursAgo: "hace h",
                daysAgo: "hace d",
                
                // Errors and messages
                confident: "confiado",
                couldNotRecognize: "No pude reconocer ninguna comida en esta imagen. Prueba con otro ngulo o asegrate de que la comida sea claramente visible.",
                analysisError: "No se pudo analizar la imagen. Por favor, verifica tu conexin a internet e intenta de nuevo.",
                apiError: "No se pudo conectar al servicio de anlisis. Por favor, verifica tu conexin a internet e intenta de nuevo.",
                networkError: "Error de red. Por favor, verifica tu conexin a internet e intenta de nuevo.",
                lowConfidenceMessage: "No estoy completamente seguro, pero esto podra ser <strong>${dishName}</strong>${cuisine ? `  un plato ${cuisine}` : ''}. Cul se parece ms al tuyo?",
                alternativeSelected: "Seleccionaste: ${alt}. Esta funcin se puede mejorar para buscar este plato.",
                pleaseSelectImage: "Por favor, selecciona una imagen primero.",
                apiKeyError: "Por favor, configura tu clave API de OpenAI en la seccin CONFIG del cdigo."
            },
            fr: {
                login: "Connexion",
                logout: "Dconnexion",
                hello: "Bonjour",
                headerSubtitle: "Chaque plat a une histoire. Dcouvrons celle de votre photo.",
                headerSubtitleSmall: "Expertise spciale en cuisine corenne ",
                discover: "Dcouvrir",
                history: "Historique",
                favorites: "Favoris",
                settings: "Paramtres",
                uploadText: "Tlchargez une photo de nourriture",
                uploadHint: "Glissez-dposez ou cliquez pour parcourir  Plats corens mis en avant",
                discoverDish: "Dcouvrir Votre Plat",
                useCamera: "Utiliser l'Appareil Photo",
                analyzing: "Analyse de votre photo... Cela peut prendre un moment.",
                readyToCook: "Prt  cuisiner?",
                viewRecipe: "Voir la Recette et l'Histoire Culturelle ",
                saveToFavorites: " Enregistrer dans les Favoris",
                saved: " Enregistr!",
                shareDiscovery: " Partager la Dcouverte",
                addToLog: " Ajouter au Journal d'Aujourd'hui",
                addToLogError: "chec de l'ajout au journal. Veuillez ressayer.",
                calorieLogTitle: " Journal des Calories d'Aujourd'hui",
                totalCalories: "Calories Totales",
                logEmptyText: "Aucun lment enregistr aujourd'hui. Ajoutez des plats depuis la page Dcouvrir !",
                couldAlsoBe: "Pourrait aussi tre:",
                recentDiscoveries: " Vos Dcouvertes Rcentes",
                historyEmpty: "Aucun historique pour le moment  dcouvrez des plats pour les voir ici",
                favoriteDishes: " Vos Plats Favoris",
                favoritesEmpty: "Aucun favori pour le moment  dcouvrez des plats pour les ajouter ici",
                settingsTitle: " Paramtres",
                nightMode: "Mode Nuit",
                nightModeDesc: "Activez le thme sombre pour une meilleure visualisation en basse lumire",
                language: "Langue",
                languageDesc: "Choisissez votre langue prfre",
                appVersion: "Version de l'App",
                appVersionDesc: "Version actuelle de Ok Snap",
                signUp: "S'inscrire",
                signupTitle: "S'inscrire",
                dontHaveAccount: "Vous n'avez pas de compte?",
                alreadyHaveAccount: "Vous avez dj un compte?",
                continueWithGoogle: "Continuer avec Google",
                or: "ou",
                email: "E-mail",
                password: "Mot de passe",
                name: "Nom",
                yourName: "Votre nom",
                close: "Fermer",
                flip: "Retourner",
                cameraAccessDenied: "Accs  la Camra Refus",
                cameraAccessDeniedMsg: "Veuillez autoriser l'accs  la camra pour utiliser cette fonctionnalit.",
                justNow: " l'instant",
                minutesAgo: "il y a min",
                hoursAgo: "il y a h",
                daysAgo: "il y a j",
                
                // Errors and messages
                confident: "confiant",
                couldNotRecognize: "Je n'ai pas pu reconnatre de nourriture dans cette image. Essayez sous un autre angle ou assurez-vous que la nourriture soit clairement visible.",
                analysisError: "Impossible d'analyser l'image. Veuillez vrifier votre connexion Internet et ressayer.",
                apiError: "Impossible de se connecter au service d'analyse. Veuillez vrifier votre connexion Internet et ressayer.",
                networkError: "Erreur rseau. Veuillez vrifier votre connexion Internet et ressayer.",
                lowConfidenceMessage: "Je ne suis pas compltement sr, mais cela pourrait tre <strong>${dishName}</strong>${cuisine ? `  un plat ${cuisine}` : ''}. Lequel ressemble le plus au vtre ?",
                alternativeSelected: "Vous avez slectionn : ${alt}. Cette fonctionnalit peut tre amliore pour rechercher ce plat.",
                pleaseSelectImage: "Veuillez d'abord slectionner une image.",
                apiKeyError: "Veuillez configurer votre cl API OpenAI dans la section CONFIG du code."
            },
            zh: {
                login: "",
                logout: "",
                hello: "",
                headerSubtitle: "",
                headerSubtitleSmall: " ",
                discover: "",
                history: "",
                favorites: "",
                settings: "",
                uploadText: "",
                uploadHint: "  ",
                discoverDish: "",
                useCamera: "",
                analyzing: "...",
                readyToCook: "",
                viewRecipe: " ",
                saveToFavorites: " ",
                saved: " ",
                shareDiscovery: " ",
                addToLog: " ",
                addToLogError: "",
                calorieLogTitle: " ",
                totalCalories: "",
                logEmptyText: "",
                couldAlsoBe: "",
                recentDiscoveries: " ",
                historyEmpty: "  ",
                favoriteDishes: " ",
                favoritesEmpty: "  ",
                settingsTitle: " ",
                nightMode: "",
                nightModeDesc: "",
                language: "",
                languageDesc: "",
                appVersion: "",
                appVersionDesc: "Ok Snap",
                signUp: "",
                signupTitle: "",
                dontHaveAccount: "",
                alreadyHaveAccount: "",
                continueWithGoogle: "Google",
                or: "",
                email: "",
                password: "",
                name: "",
                yourName: "",
                close: "",
                flip: "",
                cameraAccessDenied: "",
                cameraAccessDeniedMsg: "",
                justNow: "",
                minutesAgo: "",
                hoursAgo: "",
                daysAgo: "",
                
                // Errors and messages
                confident: "",
                couldNotRecognize: "",
                analysisError: "",
                apiError: "",
                networkError: "",
                lowConfidenceMessage: " <strong>${dishName}</strong>${cuisine ? `  ${cuisine}` : ''}",
                alternativeSelected: "${alt}",
                pleaseSelectImage: "",
                apiKeyError: "CONFIGOpenAI API"
            }
        };

        // ============================================
        // SETTINGS MANAGEMENT
        // ============================================
        function initializeSettings() {
            // Load saved settings
            let settings = JSON.parse(localStorage.getItem('biteSightSettings') || '{}');
            
            // Initialize night mode
            const nightModeToggle = document.getElementById('nightModeToggle');
            const isNightMode = settings.nightMode || false;
            nightModeToggle.checked = isNightMode;
            applyNightMode(isNightMode);

            nightModeToggle.addEventListener('change', (e) => {
                const isDark = e.target.checked;
                applyNightMode(isDark);
                settings.nightMode = isDark;
                saveSettings(settings);
            });

            // Initialize language
            const languageSelect = document.getElementById('languageSelect');
            const savedLanguage = settings.language || 'en';
            
            if (languageSelect) languageSelect.value = savedLanguage;
            
            // Apply translations on load
            applyTranslations(savedLanguage);

            const handleLanguageChange = (newLanguage) => {
                settings.language = newLanguage;
                saveSettings(settings);
                applyTranslations(newLanguage);
                if (languageSelect) languageSelect.value = newLanguage;
                // Reload history and favorites to update time formatting
                loadHistory();
                loadFavorites();
            };

            if (languageSelect) {
                languageSelect.addEventListener('change', (e) => {
                    handleLanguageChange(e.target.value);
                });
            }


            // Set app version
            document.getElementById('appVersion').textContent = '1.0.13';
        }

        function applyTranslations(lang) {
            const t = translations[lang] || translations.en;
            
            // Update header
            const headerSubtitle = document.getElementById('headerSubtitle');
            if (headerSubtitle) {
                headerSubtitle.innerHTML = t.headerSubtitle + ' <br><small id="headerSubtitleSmall" style="opacity: 0.9; font-size: 0.9em;">' + t.headerSubtitleSmall + '</small>';
            }
            
            // Update navigation items
            const navIds = ['navDiscoverText', 'navHistoryText', 'navFavoritesText', 'navSettingsText'];
            const navKeys = ['discover', 'history', 'favorites', 'settings'];
            navIds.forEach((id, index) => {
                const element = document.getElementById(id);
                if (element) element.textContent = t[navKeys[index]];
            });
            
            
            // Update login/logout buttons
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            if (loginBtn) loginBtn.textContent = t.login;
            if (logoutBtn) logoutBtn.textContent = t.logout;
            
            // Update upload section
            const uploadText = document.getElementById('uploadText');
            const uploadHint = document.getElementById('uploadHint');
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (uploadText) uploadText.textContent = t.uploadText;
            if (uploadHint) uploadHint.textContent = t.uploadHint;
            if (analyzeBtn) analyzeBtn.textContent = t.discoverDish;
            
            // Update camera button
            const cameraBtnText = document.getElementById('cameraBtnText');
            if (cameraBtnText) {
                cameraBtnText.textContent = t.useCamera;
            }
            
            // Update loading text
            const analyzingText = document.getElementById('analyzingText');
            if (analyzingText) analyzingText.textContent = t.analyzing;
            
            // Update result section
            const readyToCook = document.getElementById('readyToCook');
            const favoriteBtn = document.getElementById('favoriteBtn');
            const shareBtn = document.getElementById('shareBtn');
            const couldAlsoBe = document.getElementById('couldAlsoBe');
            if (readyToCook) readyToCook.textContent = t.readyToCook;
            if (favoriteBtn && !favoriteBtn.classList.contains('active')) favoriteBtn.textContent = t.saveToFavorites;
            if (shareBtn) shareBtn.textContent = t.shareDiscovery;
            const calorieLogTitle = document.getElementById('calorieLogTitle');
            const logEmptyText = document.getElementById('logEmptyText');
            const navCalorieLogText = document.getElementById('navCalorieLogText');
            if (calorieLogTitle) calorieLogTitle.textContent = t.calorieLogTitle;
            if (logEmptyText) logEmptyText.textContent = t.logEmptyText;
            if (navCalorieLogText) navCalorieLogText.textContent = 'Log';
            if (couldAlsoBe) couldAlsoBe.textContent = t.couldAlsoBe;
            
            // Update history section
            const recentDiscoveries = document.getElementById('recentDiscoveries');
            const historyEmpty = document.getElementById('historyEmpty');
            if (recentDiscoveries) recentDiscoveries.textContent = t.recentDiscoveries;
            if (historyEmpty) historyEmpty.textContent = t.historyEmpty;
            
            // Update favorites section
            const favoriteDishes = document.getElementById('favoriteDishes');
            const favoritesEmpty = document.getElementById('favoritesEmpty');
            if (favoriteDishes) favoriteDishes.textContent = t.favoriteDishes;
            if (favoritesEmpty) favoritesEmpty.textContent = t.favoritesEmpty;
            
            // Update settings section
            const settingsTitle = document.getElementById('settingsTitle');
            const nightModeLabel = document.getElementById('nightModeLabel');
            const nightModeDesc = document.getElementById('nightModeDesc');
            const languageLabel = document.getElementById('languageLabel');
            const languageDesc = document.getElementById('languageDesc');
            const appVersionLabel = document.getElementById('appVersionLabel');
            const appVersionDesc = document.getElementById('appVersionDesc');
            if (settingsTitle) settingsTitle.textContent = t.settingsTitle;
            if (nightModeLabel) nightModeLabel.textContent = t.nightMode;
            if (nightModeDesc) nightModeDesc.textContent = t.nightModeDesc;
            if (languageLabel) languageLabel.textContent = t.language;
            if (languageDesc) languageDesc.textContent = t.languageDesc;
            if (appVersionLabel) appVersionLabel.textContent = t.appVersion;
            if (appVersionDesc) appVersionDesc.textContent = t.appVersionDesc;
            
            // Update camera modal
            const closeCameraBtn = document.getElementById('closeCameraBtn');
            const flipCameraBtn = document.getElementById('flipCameraBtn');
            const cameraAccessDeniedTitle = document.getElementById('cameraAccessDeniedTitle');
            const cameraAccessDeniedMsg = document.getElementById('cameraAccessDeniedMsg');
            if (closeCameraBtn) closeCameraBtn.textContent = t.close;
            if (flipCameraBtn) flipCameraBtn.textContent = t.flip;
            if (cameraAccessDeniedTitle) cameraAccessDeniedTitle.textContent = t.cameraAccessDenied;
            if (cameraAccessDeniedMsg) cameraAccessDeniedMsg.textContent = t.cameraAccessDeniedMsg;
            
            // Update auth modal (only if modal is open or update labels)
            const modalTitle = document.getElementById('modalTitle');
            if (modalTitle) {
                // Check current state
                const loginForm = document.getElementById('loginForm');
                const signupForm = document.getElementById('signupForm');
                if (loginForm && loginForm.style.display !== 'none') {
                    modalTitle.textContent = t.login;
                } else if (signupForm && signupForm.style.display !== 'none') {
                    modalTitle.textContent = t.signupTitle;
                }
            }
            
        }

        function applyNightMode(isDark) {
            const root = document.documentElement;
            if (isDark) {
                root.setAttribute('data-theme', 'dark');
            } else {
                root.removeAttribute('data-theme');
            }
        }

        function saveSettings(settings) {
            localStorage.setItem('biteSightSettings', JSON.stringify(settings));
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        // ============================================
        // PROFILE CARD INITIALIZATION
        // ============================================
        let profileCardInitialized = false;
        let profileSaveInitialized = false;
        
        function initializeProfileCard() {
            const profileCard = document.getElementById('profileCard');
            const profileNicknameInput = document.getElementById('profileNicknameInput');
            const profilePictureInput = document.getElementById('profilePictureInput');
            const profilePicture = document.getElementById('profilePicture');
            const profilePicturePlaceholder = document.getElementById('profilePicturePlaceholder');
            const uploadPictureBtn = document.getElementById('uploadPictureBtn');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            
            // Show profile card if user is logged in
            if (currentUser && profileCard) {
                profileCard.style.display = 'block';
                
                // Load current profile data
                const nickname = currentUser.user_metadata?.nickname || currentUser.user_metadata?.full_name || '';
                if (profileNicknameInput && nickname) {
                    profileNicknameInput.value = nickname;
                }
                
                const profilePic = currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
                if (profilePic && profilePicture && profilePicturePlaceholder) {
                    profilePicture.src = profilePic;
                    profilePicture.style.display = 'block';
                    profilePicturePlaceholder.style.display = 'none';
                } else if (profilePicture && profilePicturePlaceholder) {
                    // Reset if no picture
                    profilePicture.style.display = 'none';
                    profilePicturePlaceholder.style.display = 'flex';
                }
            } else if (profileCard) {
                profileCard.style.display = 'none';
            }
            
            // Upload picture handler - only initialize once
            if (!profileCardInitialized && uploadPictureBtn && profilePictureInput) {
                profileCardInitialized = true;
                
                uploadPictureBtn.addEventListener('click', () => {
                    profilePictureInput.click();
                });
                
                profilePictureInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file');
                        return;
                    }
                    
                    // Validate file size (limit to 2MB for data URL storage)
                    if (file.size > 2 * 1024 * 1024) {
                        alert('Image size must be less than 2MB. Please compress the image or choose a smaller file.');
                        return;
                    }
                    
                    // Show loading state
                    const originalBtnText = uploadPictureBtn.textContent;
                    uploadPictureBtn.disabled = true;
                    uploadPictureBtn.textContent = 'Uploading...';
                    
                    try {
                        // Convert to data URL and store in metadata
                        // In production, you'd upload to Supabase Storage
                        const reader = new FileReader();
                        
                        reader.onload = async (event) => {
                            try {
                                const dataUrl = event.target.result;
                                
                                // Update UI immediately
                                if (profilePicture && profilePicturePlaceholder) {
                                    profilePicture.src = dataUrl;
                                    profilePicture.style.display = 'block';
                                    profilePicturePlaceholder.style.display = 'none';
                                }
                                
                                // Update user metadata
                                if (supabaseClient && currentUser) {
                                    const { data, error } = await supabaseClient.auth.updateUser({
                                        data: {
                                            ...currentUser.user_metadata,
                                            avatar_url: dataUrl
                                        }
                                    });
                                    
                                    if (error) {
                                        throw error;
                                    }
                                    
                                    // Refresh user data
                                    const { data: { user }, error: getUserError } = await supabaseClient.auth.getUser();
                                    if (getUserError) {
                                        throw getUserError;
                                    }
                                    
                                    if (user) {
                                        currentUser = user;
                                        updateAuthUI();
                                        alert('Profile picture updated successfully!');
                                    }
                                }
                            } catch (error) {
                                console.error('Error updating profile picture:', error);
                                alert('Error updating profile picture: ' + (error.message || 'Unknown error'));
                                // Revert UI if error
                                if (profilePicture && profilePicturePlaceholder) {
                                    const oldPic = currentUser?.user_metadata?.avatar_url || currentUser?.user_metadata?.picture;
                                    if (oldPic) {
                                        profilePicture.src = oldPic;
                                    } else {
                                        profilePicture.style.display = 'none';
                                        profilePicturePlaceholder.style.display = 'flex';
                                    }
                                }
                            } finally {
                                uploadPictureBtn.disabled = false;
                                uploadPictureBtn.textContent = originalBtnText;
                                // Reset input to allow selecting same file again
                                profilePictureInput.value = '';
                            }
                        };
                        
                        reader.onerror = () => {
                            alert('Error reading image file');
                            uploadPictureBtn.disabled = false;
                            uploadPictureBtn.textContent = originalBtnText;
                            profilePictureInput.value = '';
                        };
                        
                        reader.readAsDataURL(file);
                    } catch (error) {
                        console.error('Error processing image:', error);
                        alert('Error processing image: ' + (error.message || 'Unknown error'));
                        uploadPictureBtn.disabled = false;
                        uploadPictureBtn.textContent = originalBtnText;
                        profilePictureInput.value = '';
                    }
                });
            }
            
            // Save profile handler - only initialize once
            if (!profileSaveInitialized && saveProfileBtn && profileNicknameInput) {
                profileSaveInitialized = true;
                saveProfileBtn.addEventListener('click', async () => {
                    const nickname = profileNicknameInput.value.trim();
                    if (!nickname) {
                        alert('Please enter a nickname');
                        return;
                    }
                    
                    if (supabaseClient && currentUser) {
                        try {
                            saveProfileBtn.disabled = true;
                            saveProfileBtn.textContent = 'Saving...';
                            
                            await supabaseClient.auth.updateUser({
                                data: {
                                    ...currentUser.user_metadata,
                                    nickname: nickname,
                                    full_name: nickname
                                }
                            });
                            
                            // Refresh user data
                            const { data: { user } } = await supabaseClient.auth.getUser();
                            if (user) {
                                currentUser = user;
                                updateAuthUI();
                                alert('Profile saved successfully!');
                            }
                        } catch (error) {
                            console.error('Error saving profile:', error);
                            alert('Error saving profile: ' + error.message);
                        } finally {
                            saveProfileBtn.disabled = false;
                            saveProfileBtn.textContent = 'Save Profile';
                        }
                    }
                });
            }
        }
        
        // ============================================
        // HEADER INITIALIZATION
        // ============================================
        function initializeHeader() {
            // Logo click handler - navigate to home
            const appLogo = document.getElementById('appLogo');
            if (appLogo) {
                appLogo.addEventListener('click', () => {
                    resetToBlankSlate();
                    switchTab('discover', true);
                });
            }
            
            // Profile greeting click handler - open settings
            const profileGreeting = document.getElementById('profileGreeting');
            if (profileGreeting) {
                profileGreeting.addEventListener('click', () => {
                    switchTab('settings');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            }
            
            initializeSupabase();
            initializeUpload();
            initializeCamera();
            initializeAuth();
            initializeTabs();
            initializeSettings();
            initializeBackNavigation();
            initializeHeader();
            initializeProfileCard();
            loadHistory();
            loadFavorites();
            
            // Initialize scan limits
            updateScanLimit().then(() => {
                updateScanLimitDisplay();
            });
            
            // Handle remove preview button
            const removePreview = document.getElementById('removePreview');
            if (removePreview) {
                removePreview.addEventListener('click', (e) => {
                    e.stopPropagation();
                    resetUpload();
                });
            }
        });

        // ============================================
        // UPLOAD HANDLING
        // ============================================
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const analyzeBtn = document.getElementById('analyzeBtn');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            analyzeBtn.addEventListener('click', (e) => {
                if (analyzeBtn.disabled || !currentImage) {
                    const lang = getCurrentLanguage();
                    const t = translations[lang] || translations.en;
                    showTooltip(analyzeBtn, t.pleaseSelectImage || 'Please upload a photo.');
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                analyzeImage();
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file.');
                return;
            }

            currentImage = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                // Show preview in upload area
                const previewContainer = document.getElementById('previewContainer');
                const previewImage = document.getElementById('previewImage');
                const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
                uploadPlaceholder.style.display = 'none';
                
                // Also set it for the result section (will be shown after analysis)
                document.getElementById('dishImage').src = e.target.result;
                
                document.getElementById('analyzeBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            currentImage = null;
            currentDishData = null;
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('uploadPlaceholder').style.display = 'flex';
            document.getElementById('fileInput').value = '';
            document.getElementById('analyzeBtn').disabled = true;
            hideResult();
        }

        // ============================================
        // CAMERA FUNCTIONALITY
        // ============================================
        function initializeCamera() {
            const cameraBtn = document.getElementById('cameraBtn');
            const closeCameraBtn = document.getElementById('closeCameraBtn');
            const captureBtn = document.getElementById('captureBtn');
            const flipCameraBtn = document.getElementById('flipCameraBtn');
            const cameraModal = document.getElementById('cameraModal');

            cameraBtn.addEventListener('click', openCamera);
            closeCameraBtn.addEventListener('click', closeCamera);
            captureBtn.addEventListener('click', capturePhoto);
            flipCameraBtn.addEventListener('click', flipCamera);
        }

        async function openCamera() {
            const cameraModal = document.getElementById('cameraModal');
            const cameraVideo = document.getElementById('cameraVideo');
            const cameraError = document.getElementById('cameraError');

            cameraModal.classList.add('active');
            cameraError.style.display = 'none';

            try {
                // Stop any existing stream
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }

                // Request camera permission first (for Android/Capacitor)
                try {
                    const { Camera } = await import('@capacitor/camera');
                    const permissionStatus = await Camera.checkPermissions();
                    
                    if (permissionStatus.camera !== 'granted') {
                        const requestResult = await Camera.requestPermissions({ permissions: ['camera'] });
                        if (requestResult.camera !== 'granted') {
                            throw new Error('Camera permission denied');
                        }
                    }
                } catch (permError) {
                    // If Capacitor Camera plugin is not available (e.g., in browser), 
                    // fall through to getUserMedia which will handle permission request
                    console.log('Capacitor Camera plugin not available, using browser API:', permError);
                }

                // Request camera access
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                cameraVideo.play();
            } catch (error) {
                console.error('Camera error:', error);
                cameraError.style.display = 'block';
                cameraVideo.style.display = 'none';
                
                let errorMessage = 'Unable to access camera. ';
                if (error.name === 'NotAllowedError' || error.message === 'Camera permission denied') {
                    errorMessage += 'Please allow camera access in your device settings.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on your device.';
                } else {
                    errorMessage += error.message;
                }
                cameraError.querySelector('p').textContent = errorMessage;
            }
        }

        function closeCamera() {
            const cameraModal = document.getElementById('cameraModal');
            cameraModal.classList.remove('active');

            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const cameraVideo = document.getElementById('cameraVideo');
            cameraVideo.srcObject = null;
        }

        function capturePhoto() {
            const cameraVideo = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            // Set canvas dimensions to match video
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;

            // Draw video frame to canvas
            context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);

            // Convert canvas to blob
            canvas.toBlob((blob) => {
                if (blob) {
                    // Create a File object from the blob
                    const file = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
                    
                    // Use the existing handleFile function
                    handleFile(file);
                    
                    // Close camera
                    closeCamera();
                }
            }, 'image/jpeg', 0.95);
        }

        async function flipCamera() {
            // Toggle between front and back camera
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            
            // Restart camera with new facing mode
            const cameraVideo = document.getElementById('cameraVideo');
            
            // Stop current stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            try {
                // Request camera permission first (for Android/Capacitor)
                try {
                    const { Camera } = await import('@capacitor/camera');
                    const permissionStatus = await Camera.checkPermissions();
                    
                    if (permissionStatus.camera !== 'granted') {
                        const requestResult = await Camera.requestPermissions({ permissions: ['camera'] });
                        if (requestResult.camera !== 'granted') {
                            throw new Error('Camera permission denied');
                        }
                    }
                } catch (permError) {
                    // If Capacitor Camera plugin is not available, fall through to getUserMedia
                    console.log('Capacitor Camera plugin not available, using browser API:', permError);
                }

                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                cameraVideo.play();
            } catch (error) {
                console.error('Camera flip error:', error);
                // If flip fails, try to revert
                facingMode = facingMode === 'user' ? 'environment' : 'user';
            }
        }

        // ============================================
        // IMAGE ANALYSIS WITH OPENAI VISION
        // ============================================
        async function analyzeImage() {
            if (!currentImage) {
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                showError(t.pleaseSelectImage || 'Please select an image first.');
                return;
            }

            // API key is now handled securely on the backend server

            showLoading(true);
            hideResult();

            try {
                // Get current language
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                
                // Language names for API
                const languageNames = {
                    'en': 'English',
                    'ko': 'Korean ()',
                    'es': 'Spanish (Espaol)',
                    'fr': 'French (Franais)',
                    'zh': 'Chinese ()'
                };
                
                const targetLanguage = languageNames[lang] || 'English';
                
                // Convert image to base64
                const base64Image = await fileToBase64(currentImage);

                // Call backend API for image analysis
                // Add timeout and better error handling
                console.log('Starting API call to backend...');
                console.log('Network status:', navigator.onLine ? 'Online' : 'Offline');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.error('API request timed out after 60 seconds');
                    controller.abort();
                }, 60000); // 60 second timeout
                
                let response;
                try {
                    console.log('Sending fetch request to backend...');
                    const backendUrl = CONFIG.BACKEND_URL || 'http://localhost:3000';
                    response = await fetch(`${backendUrl}/api/analyze-image`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            imageData: `data:image/jpeg;base64,${base64Image}`,
                            targetLanguage: targetLanguage,
                            userId: currentUser?.id || null,
                            isPremium: isPremiumUser()
                        }),
                        signal: controller.signal
                    });
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    console.error('Fetch error caught:', {
                        name: fetchError.name,
                        message: fetchError.message,
                        stack: fetchError.stack
                    });
                    
                    if (fetchError.name === 'AbortError') {
                        throw new Error('Request timed out');
                    }
                    
                    // Check if it's a network error
                    if (fetchError.message && (
                        fetchError.message.includes('Failed to fetch') ||
                        fetchError.message.includes('NetworkError') ||
                        fetchError.message.includes('Network request failed') ||
                        fetchError.message.includes('Load failed')
                    )) {
                        console.error('Network error detected - this might be a CORS or connectivity issue');
                        throw new Error('Network request failed - check internet connection');
                    }
                    
                    throw fetchError;
                }
                
                clearTimeout(timeoutId);
                
                console.log('API response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });

                if (!response.ok) {
                    let errorText = '';
                    let errorDetails = null;
                    try {
                        errorText = await response.text();
                        errorDetails = JSON.parse(errorText);
                    } catch (e) {
                        // If parsing fails, use raw text
                        errorText = errorText || 'Unknown error';
                    }
                    
                    console.error('Backend API response error:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorText: errorText.substring(0, 500),
                        errorDetails: errorDetails
                    });
                    
                    // Handle scan limit exceeded (429 status)
                    if (response.status === 429 && errorDetails?.limitExceeded) {
                        // Update scan info
                        userScanInfo = {
                            remaining: 0,
                            limit: errorDetails.limit || 3,
                            level: errorDetails.level || 'guest'
                        };
                        updateScanLimitDisplay();
                        
                        // Display the friendly error message
                        const errorMessage = errorDetails.error || errorDetails.message || "Oops! That's all your scans for today. Come back tomorrow! ";
                        showError(errorMessage);
                        showLoading(false);
                        return; // Stop execution, don't throw
                    }
                    
                    // Handle backend errors
                    const errorMessage = errorDetails?.error || errorText || `Server error: ${response.status} ${response.statusText}`;
                    
                    if (response.status === 500 && errorMessage.includes('Server configuration error')) {
                        throw new Error('Backend server configuration error. Please contact the administrator.');
                    } else if (response.status === 400) {
                        throw new Error(`Invalid request: ${errorMessage}`);
                    } else if (response.status === 401) {
                        throw new Error(`API error: 401 - Authentication failed. ${errorMessage}`);
                    } else {
                        throw new Error(`API error: ${response.status} - ${errorMessage}`);
                    }
                }

                const data = await response.json();
                
                // Update scan info from response
                if (data.scanInfo) {
                    userScanInfo = data.scanInfo;
                    updateScanLimitDisplay();
                }
                
                let analysis;
                const rawContent = data.choices[0].message.content;
                
                try {
                    // Try to parse as JSON first
                    // Clean the content - remove markdown code blocks if present
                    let cleanedContent = rawContent.trim();
                    if (cleanedContent.startsWith('```json')) {
                        cleanedContent = cleanedContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    } else if (cleanedContent.startsWith('```')) {
                        cleanedContent = cleanedContent.replace(/```\n?/g, '').trim();
                    }
                    
                    analysis = JSON.parse(cleanedContent);
                } catch (e) {
                    // If not JSON, try to extract information from text
                    const content = rawContent;
                    // Look for any dish indicators in the text
                    if (content.toLowerCase().includes('dish') || content.toLowerCase().includes('food') || content.toLowerCase().includes('korean') || content.toLowerCase().includes('')) {
                        // Extract dish name
                        const dishMatch = content.match(/([A-Za-z\s]+)\s*\(?|\)?/i) || content.match(/([A-Za-z\s]{3,})/);
                        const isKorean = content.toLowerCase().includes('korean') || content.toLowerCase().includes('');
                        analysis = {
                            dish_detected: true,
                            is_korean: isKorean,
                            dish_name: dishMatch ? dishMatch[1].trim() : 'Dish',
                            dish_name_korean: isKorean ? '' : '',
                            cuisine: isKorean ? 'Korean' : 'Unknown',
                            confidence: 0.7,
                            description: content.substring(0, 300) + '...',
                            alternatives: []
                        };
                    } else {
                        analysis = {
                            dish_detected: false,
                            message: "I couldn't recognize any food in this image. Try another angle or make sure the food is clearly visible."
                        };
                    }
                }

                if (!analysis.dish_detected) {
                    const errorMessage = analysis.message || t.couldNotRecognize || "I couldn't recognize any food in this image. Try another angle or make sure the food is clearly visible.";
                    showError(errorMessage);
                    showLoading(false);
                    return;
                }

                // Process the result - all text is already in user's language from API
                currentDishData = {
                    name: analysis.dish_name || (lang === 'ko' ? '   ' : lang === 'es' ? 'Plato Desconocido' : lang === 'fr' ? 'Plat Inconnu' : lang === 'zh' ? '' : 'Unknown Dish'),
                    nameKorean: analysis.is_korean ? (analysis.dish_name_korean || '') : '',
                    isKorean: analysis.is_korean || false,
                    cuisine: analysis.cuisine || (lang === 'ko' ? '  ' : lang === 'es' ? 'Desconocido' : lang === 'fr' ? 'Inconnu' : lang === 'zh' ? '' : 'Unknown'),
                    confidence: analysis.confidence || 0.5,
                    description: analysis.description || (lang === 'ko' ? '   .' : lang === 'es' ? 'Un plato delicioso esperando ser descubierto.' : lang === 'fr' ? 'Un plat dlicieux en attente d\'tre dcouvert.' : lang === 'zh' ? '' : 'A delicious dish waiting to be discovered.'),
                    alternatives: analysis.alternatives || [],
                    nutrition: analysis.nutrition || {
                        calories: 0,
                        protein: 0,
                        carbs: 0,
                        fat: 0
                    }
                };

                displayResult(currentDishData);
                showLoading(false);
                
                // Update scan limits after successful scan
                await updateScanLimit();
                updateScanLimitDisplay();
                
                // Setup recipe links
                setupRecipeLinks(currentDishData.name);
                
                // Save to history (await to ensure it completes)
                await addToHistory(currentDishData);

            } catch (error) {
                console.error('Analysis error:', error);
                console.error('Error details:', {
                    message: error.message,
                    name: error.name,
                    stack: error.stack
                });
                
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                
                // More specific error message based on error type
                let errorMessage = t.analysisError || 'Looks like I can\'t reach the recipe data right now. Let\'s retry soon!';
                
                // Check for various error types
                if (error.message && error.message.includes('Backend server configuration error')) {
                    errorMessage = 'Backend server configuration error. Please contact the administrator.';
                } else if (error.message && error.message.includes('API error: 401')) {
                    errorMessage = 'Authentication failed. Please contact the administrator.';
                } else if (error.message && error.message.includes('API error: 429')) {
                    errorMessage = 'API rate limit exceeded. Please try again later.';
                } else if (error.message && error.message.includes('API error: 500') || error.message.includes('API error: 503')) {
                    errorMessage = 'Service is temporarily unavailable. Please try again later.';
                } else if (error.message && error.message.includes('API error')) {
                    // Extract status code from error message
                    const statusMatch = error.message.match(/API error: (\d+)/);
                    if (statusMatch) {
                        errorMessage = `API error (${statusMatch[1]}). Please try again later.`;
                    } else {
                        errorMessage = t.apiError || 'Unable to connect to the analysis service. Please check your internet connection and try again.';
                    }
                } else if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('Network request failed'))) {
                    errorMessage = t.networkError || 'Network error. Please check your internet connection and try again.';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = t.networkError || 'Network error. Please check your internet connection and try again.';
                } else if (error.message && error.message.includes('CORS')) {
                    errorMessage = t.apiError || 'Unable to connect to the analysis service. Please check your internet connection and try again.';
                } else if (error.message && error.message.includes('timeout')) {
                    errorMessage = t.apiError || 'Request timed out. Please check your internet connection and try again.';
                }
                
                // Log additional debugging info
                if (!navigator.onLine) {
                    console.error('Device appears to be offline');
                    errorMessage = t.networkError || 'You appear to be offline. Please check your internet connection.';
                }
                
                showError(errorMessage);
                showLoading(false);
            }
        }

        // Optimize image before converting to base64
        async function optimizeImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Calculate optimal dimensions (max 1024px on longest side for faster API response)
                        const MAX_DIMENSION = 1024;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > MAX_DIMENSION) {
                                height = (height * MAX_DIMENSION) / width;
                                width = MAX_DIMENSION;
                            }
                        } else {
                            if (height > MAX_DIMENSION) {
                                width = (width * MAX_DIMENSION) / height;
                                height = MAX_DIMENSION;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to JPEG with 85% quality (good balance between quality and size)
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Failed to compress image'));
                            }
                        }, 'image/jpeg', 0.85);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function fileToBase64(file) {
            return new Promise(async (resolve, reject) => {
                try {
                    // Optimize image first (compress and resize)
                    const optimizedBlob = await optimizeImage(file);
                    
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(optimizedBlob);
                } catch (error) {
                    // Fallback to original if optimization fails
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }
            });
        }

        // ============================================
        // RESULT DISPLAY
        // ============================================
        function displayResult(dishData) {
            isShowingResult = true;
            
            // Push a history state when showing result so back button works properly
            if (currentRoute === 'discover') {
                window.history.pushState({ route: 'discover', showingResult: true }, '', window.location.href);
            }
            
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            
            const resultSection = document.getElementById('resultSection');
            const dishName = document.getElementById('dishName');
            const confidenceBadge = document.getElementById('confidenceBadge');
            const dishDescription = document.getElementById('dishDescription');
            const alternativesSection = document.getElementById('alternativesSection');
            const alternativeChips = document.getElementById('alternativeChips');

            // Set dish name - display in user's language
            if (dishData.isKorean && dishData.nameKorean) {
                // For Korean dishes, show both translated name and Korean name
                dishName.textContent = `${dishData.name} (${dishData.nameKorean})`;
            } else {
                dishName.textContent = dishData.name;
                if (dishData.cuisine && dishData.cuisine !== 'Unknown' && dishData.cuisine !== '  ' && dishData.cuisine !== 'Desconocido' && dishData.cuisine !== 'Inconnu' && dishData.cuisine !== '') {
                    dishName.textContent += `  ${dishData.cuisine}`;
                }
            }

            // Set confidence badge with translation
            const confidence = Math.round(dishData.confidence * 100);
            confidenceBadge.textContent = `${confidence}% ${t.confident || 'confident'}`;
            
            if (dishData.confidence >= 0.8) {
                confidenceBadge.className = 'confidence-badge';
            } else if (dishData.confidence >= 0.5) {
                confidenceBadge.className = 'confidence-badge medium';
            } else {
                confidenceBadge.className = 'confidence-badge low';
            }

            // Set description - already in user's language from API
            let descriptionText = dishData.description || '';
            // Remove any JSON artifacts or code blocks
            descriptionText = descriptionText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            // If description looks like JSON, try to extract meaningful text
            if (descriptionText.startsWith('{') || descriptionText.startsWith('[')) {
                try {
                    const parsed = JSON.parse(descriptionText);
                    descriptionText = parsed.description || parsed.text || descriptionText;
                } catch (e) {
                    // If parsing fails, just use the text as is but clean it up
                    descriptionText = descriptionText.replace(/[{}[\]]/g, '').replace(/"/g, '').trim();
                }
            }
            dishDescription.innerHTML = `<strong>${dishData.name}</strong><br><br>${descriptionText}`;

            // Show alternatives if confidence is low
            if (dishData.confidence < 0.5) {
                // Remove any existing low confidence message
                const existingMsg = dishDescription.parentNode.querySelector('.warm-message');
                if (existingMsg) existingMsg.remove();
                
                // Very low confidence - show encouraging message in user's language
                const lowConfidenceMsg = document.createElement('div');
                lowConfidenceMsg.className = 'warm-message';
                lowConfidenceMsg.style.marginTop = '1rem';
                const cuisineText = dishData.cuisine || '';
                // Construct message based on language
                let message = '';
                if (lang === 'ko') {
                    message = `   ,  <strong>${dishData.name}</strong>${cuisineText ? `  ${cuisineText} ` : ''}  .     ?`;
                } else if (lang === 'es') {
                    message = `No estoy completamente seguro, pero esto podra ser <strong>${dishData.name}</strong>${cuisineText ? `  un plato ${cuisineText}` : ''}. Cul se parece ms al tuyo?`;
                } else if (lang === 'fr') {
                    message = `Je ne suis pas compltement sr, mais cela pourrait tre <strong>${dishData.name}</strong>${cuisineText ? `  un plat ${cuisineText}` : ''}. Lequel ressemble le plus au vtre ?`;
                } else if (lang === 'zh') {
                    message = ` <strong>${dishData.name}</strong>${cuisineText ? `  ${cuisineText}` : ''}`;
                } else {
                    message = `I'm not completely sure, but this could be <strong>${dishData.name}</strong>${cuisineText ? `  a ${cuisineText} dish` : ''}. Which one looks closer to yours?`;
                }
                lowConfidenceMsg.innerHTML = `<p>${message}</p>`;
                dishDescription.parentNode.insertBefore(lowConfidenceMsg, dishDescription.nextSibling);
            }
            
            if (dishData.confidence < 0.8 && dishData.alternatives && dishData.alternatives.length > 0) {
                alternativesSection.style.display = 'block';
                alternativeChips.innerHTML = '';
                dishData.alternatives.forEach(alt => {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.textContent = alt;
                    chip.addEventListener('click', () => {
                        // Could implement alternative selection here
                        const lang = getCurrentLanguage();
                        const t = translations[lang] || translations.en;
                        alert(t.alternativeSelected ? t.alternativeSelected.replace('${alt}', alt) : `You selected: ${alt}. This feature can be enhanced to search for this dish.`);
                    });
                    alternativeChips.appendChild(chip);
                });
            } else {
                alternativesSection.style.display = 'none';
            }

            // Update favorite button state
            updateFavoriteButtonState();

            // Display nutrition info
            displayNutritionInfo(dishData);

            // Show "Add to Today's Log" button
            const addToLogBtn = document.getElementById('addToLogBtn');
            if (addToLogBtn && dishData.nutrition && dishData.nutrition.calories > 0) {
                addToLogBtn.style.display = 'block';
            } else if (addToLogBtn) {
                addToLogBtn.style.display = 'none';
            }

            // Show result section
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function displayNutritionInfo(dishData) {
            const nutritionSection = document.getElementById('nutritionSection');
            const nutrition = dishData.nutrition || { calories: 0, protein: 0, carbs: 0, fat: 0 };
            
            if (nutritionSection && nutrition && nutrition.calories > 0) {
                document.getElementById('nutritionCalories').textContent = Math.round(nutrition.calories);
                document.getElementById('nutritionProtein').textContent = Math.round(nutrition.protein) + 'g';
                document.getElementById('nutritionCarbs').textContent = Math.round(nutrition.carbs) + 'g';
                document.getElementById('nutritionFat').textContent = Math.round(nutrition.fat) + 'g';
                nutritionSection.style.display = 'block';
            } else if (nutritionSection) {
                nutritionSection.style.display = 'none';
            }
        }

        function hideResult() {
            document.getElementById('resultSection').style.display = 'none';
            // Reset favorite button when hiding results
            updateFavoriteButtonState();
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (loading) {
                if (show) {
                    loading.classList.add('active');
                    // Remove any inline display style to let CSS handle it
                    loading.style.display = '';
                } else {
                    loading.classList.remove('active');
                    loading.style.display = 'none';
                }
            }
        }

        function showError(message) {
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'block';
            resultSection.innerHTML = `
                <div class="error-message">
                    <h3 style="margin-bottom: 0.5rem;"> Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // Show signup prompt for features that require login
        function showSignupPrompt(feature) {
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            
            let title = '';
            let message = '';
            let ctaText = 'Sign Up Free';
            
            if (feature === 'favorites') {
                title = 'Save Your Favorites! ';
                message = 'Create a free account to save your favorite dishes and access them anytime. It only takes a moment!';
            } else if (feature === 'calorie-log') {
                title = 'Track Your Calories! ';
                message = 'Sign up for free to log your meals and track your daily nutrition. Start your health journey today!';
            } else {
                title = 'Join Us! ';
                message = 'Create a free account to unlock all features and get 10 scans per day!';
            }
            
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h2 class="modal-title">${title}</h2>
                        <button class="close-modal" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div style="padding: 24px;">
                        <p style="margin-bottom: 24px; color: var(--text-secondary); line-height: 1.6;">
                            ${message}
                        </p>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn" onclick="this.closest('.modal-overlay').remove(); document.getElementById('loginModal').classList.add('active'); showSignupForm();" style="flex: 1;">
                                ${ctaText}
                            </button>
                            <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()" style="flex: 1;">
                                Maybe Later
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.classList.add('active');
            
            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Show tooltip for user feedback
        function showTooltip(element, message) {
            // Remove any existing tooltip
            const existingTooltip = document.querySelector('.feedback-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }

            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.className = 'feedback-tooltip';
            tooltip.textContent = message;
            document.body.appendChild(tooltip);

            // Position tooltip near the button
            const rect = element.getBoundingClientRect();
            tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
            tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';

            // Show tooltip
            setTimeout(() => {
                tooltip.classList.add('show');
            }, 10);

            // Remove tooltip after 3 seconds
            setTimeout(() => {
                tooltip.classList.remove('show');
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.remove();
                    }
                }, 300);
            }, 3000);
        }

        // ============================================
        // RECIPE LINKS
        // ============================================
        function setupRecipeLinks(dishName) {
            const recipeLinksContainer = document.getElementById('recipeLinks');
            if (!recipeLinksContainer) return;
            
            // Use just the dish name for search - no cuisine suffix needed
            const searchTerm = dishName;
            
            const encodedTerm = encodeURIComponent(searchTerm);
            
            // Recipe sites with their search URLs
            const recipeSites = [
                {
                    name: 'Maangchi',
                    url: `https://www.maangchi.com/search?q=${encodedTerm}`,
                    icon: ''
                },
                {
                    name: 'Korean Bapsang',
                    url: `https://www.koreanbapsang.com/?s=${encodedTerm}`,
                    icon: ''
                },
                {
                    name: 'Serious Eats',
                    url: `https://www.seriouseats.com/search?q=${encodedTerm}`,
                    icon: ''
                },
                {
                    name: 'AllRecipes',
                    url: `https://www.allrecipes.com/search?q=${encodedTerm}`,
                    icon: ''
                }
            ];
            
            // Create recipe links
            recipeLinksContainer.innerHTML = recipeSites.map(site => `
                <a href="${site.url}" class="recipe-link" target="_blank" rel="noopener noreferrer">
                    <span style="margin-right: 0.5rem;">${site.icon}</span>
                    <span>${site.name}</span>
                    <span style="margin-left: auto;"></span>
                </a>
            `).join('');
        }

        // ============================================
        // HISTORY MANAGEMENT
        // ============================================
        async function addToHistory(dishData) {
            const historyItem = {
                name: dishData.name,
                nameKorean: dishData.nameKorean,
                isKorean: dishData.isKorean,
                cuisine: dishData.cuisine,
                confidence: dishData.confidence,
                description: dishData.description,
                alternatives: dishData.alternatives || [],
                thumbnail: document.getElementById('dishImage').src,
                imageSrc: document.getElementById('dishImage').src,
                timestamp: new Date().toISOString()
            };

            // If user is logged in, save to DB
            if (currentUser && supabaseClient) {
                try {
                    // Get existing history from DB (use maybeSingle to handle no row case)
                    const { data: existingData, error: fetchError } = await supabaseClient
                        .from('user_history')
                        .select('history')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();
                    
                    // If table doesn't exist or other error, fallback to localStorage
                    if (fetchError && fetchError.code !== 'PGRST116') {
                        console.warn('History table may not exist. Using localStorage. Error:', fetchError);
                        saveToLocalHistory(historyItem);
                        return;
                    }
                    
                    let history = existingData?.history || [];
                    
                    // Remove duplicates
                    history = history.filter(item => item.name !== dishData.name);
                    
                    // Add to beginning
                    history.unshift(historyItem);
                    
                    // Keep only last 30
                    history = history.slice(0, 30);
                    
                    // Upsert to DB
                    const { error: upsertError } = await supabaseClient
                        .from('user_history')
                        .upsert({
                            user_id: currentUser.id,
                            history: history,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id'
                        });
                    
                    if (upsertError) {
                        console.error('Error upserting history to DB:', upsertError);
                        // Fallback to localStorage
                        saveToLocalHistory(historyItem);
                    } else {
                        // Also save to localStorage for immediate display
                        localStorage.setItem('biteSightHistory', JSON.stringify(history));
                    }
                } catch (error) {
                    console.error('Error saving history to DB:', error);
                    // Fallback to localStorage
                    saveToLocalHistory(historyItem);
                }
            } else {
                // Save to localStorage if not logged in
                saveToLocalHistory(historyItem);
            }
            
            // Reload history display
            await loadHistory();
        }
        
        function saveToLocalHistory(historyItem) {
            let history = JSON.parse(localStorage.getItem('biteSightHistory') || '[]');
            history = history.filter(item => item.name !== historyItem.name);
            history.unshift(historyItem);
            history = history.slice(0, 10);
            localStorage.setItem('biteSightHistory', JSON.stringify(history));
        }
        
        async function loadUserHistoryAndFavorites() {
            if (!currentUser || !supabaseClient) return;
            
            try {
                // Load history from DB (use maybeSingle to handle no row case)
                const { data: historyData, error: historyError } = await supabaseClient
                    .from('user_history')
                    .select('history')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();
                
                if (historyError && historyError.code !== 'PGRST116') {
                    console.warn('History table may not exist:', historyError);
                } else if (historyData?.history) {
                    // Sync to localStorage for display
                    localStorage.setItem('biteSightHistory', JSON.stringify(historyData.history));
                    loadHistory();
                }
                
                // Load favorites from DB (use maybeSingle to handle no row case)
                const { data: favoritesData, error: favoritesError } = await supabaseClient
                    .from('user_favorites')
                    .select('favorites')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();
                
                if (favoritesError && favoritesError.code !== 'PGRST116') {
                    console.warn('Favorites table may not exist:', favoritesError);
                } else if (favoritesData?.favorites) {
                    // Sync to localStorage for display
                    localStorage.setItem('biteSightFavorites', JSON.stringify(favoritesData.favorites));
                    loadFavorites();
                }

                // Load calorie log
                loadCalorieLog();
            } catch (error) {
                console.error('Error loading user data from DB:', error);
            }
        }

        // ============================================
        // CALORIE LOG FUNCTIONS
        // ============================================
        async function addToCalorieLog(dishData) {
            if (!dishData || !dishData.nutrition) return;

            const logItem = {
                name: dishData.name,
                nameKorean: dishData.nameKorean || '',
                nutrition: dishData.nutrition,
                timestamp: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0] // YYYY-MM-DD format
            };

            // Get today's date
            const today = new Date().toISOString().split('T')[0];

            // If user is logged in, save to DB
            if (currentUser && supabaseClient) {
                try {
                    const { data: existingData, error: fetchError } = await supabaseClient
                        .from('user_calorie_log')
                        .select('logs')
                        .eq('user_id', currentUser.id)
                        .eq('date', today)
                        .maybeSingle();
                    
                    // PGRST116 = no rows found, PGRST205 = table doesn't exist
                    if (fetchError && fetchError.code !== 'PGRST116' && fetchError.code !== 'PGRST205') {
                        console.warn('Calorie log table error. Using localStorage. Error:', fetchError);
                        saveToLocalCalorieLog(logItem);
                        return;
                    }
                    if (fetchError && fetchError.code === 'PGRST205') {
                        // Table doesn't exist, use localStorage silently
                        saveToLocalCalorieLog(logItem);
                        return;
                    }
                    
                    let logs = existingData?.logs || [];
                    logs.push(logItem);
                    
                    const { error: upsertError } = await supabaseClient
                        .from('user_calorie_log')
                        .upsert({
                            user_id: currentUser.id,
                            date: today,
                            logs: logs,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,date'
                        });
                    
                    // PGRST205 = table doesn't exist - silently use localStorage
                    if (upsertError && upsertError.code !== 'PGRST205') {
                        console.error('Error saving to calorie log:', upsertError);
                        saveToLocalCalorieLog(logItem);
                    } else if (upsertError && upsertError.code === 'PGRST205') {
                        // Table doesn't exist, use localStorage silently
                        saveToLocalCalorieLog(logItem);
                    } else {
                        // Also save to localStorage for quick access
                        saveToLocalCalorieLog(logItem);
                        loadCalorieLog();
                    }
                } catch (error) {
                    // PGRST205 = table doesn't exist - silently use localStorage
                    if (error.code !== 'PGRST205') {
                        console.error('Error adding to calorie log:', error);
                    }
                    saveToLocalCalorieLog(logItem);
                }
            } else {
                // Not logged in, use localStorage only
                saveToLocalCalorieLog(logItem);
            }
        }

        function saveToLocalCalorieLog(logItem) {
            const today = new Date().toISOString().split('T')[0];
            const key = `calorieLog_${today}`;
            let logs = JSON.parse(localStorage.getItem(key) || '[]');
            logs.push(logItem);
            localStorage.setItem(key, JSON.stringify(logs));
            loadCalorieLog();
        }

        async function loadCalorieLog() {
            const today = new Date().toISOString().split('T')[0];
            let logs = [];

            // Try to load from DB if logged in
            if (currentUser && supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('user_calorie_log')
                        .select('logs')
                        .eq('user_id', currentUser.id)
                        .eq('date', today)
                        .maybeSingle();
                    
                    // PGRST116 = no rows found, PGRST205 = table doesn't exist - both are fine, use localStorage
                    if (error && error.code !== 'PGRST116' && error.code !== 'PGRST205') {
                        console.warn('Calorie log table error:', error);
                    } else if (data?.logs) {
                        logs = data.logs;
                        // Sync to localStorage
                        localStorage.setItem(`calorieLog_${today}`, JSON.stringify(logs));
                    }
                } catch (error) {
                    console.error('Error loading calorie log from DB:', error);
                }
            }

            // Fallback to localStorage
            if (logs.length === 0) {
                logs = JSON.parse(localStorage.getItem(`calorieLog_${today}`) || '[]');
            }

            // Calculate totals
            const totals = logs.reduce((acc, item) => {
                acc.calories += item.nutrition?.calories || 0;
                acc.protein += item.nutrition?.protein || 0;
                acc.carbs += item.nutrition?.carbs || 0;
                acc.fat += item.nutrition?.fat || 0;
                return acc;
            }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

            // Update UI
            updateCalorieLogUI(logs, totals);
        }

        function updateCalorieLogUI(logs, totals) {
            const logItems = document.getElementById('logItems');
            const logEmpty = document.getElementById('logEmpty');
            const totalCalories = document.getElementById('totalCalories');
            const totalProtein = document.getElementById('totalProtein');
            const totalCarbs = document.getElementById('totalCarbs');
            const totalFat = document.getElementById('totalFat');

            // Update totals
            if (totalCalories) totalCalories.textContent = Math.round(totals.calories);
            if (totalProtein) totalProtein.textContent = Math.round(totals.protein) + 'g';
            if (totalCarbs) totalCarbs.textContent = Math.round(totals.carbs) + 'g';
            if (totalFat) totalFat.textContent = Math.round(totals.fat) + 'g';

            // Update log items
            if (!logItems) return;

            if (logs.length === 0) {
                logItems.innerHTML = '';
                if (logEmpty) logEmpty.style.display = 'block';
                return;
            }

            if (logEmpty) logEmpty.style.display = 'none';

            logItems.innerHTML = logs.map((item, index) => `
                <div class="log-item">
                    <div class="log-item-info">
                        <div class="log-item-name">${item.nameKorean ? `${item.name} (${item.nameKorean})` : item.name}</div>
                        <div class="log-item-nutrition">
                            P: ${Math.round(item.nutrition?.protein || 0)}g  
                            C: ${Math.round(item.nutrition?.carbs || 0)}g  
                            F: ${Math.round(item.nutrition?.fat || 0)}g
                        </div>
                    </div>
                    <div class="log-item-calories">${Math.round(item.nutrition?.calories || 0)}</div>
                    <button class="log-item-delete" onclick="removeFromCalorieLog(${index})" title="Remove"></button>
                </div>
            `).join('');
        }

        async function removeFromCalorieLog(index) {
            const today = new Date().toISOString().split('T')[0];
            let logs = [];

            // Load current logs
            if (currentUser && supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('user_calorie_log')
                        .select('logs')
                        .eq('user_id', currentUser.id)
                        .eq('date', today)
                        .maybeSingle();
                    
                    // PGRST116 = no rows found, PGRST205 = table doesn't exist - both are fine
                    if (!error && data?.logs) {
                        logs = data.logs;
                    } else if (error && error.code !== 'PGRST116' && error.code !== 'PGRST205') {
                        console.warn('Error loading logs:', error);
                    }
                } catch (error) {
                    // PGRST205 = table doesn't exist - silently use localStorage
                    if (error.code !== 'PGRST205') {
                        console.error('Error loading logs:', error);
                    }
                }
            }

            if (logs.length === 0) {
                logs = JSON.parse(localStorage.getItem(`calorieLog_${today}`) || '[]');
            }

            // Remove item
            logs.splice(index, 1);

            // Save back
            if (currentUser && supabaseClient) {
                try {
                    await supabaseClient
                        .from('user_calorie_log')
                        .upsert({
                            user_id: currentUser.id,
                            date: today,
                            logs: logs,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,date'
                        });
                } catch (error) {
                    // PGRST205 = table doesn't exist - silently use localStorage
                    if (error.code !== 'PGRST205') {
                        console.error('Error removing from log:', error);
                    }
                }
            }

            localStorage.setItem(`calorieLog_${today}`, JSON.stringify(logs));
            loadCalorieLog();
        }

        async function loadHistory() {
            // Try to load from DB first if logged in
            if (currentUser && supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('user_history')
                        .select('history')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();
                    
                    if (error && error.code !== 'PGRST116') {
                        console.warn('History table may not exist:', error);
                    } else if (data?.history) {
                        localStorage.setItem('biteSightHistory', JSON.stringify(data.history));
                    }
                } catch (error) {
                    console.error('Error loading history from DB:', error);
                }
            }
            
            const history = JSON.parse(localStorage.getItem('biteSightHistory') || '[]');
            const historyGrid = document.getElementById('historyGrid');
            const warmMessage = document.getElementById('warmMessage');
            const warmMessageText = document.getElementById('warmMessageText');
            
            if (history.length === 0) {
                warmMessage.style.display = 'none';
                historyGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p>Your exploration history will appear here</p>
                    </div>
                `;
                return;
            }

            // Show warm message with recent dishes
            const recentDishes = history.slice(0, 3).map(item => item.nameKorean || item.name).join(', ');
            if (history.length >= 2) {
                warmMessageText.textContent = `You recently explored ${recentDishes}  want to save them for your cooking list?`;
                warmMessage.style.display = 'block';
            } else {
                warmMessage.style.display = 'none';
            }

            historyGrid.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadDishFromHistory('${item.name.replace(/'/g, "\\'")}')">
                    <img src="${item.thumbnail}" alt="${item.name}" class="item-thumbnail">
                    <div class="item-name">${item.nameKorean ? `${item.name}<br><small>${item.nameKorean}</small>` : item.name}</div>
                    <div class="item-time">${formatTime(item.timestamp)}</div>
                </div>
            `).join('');
        }

        function getCurrentLanguage() {
            const settings = JSON.parse(localStorage.getItem('biteSightSettings') || '{}');
            return settings.language || 'en';
        }

        function formatTime(timestamp) {
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return t.justNow;
            if (minutes < 60) return `${minutes}${t.minutesAgo}`;
            if (hours < 24) return `${hours}${t.hoursAgo}`;
            if (days < 7) return `${days}${t.daysAgo}`;
            return date.toLocaleDateString();
        }

        // ============================================
        // FAVORITES MANAGEMENT
        // ============================================
        function updateFavoriteButtonState() {
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            const favoriteBtn = document.getElementById('favoriteBtn');
            
            if (!currentDishData) {
                // Reset button if no dish data
                favoriteBtn.textContent = t.saveToFavorites;
                favoriteBtn.classList.remove('active');
                return;
            }

            const favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            const exists = favorites.find(f => f.name === currentDishData.name);
            
            if (exists) {
                favoriteBtn.textContent = t.saved;
                favoriteBtn.classList.add('active');
            } else {
                favoriteBtn.textContent = t.saveToFavorites;
                favoriteBtn.classList.remove('active');
            }
        }

        document.getElementById('favoriteBtn').addEventListener('click', async () => {
            // Check if user is logged in
            if (!currentUser) {
                showSignupPrompt('favorites');
                return;
            }
            if (!currentDishData) return;
            
            const favoriteItem = {
                name: currentDishData.name,
                nameKorean: currentDishData.nameKorean,
                isKorean: currentDishData.isKorean,
                cuisine: currentDishData.cuisine,
                confidence: currentDishData.confidence,
                description: currentDishData.description,
                alternatives: currentDishData.alternatives || [],
                thumbnail: document.getElementById('dishImage').src,
                imageSrc: document.getElementById('dishImage').src,
                timestamp: new Date().toISOString()
            };

            // If user is logged in, save to DB
            if (currentUser && supabaseClient) {
                try {
                    const { data: existingData, error: fetchError } = await supabaseClient
                        .from('user_favorites')
                        .select('favorites')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();
                    
                    // If table doesn't exist or other error, fallback to localStorage
                    if (fetchError && fetchError.code !== 'PGRST116') {
                        console.warn('Favorites table may not exist. Using localStorage. Error:', fetchError);
                        saveToLocalFavorites(favoriteItem);
                        return;
                    }
                    
                    let favorites = existingData?.favorites || [];
                    const exists = favorites.find(f => f.name === currentDishData.name);
                    
                    if (exists) {
                        favorites = favorites.filter(f => f.name !== currentDishData.name);
                    } else {
                        favorites.unshift(favoriteItem);
                    }
                    
                    const { error: upsertError } = await supabaseClient
                        .from('user_favorites')
                        .upsert({
                            user_id: currentUser.id,
                            favorites: favorites,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id'
                        });
                    
                    if (upsertError) {
                        console.error('Error upserting favorites to DB:', upsertError);
                        // Fallback to localStorage
                        saveToLocalFavorites(favoriteItem);
                    } else {
                        // Also save to localStorage for immediate display
                        localStorage.setItem('biteSightFavorites', JSON.stringify(favorites));
                    }
                } catch (error) {
                    console.error('Error saving favorite to DB:', error);
                    // Fallback to localStorage
                    saveToLocalFavorites(favoriteItem);
                }
            } else {
                saveToLocalFavorites(favoriteItem);
            }
            
            updateFavoriteButtonState();
            loadFavorites();
        });
        
        function saveToLocalFavorites(favoriteItem) {
            let favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            const exists = favorites.find(f => f.name === favoriteItem.name);
            if (exists) {
                favorites = favorites.filter(f => f.name !== favoriteItem.name);
            } else {
                favorites.unshift(favoriteItem);
            }
            localStorage.setItem('biteSightFavorites', JSON.stringify(favorites));
        }

        async function loadFavorites() {
            // Try to load from DB first if logged in
            if (currentUser && supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('user_favorites')
                        .select('favorites')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();
                    
                    if (error && error.code !== 'PGRST116') {
                        console.warn('Favorites table may not exist:', error);
                    } else if (data?.favorites) {
                        localStorage.setItem('biteSightFavorites', JSON.stringify(data.favorites));
                    }
                } catch (error) {
                    console.error('Error loading favorites from DB:', error);
                }
            }
            
            const favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            const favoritesGrid = document.getElementById('favoritesGrid');
            
            if (favorites.length === 0) {
                favoritesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <p>Save dishes you love to revisit them later</p>
                    </div>
                `;
                return;
            }

            favoritesGrid.innerHTML = favorites.map(item => `
                <div class="favorite-item" onclick="loadDishFromFavorites('${item.name.replace(/'/g, "\\'")}')">
                    <img src="${item.thumbnail}" alt="${item.name}" class="item-thumbnail">
                    <div class="item-name">${item.nameKorean ? `${item.name}<br><small>${item.nameKorean}</small>` : item.name}</div>
                </div>
            `).join('');
        }

        // ============================================
        // SHARE FUNCTIONALITY
        // ============================================
        document.getElementById('shareBtn').addEventListener('click', async () => {
            if (!currentDishData) return;

            const shareData = {
                title: `I discovered ${currentDishData.name} with Ok Snap! `,
                text: `Check out this amazing dish: ${currentDishData.name}${currentDishData.cuisine && currentDishData.cuisine !== 'Unknown' ? ` (${currentDishData.cuisine})` : ''}`,
                url: window.location.href
            };

            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.log('Share cancelled');
                }
            } else {
                // Fallback: copy to clipboard
                const text = `${shareData.title}\n${shareData.text}\n${shareData.url}`;
                await navigator.clipboard.writeText(text);
                alert('Link copied to clipboard! Share it with your friends.');
            }
        });

        // Add to Today's Log button
        document.getElementById('addToLogBtn').addEventListener('click', async () => {
            // Check if user is logged in
            if (!currentUser) {
                showSignupPrompt('calorie-log');
                return;
            }
            if (!currentDishData || !currentDishData.nutrition) return;
            
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            
            try {
                await addToCalorieLog(currentDishData);
                const addToLogBtn = document.getElementById('addToLogBtn');
                if (addToLogBtn) {
                    addToLogBtn.textContent = ' Added!';
                    addToLogBtn.disabled = true;
                    setTimeout(() => {
                        addToLogBtn.textContent = ' Add to Today\'s Log';
                        addToLogBtn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Error adding to log:', error);
                alert(t.addToLogError || 'Failed to add to log. Please try again.');
            }
        });

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        function initializeAuth() {
            const loginBtn = document.getElementById('loginBtn');
            const premiumBtn = document.getElementById('premiumBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const closeModal = document.getElementById('closeModal');
            const closePremiumModal = document.getElementById('closePremiumModal');
            const loginModal = document.getElementById('loginModal');
            const premiumModal = document.getElementById('premiumModal');
            const modalTitle = document.getElementById('modalTitle');
            const emailLoginForm = document.getElementById('emailLoginForm');
            const emailSignupForm = document.getElementById('emailSignupForm');
            const switchToSignup = document.getElementById('switchToSignup');
            const switchToLogin = document.getElementById('switchToLogin');
            const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
            
            // Premium button click handler
            if (premiumBtn) {
                premiumBtn.addEventListener('click', () => {
                    if (premiumModal) {
                        premiumModal.classList.add('active');
                    }
                });
            }
            
            // Close premium modal
            if (closePremiumModal) {
                closePremiumModal.addEventListener('click', () => {
                    if (premiumModal) {
                        premiumModal.classList.remove('active');
                    }
                });
            }
            
            // Close premium modal on overlay click
            if (premiumModal) {
                premiumModal.addEventListener('click', (e) => {
                    if (e.target === premiumModal) {
                        premiumModal.classList.remove('active');
                    }
                });
            }
            
            // Subscribe button handler
            const subscribePremiumBtn = document.getElementById('subscribePremiumBtn');
            if (subscribePremiumBtn) {
                subscribePremiumBtn.addEventListener('click', () => {
                    handlePremiumSubscribe();
                });
            }
            
            // Check premium status button
            const checkPremiumStatusBtn = document.getElementById('checkPremiumStatusBtn');
            if (checkPremiumStatusBtn) {
                checkPremiumStatusBtn.addEventListener('click', () => {
                    checkPremiumStatus();
                });
            }

            // Open modal (show login form by default)
            loginBtn.addEventListener('click', () => {
                showLoginForm();
                loginModal.classList.add('active');
            });

            // Close modal
            closeModal.addEventListener('click', () => {
                loginModal.classList.remove('active');
                clearErrors();
            });

            loginModal.addEventListener('click', (e) => {
                if (e.target === loginModal) {
                    loginModal.classList.remove('active');
                    clearErrors();
                }
            });

            // Toggle between login and signup forms
            switchToSignup.addEventListener('click', () => {
                showSignupForm();
            });

            switchToLogin.addEventListener('click', () => {
                showLoginForm();
            });

            // Email/Password Login
            emailLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await loginEmail();
            });

            // Forgot Password
            forgotPasswordBtn.addEventListener('click', async () => {
                const email = document.getElementById('loginEmail').value.trim();
                if (!email) {
                    alert('Please enter your email address first.');
                    return;
                }
                await resetPassword(email);
            });

            // Email/Password Signup
            emailSignupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nickname = document.getElementById('signupNickname').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;
                await signUpEmail(email, password, nickname);
            });

            // Logout
            logoutBtn.addEventListener('click', async () => {
                await logout();
            });
        }

        function showLoginForm() {
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('modalTitle').textContent = t.login || 'Login';
            clearErrors();
            // Re-apply translations to update form labels
            applyTranslations(lang);
        }

        function showSignupForm() {
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('modalTitle').textContent = t.signupTitle || 'Sign Up';
            clearErrors();
            // Re-apply translations to update form labels
            applyTranslations(lang);
        }

        function clearErrors() {
            document.getElementById('loginError').textContent = '';
            document.getElementById('signupError').textContent = '';
        }

        function getErrorMessage(error) {
            // Supabase error codes are different from Firebase
            if (!error) return 'An error occurred. Please try again.';
            
            const errorMessage = error.message || error.error_description || '';
            const errorCode = error.code || error.status || '';
            
            if (errorMessage.includes('Invalid login credentials')) {
                return 'Invalid email or password.';
            }
            if (errorMessage.includes('User already registered')) {
                return 'This email is already registered.';
            }
            if (errorCode === 400 || errorMessage.includes('Bad Request')) {
                return 'Invalid request. Please check your input.';
            }
            if (errorCode === 401 || errorMessage.includes('Unauthorized')) {
                return 'Authentication failed. Please try again.';
            }
            
            return errorMessage || 'An error occurred. Please try again.';
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function loadDishFromHistory(name) {
            const history = JSON.parse(localStorage.getItem('biteSightHistory') || '[]');
            const historyItem = history.find(item => item.name === name);
            
            if (!historyItem) {
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                alert(t.historyItemNotFound || 'History item not found.');
                return;
            }
            
            // Restore the complete dish data (with fallbacks for old history items)
            currentDishData = {
                name: historyItem.name || '',
                nameKorean: historyItem.nameKorean || '',
                isKorean: historyItem.isKorean || false,
                cuisine: historyItem.cuisine || '',
                confidence: historyItem.confidence || 0.5,
                description: historyItem.description || '',
                alternatives: historyItem.alternatives || []
            };
            
            // Restore the image (use imageSrc if available, otherwise fallback to thumbnail)
            const dishImage = document.getElementById('dishImage');
            if (dishImage) {
                dishImage.src = historyItem.imageSrc || historyItem.thumbnail || '';
            }
            
            // Display the result exactly as it was
            displayResult(currentDishData);
            
            // Setup recipe links
            setupRecipeLinks(currentDishData.name);
            
            // Switch to discover tab to show the result
            switchTab('discover');
        }
        
        function loadDishFromFavorites(name) {
            const favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            const favoriteItem = favorites.find(item => item.name === name);
            
            if (!favoriteItem) {
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                alert(t.favoriteItemNotFound || 'Favorite item not found.');
                return;
            }
            
            // Restore the complete dish data (with fallbacks for old favorite items)
            currentDishData = {
                name: favoriteItem.name || '',
                nameKorean: favoriteItem.nameKorean || '',
                isKorean: favoriteItem.isKorean || false,
                cuisine: favoriteItem.cuisine || '',
                confidence: favoriteItem.confidence || 0.5,
                description: favoriteItem.description || '',
                alternatives: favoriteItem.alternatives || []
            };
            
            // Restore the image (use imageSrc if available, otherwise fallback to thumbnail)
            const dishImage = document.getElementById('dishImage');
            if (dishImage) {
                dishImage.src = favoriteItem.imageSrc || favoriteItem.thumbnail || '';
            }
            
            // Display the result exactly as it was
            displayResult(currentDishData);
            
            // Setup recipe links
            setupRecipeLinks(currentDishData.name);
            
            // Switch to discover tab to show the result
            switchTab('discover');
        }
    </script>
</body>
</html>
