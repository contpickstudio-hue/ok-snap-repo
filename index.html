<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Ok Snap - Discover Food Through Your Lens</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+KR:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Design System Color Palette */
            --primary: #7A9163;
            --secondary: #E6E2D3;
            --accent: #D4CBBE;
            --background: #FFFFFF;
            --text-primary: #2F2F2F;
            --text-secondary: #777777;
            --text-link: #7A9163;
            --status-success: #7A9163;
            --status-warning: #E4C46A;
            --status-error: #E97A7A;
            
            /* Legacy support */
            --bg: #FFFFFF;
            --surface: #FFFFFF;
            --text: #2F2F2F;
            --text-light: #777777;
            --border: #E6E2D3;
            --success: #7A9163;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-lg: rgba(0, 0, 0, 0.12);
        }

        :root[data-theme="dark"] {
            --primary: #7A9163;
            --secondary: #3A3A3A;
            --accent: #4A4A4A;
            --background: #1E1E1E;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --text-link: #9AB87A;
            --bg: #1E1E1E;
            --surface: #2A2A2A;
            --text: #FFFFFF;
            --text-light: #B0B0B0;
            --border: #3A3A3A;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-lg: rgba(0, 0, 0, 0.5);
        }

        html {
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            transition: background 200ms ease-in-out;
            font-size: 1rem;
            font-weight: 400;
            overflow-x: hidden;
            position: relative;
            padding-bottom: env(safe-area-inset-bottom);
        }

        [data-theme="dark"] body {
            background: #1E1E1E;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 16px;
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
            display: flex;
            flex-direction: column;
            gap: 24px;
            width: 100%;
            box-sizing: border-box;
        }

        header {
            background: var(--background);
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: all 200ms ease-in-out;
            width: 100%;
            box-sizing: border-box;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
        }

        .app-logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .monogram-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, #9AB87A 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: -1px;
            box-shadow: 0 2px 8px rgba(122, 145, 99, 0.3);
            flex-shrink: 0;
        }

        .auth-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .login-btn {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 16px;
            min-height: 44px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 400;
            font-size: 0.875rem;
            transition: all 200ms ease-in-out;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .login-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(122, 145, 99, 0.1);
        }

        .language-toggle {
            background: transparent;
            border: 1px solid var(--border);
            padding: 10px 12px;
            min-height: 44px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: all 200ms ease-in-out;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .language-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .hero-card {
            background: var(--background);
            border-radius: 24px;
            padding: 32px 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            animation: fadeInUp 300ms ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-section {
            width: 100%;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 48px 24px;
            min-height: 200px;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            background: var(--secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            width: 100%;
            box-sizing: border-box;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: var(--accent);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: var(--accent);
            transform: scale(1.01);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.7;
            color: var(--text-secondary);
        }

        .upload-text {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        #fileInput {
            display: none;
        }

        .upload-options {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .camera-btn {
            background: var(--secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 12px 24px;
            min-height: 44px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 400;
            font-size: 0.875rem;
            transition: all 200ms ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            flex: 1;
        }

        .camera-btn:hover {
            background: var(--accent);
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .camera-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Camera Modal */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-container {
            position: relative;
            width: 90%;
            max-width: 600px;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #cameraVideo {
            width: 100%;
            display: block;
            max-height: 80vh;
            object-fit: contain;
        }

        .camera-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding: 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            align-items: center;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 5px solid white;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
        }

        .capture-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 255, 255, 0.5);
        }

        .capture-btn:active {
            transform: scale(0.95);
        }

        .capture-btn::after {
            content: '';
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
        }

        .camera-close-btn, .camera-flip-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 0.8rem 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .camera-close-btn:hover, .camera-flip-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .camera-error {
            color: white;
            text-align: center;
            padding: 2rem;
        }

        .camera-error h3 {
            margin-bottom: 1rem;
        }

        #previewContainer {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .preview-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .remove-preview {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .remove-preview:hover {
            background: rgba(211, 47, 47, 0.9);
            transform: scale(1.1);
        }

        #uploadPlaceholder {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 32px;
            min-height: 44px;
            font-size: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(122, 145, 99, 0.2);
            margin-top: 8px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(122, 145, 99, 0.3);
            opacity: 0.95;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            display: none;
            background: var(--surface);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            animation: fadeInUp 300ms ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .result-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .confidence-badge {
            background: var(--status-success);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 400;
            font-size: 0.875rem;
        }

        .confidence-badge.medium {
            background: var(--status-warning);
        }

        .confidence-badge.low {
            background: var(--status-error);
        }

        .dish-image {
            width: 100%;
            max-width: 100%;
            border-radius: 16px;
            margin: 0 auto 16px;
            display: block;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .dish-description {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding: 16px;
            background: var(--secondary);
            border-radius: 12px;
        }

        .alternatives {
            margin: 2rem 0;
        }

        .alternatives-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .alternative-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .chip {
            background: var(--secondary);
            padding: 10px 16px;
            min-height: 44px;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 200ms ease-in-out;
            font-size: 0.875rem;
            color: var(--text-primary);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: inline-flex;
            align-items: center;
        }

        .chip:hover {
            border-color: var(--primary);
            background: var(--accent);
            transform: scale(1.02);
        }

        .recipe-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .recipe-links {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .recipe-link {
            display: inline-flex;
            align-items: center;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            padding: 0.875rem 1rem;
            min-height: 44px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            transition: all 200ms ease-in-out;
            background: var(--background);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            width: 100%;
            justify-content: space-between;
        }

        .recipe-link:hover {
            color: var(--text-link);
            background: var(--secondary);
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(122, 145, 99, 0.15);
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            width: 100%;
        }

        .action-buttons .btn-secondary {
            min-width: 0;
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 12px 24px;
            min-height: 44px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            font-weight: 400;
            font-size: 0.875rem;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.02);
        }

        .btn-secondary.active {
            background: var(--primary);
            color: white;
        }

        /* Bottom Navigation */
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 420px;
            background: var(--background);
            border-top: 1px solid var(--border);
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px 0;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            z-index: 100;
            box-sizing: border-box;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 16px;
            min-height: 44px;
            min-width: 44px;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            border: none;
            background: transparent;
            color: #A0A0A0;
            font-size: 0.75rem;
            font-weight: 400;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            flex: 1;
        }

        .nav-item:hover {
            color: var(--primary);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            stroke-width: 1.5;
        }

        .nav-item.active svg {
            stroke-width: 2;
        }

        .tab-content {
            display: none;
            padding-bottom: calc(80px + env(safe-area-inset-bottom)); /* Space for bottom navigation + safe area */
        }

        .tab-content.active {
            display: block;
        }

        /* Feature Row */
        .feature-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 16px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .feature-item svg {
            width: 16px;
            height: 16px;
            color: var(--primary);
        }

        .history-section, .favorites-section, .settings-section {
            background: var(--surface);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .settings-section {
            max-width: 100%;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .settings-label h3 {
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 600;
        }

        .settings-label p {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            min-width: 50px;
            flex-shrink: 0;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .language-select {
            padding: 0.6rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }

        .version-info {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-grid, .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.5rem;
        }

        .history-item, .favorite-item {
            background: var(--secondary);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 200ms ease-in-out;
            border: 1px solid var(--border);
        }

        .history-item:hover, .favorite-item:hover {
            border-color: var(--primary);
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(122, 145, 99, 0.15);
        }

        .item-thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .item-name {
            font-weight: 400;
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 4px;
        }

        .item-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.3;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.875rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(233, 122, 122, 0.1);
            border-left: 3px solid var(--status-error);
            padding: 16px;
            border-radius: 8px;
            color: var(--status-error);
            margin: 16px 0;
            font-size: 0.875rem;
        }

        .warm-message {
            background: var(--secondary);
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            border-left: 3px solid var(--primary);
            font-style: italic;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        /* Login Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: 24px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            animation: slideUp 200ms ease-in-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: var(--bg);
            color: var(--text);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 400;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            min-height: 44px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 200ms ease-in-out;
            background: var(--background);
            color: var(--text-primary);
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
            touch-action: manipulation;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(122, 145, 99, 0.1);
        }

        .auth-divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
            color: var(--text-light);
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .auth-divider::before {
            left: 0;
        }

        .auth-divider::after {
            right: 0;
        }

        .google-btn {
            width: 100%;
            background: var(--background);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 14px 20px;
            min-height: 44px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 400;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 200ms ease-in-out;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            margin-top: 1rem;
        }

        .google-btn:hover {
            border-color: var(--primary);
            background: var(--secondary);
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .error-text {
            color: var(--primary);
            font-size: 0.85rem;
            margin-top: -0.5rem;
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .auth-switch a {
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                gap: 20px;
            }

            header {
                padding: 14px 16px;
                padding-top: max(14px, env(safe-area-inset-top));
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }

            .header-content {
                gap: 12px;
            }

            .app-logo {
                font-size: 1.25rem;
                gap: 8px;
            }

            .monogram-logo {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .auth-section {
                gap: 6px;
            }

            .login-btn, .language-toggle {
                padding: 10px 14px;
                font-size: 0.813rem;
            }

            .hero-card {
                padding: 24px 20px;
                border-radius: 20px;
                gap: 20px;
            }

            .upload-section {
                padding: 0;
                width: 100%;
            }

            .upload-area {
                padding: 40px 20px;
                min-height: 180px;
                border-radius: 16px;
            }

            .upload-icon {
                width: 56px;
                height: 56px;
            }

            .upload-text {
                font-size: 1.25rem;
                margin-bottom: 6px;
            }

            .upload-hint {
                font-size: 0.813rem;
            }

            .upload-options {
                flex-direction: column;
                gap: 12px;
                width: 100%;
            }

            .camera-btn, .btn {
                width: 100%;
                font-size: 0.938rem;
            }

            .result-section {
                padding: 20px;
                border-radius: 20px;
                margin-bottom: 20px;
            }

            .result-header {
                flex-wrap: wrap;
                gap: 12px;
                margin-bottom: 16px;
                padding-bottom: 12px;
            }

            .result-title {
                font-size: 1.25rem;
                line-height: 1.4;
            }

            .confidence-badge {
                font-size: 0.813rem;
                padding: 6px 10px;
            }

            .dish-image {
                border-radius: 16px;
                margin-bottom: 16px;
                max-height: 300px;
                object-fit: contain;
            }

            .dish-description {
                font-size: 0.938rem;
                padding: 16px;
                line-height: 1.6;
                margin-bottom: 16px;
            }

            .recipe-section {
                margin-top: 20px;
                padding-top: 20px;
            }

            .recipe-links {
                gap: 0.75rem;
            }

            .recipe-link {
                padding: 12px 16px;
                font-size: 0.938rem;
            }

            .action-buttons {
                gap: 12px;
                flex-direction: column;
            }

            .action-buttons .btn-secondary {
                width: 100%;
            }

            .history-section, .favorites-section, .settings-section {
                padding: 20px;
                border-radius: 20px;
                margin-bottom: 20px;
            }

            .history-grid, .favorites-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 12px;
            }

            .history-item, .favorite-item {
                min-height: 120px;
            }

            .modal {
                padding: 24px 20px;
                max-width: 90%;
                margin: 20px;
                border-radius: 20px;
            }

            .modal-header {
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 18px;
            }

            .form-input {
                padding: 12px 16px;
                font-size: 1rem;
                min-height: 44px;
            }

            .google-btn {
                padding: 14px 20px;
                min-height: 44px;
                font-size: 0.938rem;
            }

            .camera-container {
                width: 100%;
                max-width: 100%;
                border-radius: 0;
            }

            .camera-controls {
                padding: 20px 16px;
                padding-bottom: max(20px, calc(16px + env(safe-area-inset-bottom)));
            }

            .capture-btn {
                width: 64px;
                height: 64px;
                min-height: 64px;
            }

            .capture-btn::after {
                width: 44px;
                height: 44px;
            }

            .camera-close-btn, .camera-flip-btn {
                padding: 10px 16px;
                min-height: 44px;
                font-size: 0.875rem;
            }

            .feature-row {
                flex-wrap: wrap;
                gap: 12px;
                padding: 12px 16px;
                font-size: 0.813rem;
            }

            .bottom-navigation {
                padding: 10px 0;
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }

            .nav-item {
                padding: 8px 12px;
                font-size: 0.688rem;
                min-height: 48px;
            }

            .nav-item svg {
                width: 22px;
                height: 22px;
            }

            .settings-item {
                padding: 1.25rem 0;
            }

            .settings-label h3 {
                font-size: 1rem;
            }

            .settings-label p {
                font-size: 0.813rem;
            }
        }

        /* Small Phone Optimizations */
        @media (max-width: 480px) {
            .container {
                padding: 12px;
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
                gap: 16px;
            }

            header {
                padding: 12px;
                padding-top: max(12px, env(safe-area-inset-top));
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
            }

            .app-logo {
                font-size: 1.125rem;
                gap: 6px;
            }

            .monogram-logo {
                width: 32px;
                height: 32px;
                font-size: 0.938rem;
            }

            .auth-section {
                gap: 4px;
            }

            .login-btn, .language-toggle {
                padding: 8px 12px;
                font-size: 0.75rem;
                min-height: 40px;
            }

            .hero-card {
                padding: 20px 16px;
                border-radius: 16px;
                gap: 16px;
            }

            .upload-area {
                padding: 32px 16px;
                min-height: 160px;
                border-radius: 12px;
            }

            .upload-icon {
                width: 48px;
                height: 48px;
                margin-bottom: 12px;
            }

            .upload-text {
                font-size: 1.125rem;
                margin-bottom: 4px;
            }

            .upload-hint {
                font-size: 0.75rem;
                line-height: 1.5;
            }

            .btn {
                padding: 12px 24px;
                font-size: 0.938rem;
                width: 100%;
            }

            .camera-btn {
                padding: 12px 20px;
                font-size: 0.875rem;
            }

            .result-section {
                padding: 16px;
                border-radius: 16px;
                margin-bottom: 16px;
            }

            .result-title {
                font-size: 1.125rem;
            }

            .confidence-badge {
                font-size: 0.75rem;
                padding: 5px 8px;
            }

            .dish-image {
                border-radius: 12px;
                margin-bottom: 12px;
                max-height: 250px;
            }

            .dish-description {
                font-size: 0.875rem;
                padding: 14px;
                margin-bottom: 12px;
            }

            .alternatives-title {
                font-size: 0.938rem;
                margin-bottom: 10px;
            }

            .chip {
                padding: 8px 14px;
                font-size: 0.813rem;
                min-height: 40px;
            }

            .recipe-section {
                margin-top: 16px;
                padding-top: 16px;
            }

            .recipe-links {
                gap: 0.625rem;
            }

            .recipe-link {
                padding: 10px 14px;
                font-size: 0.875rem;
                min-height: 40px;
            }

            .action-buttons {
                gap: 10px;
                margin-top: 1.25rem;
            }

            .btn-secondary {
                padding: 12px 20px;
                font-size: 0.875rem;
            }

            .history-section, .favorites-section, .settings-section {
                padding: 16px;
                border-radius: 16px;
                margin-bottom: 16px;
            }

            .history-grid, .favorites-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 10px;
            }

            .history-item, .favorite-item {
                min-height: 110px;
                border-radius: 12px;
                padding: 10px;
            }

            .item-name {
                font-size: 0.813rem;
            }

            .item-time {
                font-size: 0.688rem;
            }

            .modal {
                padding: 20px 16px;
                max-width: 95%;
                margin: 16px;
                border-radius: 16px;
            }

            .modal-title {
                font-size: 1.25rem;
            }

            .form-input {
                padding: 12px 14px;
                font-size: 0.938rem;
            }

            .google-btn {
                padding: 12px 16px;
                font-size: 0.875rem;
            }

            .camera-controls {
                padding: 16px;
                padding-bottom: max(16px, calc(16px + env(safe-area-inset-bottom)));
                gap: 0.75rem;
            }

            .capture-btn {
                width: 60px;
                height: 60px;
                min-height: 60px;
            }

            .capture-btn::after {
                width: 40px;
                height: 40px;
            }

            .camera-close-btn, .camera-flip-btn {
                padding: 8px 14px;
                font-size: 0.813rem;
                min-height: 40px;
            }

            .feature-row {
                gap: 10px;
                padding: 10px 12px;
                font-size: 0.75rem;
            }

            .bottom-navigation {
                padding: 8px 0;
                padding-bottom: max(8px, env(safe-area-inset-bottom));
            }

            .nav-item {
                padding: 6px 8px;
                font-size: 0.625rem;
                min-height: 44px;
                gap: 3px;
            }

            .nav-item svg {
                width: 20px;
                height: 20px;
            }

            .settings-item {
                padding: 1rem 0;
            }

            .settings-label h3 {
                font-size: 0.938rem;
            }

            .settings-label p {
                font-size: 0.75rem;
            }

            .toggle-switch {
                width: 46px;
                height: 26px;
            }

            .section-title {
                font-size: 1.125rem;
            }

            .warm-message {
                padding: 14px 16px;
                border-radius: 12px;
                font-size: 0.875rem;
            }
        }

        /* Ensure images never overflow */
        img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .preview-image, .dish-image {
            max-width: 100%;
            width: 100%;
            height: auto;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="app-logo">
                <div class="monogram-logo">OS</div>
                <span>Ok Snap</span>
            </div>
            <div class="auth-section" id="authSection">
                <select class="language-toggle" id="languageSelectHeader">
                    <option value="en">EN</option>
                    <option value="ko">KO</option>
                    <option value="es">ES</option>
                    <option value="fr">FR</option>
                    <option value="zh">ZH</option>
                </select>
                <div class="user-profile" id="userProfile" style="display: none;">
                    <img class="user-avatar" id="userAvatar" alt="User">
                    <span class="user-name" id="userName"></span>
                    <button class="login-btn" id="logoutBtn" style="display: none;">Logout</button>
                </div>
                <button class="login-btn" id="loginBtn">Login</button>
            </div>
        </div>
    </header>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Login</h2>
                <button class="close-modal" id="closeModal">×</button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <form class="auth-form" id="emailLoginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" required placeholder="••••••••">
                    </div>
                    <div class="error-text" id="loginError"></div>
                    <button type="submit" class="btn" id="loginSubmitBtn">Login</button>
                </form>
                
                <div class="auth-divider">or</div>
                
                <button class="google-btn" id="googleLoginBtn">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span id="googleLoginBtnText">Continue with Google</span>
                </button>
                
                <div class="auth-switch">
                    Don't have an account? <a id="showSignup">Sign up</a>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <form class="auth-form" id="emailSignupForm">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" id="signupName" required placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="signupPassword" required placeholder="••••••••" minlength="6">
                    </div>
                    <div class="error-text" id="signupError"></div>
                    <button type="submit" class="btn" id="signupSubmitBtn">Sign Up</button>
                </form>
                
                <div class="auth-divider">or</div>
                
                <button class="google-btn" id="googleSignupBtn">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span id="googleSignupBtnText">Continue with Google</span>
                </button>
                
                <div class="auth-switch">
                    Already have an account? <a id="showLogin">Login</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- Discover Tab -->
        <div class="tab-content active" id="discoverTab">
            <!-- Hero Card -->
            <div class="hero-card">
                <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div id="previewContainer" style="display: none;" onclick="event.stopPropagation()">
                        <img id="previewImage" class="preview-image" alt="Preview">
                        <button type="button" class="remove-preview" id="removePreview" title="Remove image">×</button>
                    </div>
                    <div id="uploadPlaceholder">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <div class="upload-text" id="uploadText">Upload a photo of food</div>
                        <div class="upload-hint" id="uploadHint">Drag and drop or click to browse • Korean dishes emphasized</div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                <div class="upload-options">
                    <button class="btn" id="analyzeBtn" disabled>Discover Your Dish</button>
                    <button class="camera-btn" id="cameraBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        <span id="cameraBtnText">Use Camera</span>
                    </button>
                </div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="analyzingText" style="color: var(--text-light); font-size: 1.1rem;">Analyzing your photo... This might take a moment.</p>
            </div>

            <!-- Result Section -->
            <div class="result-section" id="resultSection">
                <div class="result-header">
                    <h2 class="result-title" id="dishName"></h2>
                    <span class="confidence-badge" id="confidenceBadge"></span>
                </div>
                <img class="dish-image" id="dishImage" alt="Uploaded dish">
                <div class="dish-description" id="dishDescription"></div>
                <div class="alternatives" id="alternativesSection" style="display: none;">
                    <div class="alternatives-title" id="couldAlsoBe">Could also be:</div>
                    <div class="alternative-chips" id="alternativeChips"></div>
                </div>
                <div class="recipe-section">
                    <h3 id="readyToCook" style="margin-bottom: 1rem; color: var(--text);">Ready to cook?</h3>
                    <div class="recipe-links" id="recipeLinks">
                        <!-- Recipe links will be populated here -->
                    </div>
                    <div class="action-buttons">
                        <button class="btn-secondary" id="favoriteBtn">❤️ Save to Favorites</button>
                        <button class="btn-secondary" id="shareBtn">📤 Share Discovery</button>
                    </div>
                </div>
            </div>

            <!-- Warm Message (shown when user has history) -->
            <div class="warm-message" id="warmMessage" style="display: none;">
                <p id="warmMessageText"></p>
            </div>
            
            <!-- Feature Row -->
            <div class="feature-row">
                <div class="feature-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5"></path>
                        <path d="M2 12l10 5 10-5"></path>
                    </svg>
                    <span>Powered by AI</span>
                </div>
                <div class="feature-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <span>Korean Focus</span>
                </div>
                <div class="feature-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    <span>Cultural Stories</span>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="historyTab">
            <div class="history-section">
                <h2 class="section-title" id="recentDiscoveries">📜 Your Recent Discoveries</h2>
                <div class="history-grid" id="historyGrid">
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p id="historyEmpty">Your exploration history will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Favorites Tab -->
        <div class="tab-content" id="favoritesTab">
            <div class="favorites-section">
                <h2 class="section-title" id="favoriteDishes">⭐ Your Favorite Dishes</h2>
                <div class="favorites-grid" id="favoritesGrid">
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <p id="favoritesEmpty">Save dishes you love to revisit them later</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settingsTab">
            <div class="settings-section">
                <h2 class="section-title" id="settingsTitle">⚙️ Settings</h2>
                
                <!-- Night Mode Toggle -->
                <div class="settings-item">
                    <div class="settings-label">
                        <h3 id="nightModeLabel">Night Mode</h3>
                        <p id="nightModeDesc">Toggle dark theme for better viewing in low light</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="nightModeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Language Selection -->
                <div class="settings-item">
                    <div class="settings-label">
                        <h3 id="languageLabel">Language</h3>
                        <p id="languageDesc">Choose your preferred language</p>
                    </div>
                    <select class="language-select" id="languageSelect">
                        <option value="en">English</option>
                        <option value="ko">한국어 (Korean)</option>
                        <option value="es">Español (Spanish)</option>
                        <option value="fr">Français (French)</option>
                        <option value="zh">中文 (Chinese)</option>
                    </select>
                </div>

                <!-- App Version -->
                <div class="settings-item">
                    <div class="settings-label">
                        <h3 id="appVersionLabel">App Version</h3>
                        <p id="appVersionDesc">Current version of BiteSight</p>
                    </div>
                    <div class="version-info" id="appVersion">1.0.0</div>
                </div>
            </div>
        </div>

        <!-- Camera Modal -->
        <div class="camera-modal" id="cameraModal">
            <div class="camera-container">
                <video id="cameraVideo" autoplay playsinline></video>
                <div class="camera-controls">
                    <button class="camera-close-btn" id="closeCameraBtn">Close</button>
                    <button class="capture-btn" id="captureBtn" title="Capture photo"></button>
                    <button class="camera-flip-btn" id="flipCameraBtn">Flip</button>
                </div>
                <div class="camera-error" id="cameraError" style="display: none;">
                    <h3 id="cameraAccessDeniedTitle">Camera Access Denied</h3>
                    <p id="cameraAccessDeniedMsg">Please allow camera access to use this feature.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-navigation">
        <button class="nav-item active" data-tab="discover" id="navDiscover">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <span id="navDiscoverText">Discover</span>
        </button>
        <button class="nav-item" data-tab="history" id="navHistory">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3h18v18H3zM9 9h6v6H9z"></path>
                <path d="M3 9h18M9 3v18"></path>
            </svg>
            <span id="navHistoryText">History</span>
        </button>
        <button class="nav-item" data-tab="favorites" id="navFavorites">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <span id="navFavoritesText">Favorites</span>
        </button>
        <button class="nav-item" data-tab="settings" id="navSettings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
            </svg>
            <span id="navSettingsText">Settings</span>
        </button>
    </nav>

    <script>
        // ============================================
        // CONFIGURATION - Add your API keys here
        // ============================================
        const CONFIG = {
            // Get your OpenAI API key from: https://platform.openai.com/api-keys
            OPENAI_API_KEY: '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',
            
            // Recipe links now point directly to recipe websites
            // No API keys needed - using direct website search URLs

            // Firebase Configuration
            // IMPORTANT: You need the WEB APP config, not the service account JSON!
            // Steps to get the correct config:
            // 1. Go to https://console.firebase.google.com/
            // 2. Select your project: ok-snap-4677f
            // 3. Click the gear icon > Project Settings
            // 4. Scroll down to "Your apps" section
            // 5. If you don't have a web app, click the </> icon to add one
            // 6. Copy the config object (it should look like: const firebaseConfig = { apiKey: "AIza...", ... })
            // 7. The apiKey should start with "AIza..." NOT be a private key!
            FIREBASE_CONFIG: {
                apiKey: "AIzaSyAVo4jOkM_oqxtY3Olb2GSybqXf3uPr3u0", // Should start with "AIza..." - get from Firebase Console web app config
                authDomain: "ok-snap-4677f.firebaseapp.com",
                projectId: "ok-snap-4677f",
                storageBucket: "ok-snap-4677f.firebasestorage.app",
                messagingSenderId: "504422705809",
                appId: "1:504422705809:web:73323caef150f839caed30" // This is different from projectId - get from Firebase Console
            }
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let currentImage = null;
        let currentDishData = null;
        let auth = null;
        let currentUser = null;
        let cameraStream = null;
        let facingMode = 'environment'; // 'user' for front, 'environment' for back

        // ============================================
        // FIREBASE INITIALIZATION
        // ============================================
        function initializeFirebase() {
            // Check if Firebase config is valid
            const config = CONFIG.FIREBASE_CONFIG;
            if (!config || !config.apiKey || config.apiKey.includes('YOUR_') || config.apiKey.includes('BEGIN PRIVATE KEY')) {
                console.warn('Firebase not configured correctly. Login features will not work.');
                console.warn('Please get your Firebase web app config from: https://console.firebase.google.com/');
                console.warn('The apiKey should start with "AIza..." not be a private key.');
                return false;
            }

            try {
                firebase.initializeApp(CONFIG.FIREBASE_CONFIG);
                auth = firebase.auth();
                
                // Test Firebase connection
                console.log('Firebase initialized successfully');
                console.log('Project:', config.projectId);
                
                // Listen for auth state changes
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    updateAuthUI();
                    if (user) {
                        console.log('User logged in:', user.email);
                    } else {
                        console.log('No user logged in');
                    }
                });
                
                // Test auth availability
                if (auth) {
                    console.log('Firebase Auth is ready');
                    console.log('✅ Firebase is configured correctly!');
                    console.log('You can now test login functionality.');
                }
                
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                console.error('Error details:', error.message);
                alert('Firebase configuration error. Please check your config values.\n\nError: ' + error.message);
                return false;
            }
        }

        // ============================================
        // AUTHENTICATION UI
        // ============================================
        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const userProfile = document.getElementById('userProfile');
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');
            const logoutBtn = document.getElementById('logoutBtn');

            if (currentUser) {
                loginBtn.style.display = 'none';
                userProfile.style.display = 'flex';
                userName.textContent = currentUser.displayName || currentUser.email || 'User';
                userAvatar.src = currentUser.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(userName.textContent) + '&background=d32f2f&color=fff';
                logoutBtn.style.display = 'block';
            } else {
                loginBtn.style.display = 'block';
                userProfile.style.display = 'none';
            }
        }

        // ============================================
        // BOTTOM NAVIGATION
        // ============================================
        function switchTab(tabName) {
            const navItems = document.querySelectorAll('.nav-item');
            const tabContents = document.querySelectorAll('.tab-content');

            // Remove active class from all nav items and contents
            navItems.forEach(nav => nav.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to target nav item and corresponding content
            const targetNavItem = document.querySelector(`[data-tab="${tabName}"]`);
            const targetTabContent = document.getElementById(tabName + 'Tab');
            
            if (targetNavItem) targetNavItem.classList.add('active');
            if (targetTabContent) targetTabContent.classList.add('active');
        }

        function initializeTabs() {
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetTab = item.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });
        }

        // ============================================
        // TRANSLATIONS
        // ============================================
        const translations = {
            en: {
                // Header
                login: "Login",
                logout: "Logout",
                headerSubtitle: "Every meal has a story. Let's uncover the one in your photo.",
                headerSubtitleSmall: "Special expertise in Korean cuisine 🌶",
                
                // Tabs
                discover: "Discover",
                history: "History",
                favorites: "Favorites",
                settings: "Settings",
                
                // Upload Section
                uploadText: "Upload a photo of food",
                uploadHint: "Drag and drop or click to browse • Korean dishes emphasized",
                discoverDish: "Discover Your Dish",
                useCamera: "Use Camera",
                
                // Loading
                analyzing: "Analyzing your photo... This might take a moment.",
                
                // Results
                readyToCook: "Ready to cook?",
                viewRecipe: "View Recipe & Cultural Story →",
                saveToFavorites: "❤️ Save to Favorites",
                saved: "❤️ Saved!",
                shareDiscovery: "📤 Share Discovery",
                couldAlsoBe: "Could also be:",
                
                // History
                recentDiscoveries: "📜 Your Recent Discoveries",
                historyEmpty: "Your exploration history will appear here",
                
                // Favorites
                favoriteDishes: "⭐ Your Favorite Dishes",
                favoritesEmpty: "Save dishes you love to revisit them later",
                
                // Settings
                settingsTitle: "⚙️ Settings",
                nightMode: "Night Mode",
                nightModeDesc: "Toggle dark theme for better viewing in low light",
                language: "Language",
                languageDesc: "Choose your preferred language",
                appVersion: "App Version",
                appVersionDesc: "Current version of Ok Snap",
                
                // Auth
                signUp: "Sign Up",
                signupTitle: "Sign Up",
                dontHaveAccount: "Don't have an account?",
                alreadyHaveAccount: "Already have an account?",
                continueWithGoogle: "Continue with Google",
                or: "or",
                email: "Email",
                password: "Password",
                name: "Name",
                yourName: "Your name",
                
                // Camera
                close: "Close",
                flip: "Flip",
                cameraAccessDenied: "Camera Access Denied",
                cameraAccessDeniedMsg: "Please allow camera access to use this feature.",
                
                // Time
                justNow: "Just now",
                minutesAgo: "m ago",
                hoursAgo: "h ago",
                daysAgo: "d ago",
                
                // Errors and messages
                confident: "confident",
                couldNotRecognize: "I couldn't recognize any food in this image. Try another angle or make sure the food is clearly visible.",
                analysisError: "Unable to analyze the image. Please check your internet connection and try again.",
                apiError: "Unable to connect to the analysis service. Please check your internet connection and try again.",
                networkError: "Network error. Please check your internet connection and try again.",
                lowConfidenceMessage: "I'm not completely sure, but this could be <strong>${dishName}</strong>${cuisine ? ` — a ${cuisine} dish` : ''}. Which one looks closer to yours?",
                alternativeSelected: "You selected: ${alt}. This feature can be enhanced to search for this dish.",
                pleaseSelectImage: "Please select an image first.",
                apiKeyError: "Please configure your OpenAI API key in the CONFIG section of the code."
            },
            ko: {
                login: "로그인",
                logout: "로그아웃",
                headerSubtitle: "모든 식사에는 이야기가 있습니다. 사진 속 이야기를 찾아보세요.",
                headerSubtitleSmall: "한국 요리 전문 🌶",
                discover: "발견",
                history: "기록",
                favorites: "즐겨찾기",
                settings: "설정",
                uploadText: "음식 사진 업로드",
                uploadHint: "드래그 앤 드롭 또는 클릭하여 탐색 • 한국 요리 강조",
                discoverDish: "요리 발견하기",
                useCamera: "카메라 사용",
                analyzing: "사진을 분석하고 있습니다... 잠시만 기다려주세요.",
                readyToCook: "요리할 준비가 되셨나요?",
                viewRecipe: "레시피 및 문화 이야기 보기 →",
                saveToFavorites: "❤️ 즐겨찾기에 저장",
                saved: "❤️ 저장됨!",
                shareDiscovery: "📤 발견 공유하기",
                couldAlsoBe: "다음일 수도 있습니다:",
                recentDiscoveries: "📜 최근 발견",
                historyEmpty: "탐색 기록이 여기에 표시됩니다",
                favoriteDishes: "⭐ 즐겨찾기 요리",
                favoritesEmpty: "나중에 다시 볼 요리를 저장하세요",
                settingsTitle: "⚙️ 설정",
                nightMode: "다크 모드",
                nightModeDesc: "어두운 환경에서 더 나은 시야를 위해 다크 테마 전환",
                language: "언어",
                languageDesc: "원하는 언어를 선택하세요",
                appVersion: "앱 버전",
                appVersionDesc: "Ok Snap의 현재 버전",
                signUp: "회원가입",
                signupTitle: "회원가입",
                dontHaveAccount: "계정이 없으신가요?",
                alreadyHaveAccount: "이미 계정이 있으신가요?",
                continueWithGoogle: "Google로 계속하기",
                or: "또는",
                email: "이메일",
                password: "비밀번호",
                name: "이름",
                yourName: "이름을 입력하세요",
                close: "닫기",
                flip: "뒤집기",
                cameraAccessDenied: "카메라 접근 거부",
                cameraAccessDeniedMsg: "이 기능을 사용하려면 카메라 접근을 허용해주세요.",
                justNow: "방금 전",
                minutesAgo: "분 전",
                hoursAgo: "시간 전",
                daysAgo: "일 전",
                
                // Errors and messages
                confident: "확신",
                couldNotRecognize: "이 이미지에서 음식을 인식할 수 없습니다. 다른 각도로 시도하거나 음식이 명확하게 보이도록 해주세요.",
                analysisError: "이미지를 분석할 수 없습니다. 인터넷 연결을 확인하고 다시 시도해주세요.",
                apiError: "분석 서비스에 연결할 수 없습니다. 인터넷 연결을 확인하고 다시 시도해주세요.",
                networkError: "네트워크 오류가 발생했습니다. 인터넷 연결을 확인하고 다시 시도해주세요.",
                lowConfidenceMessage: "완전히 확신할 수는 없지만, 이것은 <strong>${dishName}</strong>${cuisine ? ` — ${cuisine} 요리` : ''}일 수 있습니다. 어떤 것이 더 가까워 보이나요?",
                alternativeSelected: "${alt}을(를) 선택하셨습니다. 이 기능은 향후 해당 요리를 검색하는 기능으로 개선될 수 있습니다.",
                pleaseSelectImage: "먼저 이미지를 선택해주세요.",
                apiKeyError: "CONFIG 섹션에서 OpenAI API 키를 설정해주세요."
            },
            es: {
                login: "Iniciar sesión",
                logout: "Cerrar sesión",
                headerSubtitle: "Cada comida tiene una historia. Descubramos la de tu foto.",
                headerSubtitleSmall: "Especialidad en cocina coreana 🌶",
                discover: "Descubrir",
                history: "Historial",
                favorites: "Favoritos",
                settings: "Configuración",
                uploadText: "Sube una foto de comida",
                uploadHint: "Arrastra y suelta o haz clic para navegar • Platos coreanos destacados",
                discoverDish: "Descubre Tu Plato",
                useCamera: "Usar Cámara",
                analyzing: "Analizando tu foto... Esto puede tomar un momento.",
                readyToCook: "¿Listo para cocinar?",
                viewRecipe: "Ver Receta e Historia Cultural →",
                saveToFavorites: "❤️ Guardar en Favoritos",
                saved: "❤️ ¡Guardado!",
                shareDiscovery: "📤 Compartir Descubrimiento",
                couldAlsoBe: "También podría ser:",
                recentDiscoveries: "📜 Tus Descubrimientos Recientes",
                historyEmpty: "Tu historial de exploración aparecerá aquí",
                favoriteDishes: "⭐ Tus Platos Favoritos",
                favoritesEmpty: "Guarda los platos que amas para volver a verlos más tarde",
                settingsTitle: "⚙️ Configuración",
                nightMode: "Modo Nocturno",
                nightModeDesc: "Activa el tema oscuro para una mejor visualización con poca luz",
                language: "Idioma",
                languageDesc: "Elige tu idioma preferido",
                appVersion: "Versión de la App",
                appVersionDesc: "Versión actual de Ok Snap",
                signUp: "Registrarse",
                signupTitle: "Registrarse",
                dontHaveAccount: "¿No tienes una cuenta?",
                alreadyHaveAccount: "¿Ya tienes una cuenta?",
                continueWithGoogle: "Continuar con Google",
                or: "o",
                email: "Correo electrónico",
                password: "Contraseña",
                name: "Nombre",
                yourName: "Tu nombre",
                close: "Cerrar",
                flip: "Voltear",
                cameraAccessDenied: "Acceso a la Cámara Denegado",
                cameraAccessDeniedMsg: "Por favor, permite el acceso a la cámara para usar esta función.",
                justNow: "Ahora mismo",
                minutesAgo: "hace min",
                hoursAgo: "hace h",
                daysAgo: "hace d",
                
                // Errors and messages
                confident: "confiado",
                couldNotRecognize: "No pude reconocer ninguna comida en esta imagen. Prueba con otro ángulo o asegúrate de que la comida sea claramente visible.",
                analysisError: "No se pudo analizar la imagen. Por favor, verifica tu conexión a internet e intenta de nuevo.",
                apiError: "No se pudo conectar al servicio de análisis. Por favor, verifica tu conexión a internet e intenta de nuevo.",
                networkError: "Error de red. Por favor, verifica tu conexión a internet e intenta de nuevo.",
                lowConfidenceMessage: "No estoy completamente seguro, pero esto podría ser <strong>${dishName}</strong>${cuisine ? ` — un plato ${cuisine}` : ''}. ¿Cuál se parece más al tuyo?",
                alternativeSelected: "Seleccionaste: ${alt}. Esta función se puede mejorar para buscar este plato.",
                pleaseSelectImage: "Por favor, selecciona una imagen primero.",
                apiKeyError: "Por favor, configura tu clave API de OpenAI en la sección CONFIG del código."
            },
            fr: {
                login: "Connexion",
                logout: "Déconnexion",
                headerSubtitle: "Chaque plat a une histoire. Découvrons celle de votre photo.",
                headerSubtitleSmall: "Expertise spéciale en cuisine coréenne 🌶",
                discover: "Découvrir",
                history: "Historique",
                favorites: "Favoris",
                settings: "Paramètres",
                uploadText: "Téléchargez une photo de nourriture",
                uploadHint: "Glissez-déposez ou cliquez pour parcourir • Plats coréens mis en avant",
                discoverDish: "Découvrir Votre Plat",
                useCamera: "Utiliser l'Appareil Photo",
                analyzing: "Analyse de votre photo... Cela peut prendre un moment.",
                readyToCook: "Prêt à cuisiner?",
                viewRecipe: "Voir la Recette et l'Histoire Culturelle →",
                saveToFavorites: "❤️ Enregistrer dans les Favoris",
                saved: "❤️ Enregistré!",
                shareDiscovery: "📤 Partager la Découverte",
                couldAlsoBe: "Pourrait aussi être:",
                recentDiscoveries: "📜 Vos Découvertes Récentes",
                historyEmpty: "Votre historique d'exploration apparaîtra ici",
                favoriteDishes: "⭐ Vos Plats Favoris",
                favoritesEmpty: "Enregistrez les plats que vous aimez pour les revoir plus tard",
                settingsTitle: "⚙️ Paramètres",
                nightMode: "Mode Nuit",
                nightModeDesc: "Activez le thème sombre pour une meilleure visualisation en basse lumière",
                language: "Langue",
                languageDesc: "Choisissez votre langue préférée",
                appVersion: "Version de l'App",
                appVersionDesc: "Version actuelle de Ok Snap",
                signUp: "S'inscrire",
                signupTitle: "S'inscrire",
                dontHaveAccount: "Vous n'avez pas de compte?",
                alreadyHaveAccount: "Vous avez déjà un compte?",
                continueWithGoogle: "Continuer avec Google",
                or: "ou",
                email: "E-mail",
                password: "Mot de passe",
                name: "Nom",
                yourName: "Votre nom",
                close: "Fermer",
                flip: "Retourner",
                cameraAccessDenied: "Accès à la Caméra Refusé",
                cameraAccessDeniedMsg: "Veuillez autoriser l'accès à la caméra pour utiliser cette fonctionnalité.",
                justNow: "À l'instant",
                minutesAgo: "il y a min",
                hoursAgo: "il y a h",
                daysAgo: "il y a j",
                
                // Errors and messages
                confident: "confiant",
                couldNotRecognize: "Je n'ai pas pu reconnaître de nourriture dans cette image. Essayez sous un autre angle ou assurez-vous que la nourriture soit clairement visible.",
                analysisError: "Impossible d'analyser l'image. Veuillez vérifier votre connexion Internet et réessayer.",
                apiError: "Impossible de se connecter au service d'analyse. Veuillez vérifier votre connexion Internet et réessayer.",
                networkError: "Erreur réseau. Veuillez vérifier votre connexion Internet et réessayer.",
                lowConfidenceMessage: "Je ne suis pas complètement sûr, mais cela pourrait être <strong>${dishName}</strong>${cuisine ? ` — un plat ${cuisine}` : ''}. Lequel ressemble le plus au vôtre ?",
                alternativeSelected: "Vous avez sélectionné : ${alt}. Cette fonctionnalité peut être améliorée pour rechercher ce plat.",
                pleaseSelectImage: "Veuillez d'abord sélectionner une image.",
                apiKeyError: "Veuillez configurer votre clé API OpenAI dans la section CONFIG du code."
            },
            zh: {
                login: "登录",
                logout: "退出",
                headerSubtitle: "每道菜都有一个故事。让我们发现您照片中的故事。",
                headerSubtitleSmall: "专精韩国料理 🌶",
                discover: "发现",
                history: "历史",
                favorites: "收藏",
                settings: "设置",
                uploadText: "上传食物照片",
                uploadHint: "拖放或点击浏览 • 突出韩国料理",
                discoverDish: "发现您的菜肴",
                useCamera: "使用相机",
                analyzing: "正在分析您的照片...这可能需要一点时间。",
                readyToCook: "准备做饭了吗？",
                viewRecipe: "查看食谱和文化故事 →",
                saveToFavorites: "❤️ 保存到收藏",
                saved: "❤️ 已保存！",
                shareDiscovery: "📤 分享发现",
                couldAlsoBe: "也可能是：",
                recentDiscoveries: "📜 您最近的发现",
                historyEmpty: "您的探索历史将显示在这里",
                favoriteDishes: "⭐ 您喜爱的菜肴",
                favoritesEmpty: "保存您喜欢的菜肴以便稍后查看",
                settingsTitle: "⚙️ 设置",
                nightMode: "夜间模式",
                nightModeDesc: "切换深色主题以便在弱光环境下更好地查看",
                language: "语言",
                languageDesc: "选择您的首选语言",
                appVersion: "应用版本",
                appVersionDesc: "Ok Snap的当前版本",
                signUp: "注册",
                signupTitle: "注册",
                dontHaveAccount: "没有账户？",
                alreadyHaveAccount: "已有账户？",
                continueWithGoogle: "使用Google继续",
                or: "或",
                email: "电子邮件",
                password: "密码",
                name: "姓名",
                yourName: "您的姓名",
                close: "关闭",
                flip: "翻转",
                cameraAccessDenied: "相机访问被拒绝",
                cameraAccessDeniedMsg: "请允许相机访问以使用此功能。",
                justNow: "刚刚",
                minutesAgo: "分钟前",
                hoursAgo: "小时前",
                daysAgo: "天前",
                
                // Errors and messages
                confident: "确信",
                couldNotRecognize: "我无法识别此图像中的任何食物。请尝试其他角度或确保食物清晰可见。",
                analysisError: "无法分析图像。请检查您的互联网连接并重试。",
                apiError: "无法连接到分析服务。请检查您的互联网连接并重试。",
                networkError: "网络错误。请检查您的互联网连接并重试。",
                lowConfidenceMessage: "我不完全确定，但这可能是 <strong>${dishName}</strong>${cuisine ? ` — 一道${cuisine}菜` : ''}。哪一个更接近您的？",
                alternativeSelected: "您选择了：${alt}。此功能可以增强以搜索此菜肴。",
                pleaseSelectImage: "请先选择一张图片。",
                apiKeyError: "请在代码的CONFIG部分配置您的OpenAI API密钥。"
            }
        };

        // ============================================
        // SETTINGS MANAGEMENT
        // ============================================
        function initializeSettings() {
            // Load saved settings
            let settings = JSON.parse(localStorage.getItem('biteSightSettings') || '{}');
            
            // Initialize night mode
            const nightModeToggle = document.getElementById('nightModeToggle');
            const isNightMode = settings.nightMode || false;
            nightModeToggle.checked = isNightMode;
            applyNightMode(isNightMode);

            nightModeToggle.addEventListener('change', (e) => {
                const isDark = e.target.checked;
                applyNightMode(isDark);
                settings.nightMode = isDark;
                saveSettings(settings);
            });

            // Initialize language
            const languageSelect = document.getElementById('languageSelect');
            const languageSelectHeader = document.getElementById('languageSelectHeader');
            const savedLanguage = settings.language || 'en';
            
            if (languageSelect) languageSelect.value = savedLanguage;
            if (languageSelectHeader) languageSelectHeader.value = savedLanguage;
            
            // Apply translations on load
            applyTranslations(savedLanguage);

            const handleLanguageChange = (newLanguage) => {
                settings.language = newLanguage;
                saveSettings(settings);
                applyTranslations(newLanguage);
                // Sync both selects
                if (languageSelect) languageSelect.value = newLanguage;
                if (languageSelectHeader) languageSelectHeader.value = newLanguage;
                // Reload history and favorites to update time formatting
                loadHistory();
                loadFavorites();
            };

            if (languageSelect) {
                languageSelect.addEventListener('change', (e) => {
                    handleLanguageChange(e.target.value);
                });
            }

            if (languageSelectHeader) {
                languageSelectHeader.addEventListener('change', (e) => {
                    handleLanguageChange(e.target.value);
                });
            }

            // Set app version
            document.getElementById('appVersion').textContent = '1.0.0';
        }

        function applyTranslations(lang) {
            const t = translations[lang] || translations.en;
            
            // Update header
            const headerSubtitle = document.getElementById('headerSubtitle');
            if (headerSubtitle) {
                headerSubtitle.innerHTML = t.headerSubtitle + ' <br><small id="headerSubtitleSmall" style="opacity: 0.9; font-size: 0.9em;">' + t.headerSubtitleSmall + '</small>';
            }
            
            // Update navigation items
            const navIds = ['navDiscoverText', 'navHistoryText', 'navFavoritesText', 'navSettingsText'];
            const navKeys = ['discover', 'history', 'favorites', 'settings'];
            navIds.forEach((id, index) => {
                const element = document.getElementById(id);
                if (element) element.textContent = t[navKeys[index]];
            });
            
            // Sync header language toggle
            const languageSelectHeader = document.getElementById('languageSelectHeader');
            const languageSelect = document.getElementById('languageSelect');
            if (languageSelectHeader && languageSelect) {
                languageSelectHeader.value = lang;
            }
            
            // Update login/logout buttons
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            if (loginBtn) loginBtn.textContent = t.login;
            if (logoutBtn) logoutBtn.textContent = t.logout;
            
            // Update upload section
            const uploadText = document.getElementById('uploadText');
            const uploadHint = document.getElementById('uploadHint');
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (uploadText) uploadText.textContent = t.uploadText;
            if (uploadHint) uploadHint.textContent = t.uploadHint;
            if (analyzeBtn) analyzeBtn.textContent = t.discoverDish;
            
            // Update camera button
            const cameraBtnText = document.getElementById('cameraBtnText');
            if (cameraBtnText) {
                cameraBtnText.textContent = t.useCamera;
            }
            
            // Update loading text
            const analyzingText = document.getElementById('analyzingText');
            if (analyzingText) analyzingText.textContent = t.analyzing;
            
            // Update result section
            const readyToCook = document.getElementById('readyToCook');
            const favoriteBtn = document.getElementById('favoriteBtn');
            const shareBtn = document.getElementById('shareBtn');
            const couldAlsoBe = document.getElementById('couldAlsoBe');
            if (readyToCook) readyToCook.textContent = t.readyToCook;
            if (favoriteBtn && !favoriteBtn.classList.contains('active')) favoriteBtn.textContent = t.saveToFavorites;
            if (shareBtn) shareBtn.textContent = t.shareDiscovery;
            if (couldAlsoBe) couldAlsoBe.textContent = t.couldAlsoBe;
            
            // Update history section
            const recentDiscoveries = document.getElementById('recentDiscoveries');
            const historyEmpty = document.getElementById('historyEmpty');
            if (recentDiscoveries) recentDiscoveries.textContent = t.recentDiscoveries;
            if (historyEmpty) historyEmpty.textContent = t.historyEmpty;
            
            // Update favorites section
            const favoriteDishes = document.getElementById('favoriteDishes');
            const favoritesEmpty = document.getElementById('favoritesEmpty');
            if (favoriteDishes) favoriteDishes.textContent = t.favoriteDishes;
            if (favoritesEmpty) favoritesEmpty.textContent = t.favoritesEmpty;
            
            // Update settings section
            const settingsTitle = document.getElementById('settingsTitle');
            const nightModeLabel = document.getElementById('nightModeLabel');
            const nightModeDesc = document.getElementById('nightModeDesc');
            const languageLabel = document.getElementById('languageLabel');
            const languageDesc = document.getElementById('languageDesc');
            const appVersionLabel = document.getElementById('appVersionLabel');
            const appVersionDesc = document.getElementById('appVersionDesc');
            if (settingsTitle) settingsTitle.textContent = t.settingsTitle;
            if (nightModeLabel) nightModeLabel.textContent = t.nightMode;
            if (nightModeDesc) nightModeDesc.textContent = t.nightModeDesc;
            if (languageLabel) languageLabel.textContent = t.language;
            if (languageDesc) languageDesc.textContent = t.languageDesc;
            if (appVersionLabel) appVersionLabel.textContent = t.appVersion;
            if (appVersionDesc) appVersionDesc.textContent = t.appVersionDesc;
            
            // Update camera modal
            const closeCameraBtn = document.getElementById('closeCameraBtn');
            const flipCameraBtn = document.getElementById('flipCameraBtn');
            const cameraAccessDeniedTitle = document.getElementById('cameraAccessDeniedTitle');
            const cameraAccessDeniedMsg = document.getElementById('cameraAccessDeniedMsg');
            if (closeCameraBtn) closeCameraBtn.textContent = t.close;
            if (flipCameraBtn) flipCameraBtn.textContent = t.flip;
            if (cameraAccessDeniedTitle) cameraAccessDeniedTitle.textContent = t.cameraAccessDenied;
            if (cameraAccessDeniedMsg) cameraAccessDeniedMsg.textContent = t.cameraAccessDeniedMsg;
            
            // Update auth modal (only if modal is open or update labels)
            const modalTitle = document.getElementById('modalTitle');
            if (modalTitle) {
                // Check current state
                const loginForm = document.getElementById('loginForm');
                const signupForm = document.getElementById('signupForm');
                if (loginForm && loginForm.style.display !== 'none') {
                    modalTitle.textContent = t.login;
                } else if (signupForm && signupForm.style.display !== 'none') {
                    modalTitle.textContent = t.signupTitle;
                }
            }
            
            // Update auth form labels and placeholders
            const emailLabels = document.querySelectorAll('.form-label');
            emailLabels.forEach(label => {
                const input = label.nextElementSibling || label.parentElement.querySelector('input');
                if (input) {
                    if (input.type === 'email') {
                        label.textContent = t.email;
                        input.placeholder = input.id.includes('login') ? 'your@email.com' : 'your@email.com';
                    } else if (input.type === 'password') {
                        label.textContent = t.password;
                        input.placeholder = '••••••••';
                    } else if (input.type === 'text' && input.id.includes('Name')) {
                        label.textContent = t.name;
                        input.placeholder = t.yourName;
                    }
                }
            });
            
            // Update auth buttons and links
            const showSignup = document.getElementById('showSignup');
            const showLogin = document.getElementById('showLogin');
            const loginSubmitBtn = document.getElementById('loginSubmitBtn');
            const signupSubmitBtn = document.getElementById('signupSubmitBtn');
            if (showSignup) showSignup.textContent = t.signUp;
            if (showLogin) showLogin.textContent = t.login;
            if (loginSubmitBtn) loginSubmitBtn.textContent = t.login;
            if (signupSubmitBtn) signupSubmitBtn.textContent = t.signUp;
            
            // Update Google buttons
            const googleLoginBtnText = document.getElementById('googleLoginBtnText');
            const googleSignupBtnText = document.getElementById('googleSignupBtnText');
            if (googleLoginBtnText) googleLoginBtnText.textContent = t.continueWithGoogle;
            if (googleSignupBtnText) googleSignupBtnText.textContent = t.continueWithGoogle;
            
            // Update auth dividers
            const authDividers = document.querySelectorAll('.auth-divider');
            authDividers.forEach(div => {
                div.textContent = t.or;
            });
            
            // Update auth switch text - preserve links with IDs
            const authSwitches = document.querySelectorAll('.auth-switch');
            authSwitches.forEach(switchEl => {
                const link = switchEl.querySelector('a');
                if (link && link.id === 'showSignup') {
                    // Login form switch
                    const textNode = Array.from(switchEl.childNodes).find(node => node.nodeType === 3);
                    if (textNode) {
                        textNode.textContent = t.dontHaveAccount + ' ';
                    }
                    link.textContent = t.signUp;
                } else if (link && link.id === 'showLogin') {
                    // Signup form switch
                    const textNode = Array.from(switchEl.childNodes).find(node => node.nodeType === 3);
                    if (textNode) {
                        textNode.textContent = t.alreadyHaveAccount + ' ';
                    }
                    link.textContent = t.login;
                }
            });
        }

        function applyNightMode(isDark) {
            const root = document.documentElement;
            if (isDark) {
                root.setAttribute('data-theme', 'dark');
            } else {
                root.removeAttribute('data-theme');
            }
        }

        function saveSettings(settings) {
            localStorage.setItem('biteSightSettings', JSON.stringify(settings));
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            initializeUpload();
            initializeCamera();
            initializeAuth();
            initializeTabs();
            initializeSettings();
            loadHistory();
            loadFavorites();
            
            // Handle remove preview button
            const removePreview = document.getElementById('removePreview');
            if (removePreview) {
                removePreview.addEventListener('click', (e) => {
                    e.stopPropagation();
                    resetUpload();
                });
            }
        });

        // ============================================
        // UPLOAD HANDLING
        // ============================================
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const analyzeBtn = document.getElementById('analyzeBtn');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            analyzeBtn.addEventListener('click', analyzeImage);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file.');
                return;
            }

            currentImage = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                // Show preview in upload area
                const previewContainer = document.getElementById('previewContainer');
                const previewImage = document.getElementById('previewImage');
                const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
                uploadPlaceholder.style.display = 'none';
                
                // Also set it for the result section (will be shown after analysis)
                document.getElementById('dishImage').src = e.target.result;
                
                document.getElementById('analyzeBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            currentImage = null;
            currentDishData = null;
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('uploadPlaceholder').style.display = 'flex';
            document.getElementById('fileInput').value = '';
            document.getElementById('analyzeBtn').disabled = true;
            hideResult();
        }

        // ============================================
        // CAMERA FUNCTIONALITY
        // ============================================
        function initializeCamera() {
            const cameraBtn = document.getElementById('cameraBtn');
            const closeCameraBtn = document.getElementById('closeCameraBtn');
            const captureBtn = document.getElementById('captureBtn');
            const flipCameraBtn = document.getElementById('flipCameraBtn');
            const cameraModal = document.getElementById('cameraModal');

            cameraBtn.addEventListener('click', openCamera);
            closeCameraBtn.addEventListener('click', closeCamera);
            captureBtn.addEventListener('click', capturePhoto);
            flipCameraBtn.addEventListener('click', flipCamera);
        }

        async function openCamera() {
            const cameraModal = document.getElementById('cameraModal');
            const cameraVideo = document.getElementById('cameraVideo');
            const cameraError = document.getElementById('cameraError');

            cameraModal.classList.add('active');
            cameraError.style.display = 'none';

            try {
                // Stop any existing stream
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }

                // Request camera access
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                cameraVideo.play();
            } catch (error) {
                console.error('Camera error:', error);
                cameraError.style.display = 'block';
                cameraVideo.style.display = 'none';
                
                let errorMessage = 'Unable to access camera. ';
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Please allow camera access in your browser settings.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on your device.';
                } else {
                    errorMessage += error.message;
                }
                cameraError.querySelector('p').textContent = errorMessage;
            }
        }

        function closeCamera() {
            const cameraModal = document.getElementById('cameraModal');
            cameraModal.classList.remove('active');

            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const cameraVideo = document.getElementById('cameraVideo');
            cameraVideo.srcObject = null;
        }

        function capturePhoto() {
            const cameraVideo = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            // Set canvas dimensions to match video
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;

            // Draw video frame to canvas
            context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);

            // Convert canvas to blob
            canvas.toBlob((blob) => {
                if (blob) {
                    // Create a File object from the blob
                    const file = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
                    
                    // Use the existing handleFile function
                    handleFile(file);
                    
                    // Close camera
                    closeCamera();
                }
            }, 'image/jpeg', 0.95);
        }

        async function flipCamera() {
            // Toggle between front and back camera
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            
            // Restart camera with new facing mode
            const cameraVideo = document.getElementById('cameraVideo');
            
            // Stop current stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            try {
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                cameraVideo.play();
            } catch (error) {
                console.error('Camera flip error:', error);
                // If flip fails, try to revert
                facingMode = facingMode === 'user' ? 'environment' : 'user';
            }
        }

        // ============================================
        // IMAGE ANALYSIS WITH OPENAI VISION
        // ============================================
        async function analyzeImage() {
            if (!currentImage) {
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                showError(t.pleaseSelectImage || 'Please select an image first.');
                return;
            }

            if (CONFIG.OPENAI_API_KEY === 'YOUR_OPENAI_API_KEY_HERE') {
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                showError(t.apiKeyError || 'Please configure your OpenAI API key in the CONFIG section of the code.');
                return;
            }

            showLoading(true);
            hideResult();

            try {
                // Get current language
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                
                // Language names for API
                const languageNames = {
                    'en': 'English',
                    'ko': 'Korean (한국어)',
                    'es': 'Spanish (Español)',
                    'fr': 'French (Français)',
                    'zh': 'Chinese (中文)'
                };
                
                const targetLanguage = languageNames[lang] || 'English';
                
                // Convert image to base64
                const base64Image = await fileToBase64(currentImage);

                // Call OpenAI Vision API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: `You are Ok Snap, a food recognition expert with special expertise in Korean cuisine. You identify dishes from all cuisines, but have deeper knowledge and cultural context for Korean food (Hansik).

IMPORTANT: Respond entirely in ${targetLanguage}. All text including dish names, descriptions, and messages must be in ${targetLanguage}.

Analyze images and identify ANY dish you see, with special emphasis and detail for Korean dishes. For Korean dishes, always include the Korean name (한글) even if responding in other languages.

Respond in valid JSON format only. Structure:
{
    "dish_detected": true/false,
    "is_korean": true/false,
    "dish_name": "Dish name in ${targetLanguage}",
    "dish_name_korean": "한글 name" or "",  // Always include if is_korean is true, otherwise empty string
    "cuisine": "Cuisine name in ${targetLanguage}",
    "confidence": 0.0-1.0,
    "description": "Beautiful, warm description in ${targetLanguage} with colors, textures, plating, cultural context. For Korean dishes, include cultural significance. Write like a friendly food guide, not robotic.",
    "alternatives": ["alt1 in ${targetLanguage}", "alt2 in ${targetLanguage}", "alt3 in ${targetLanguage}"] // only if confidence < 0.8
}

If no dish detected: {"dish_detected": false, "message": "Error message in ${targetLanguage}"}

Be culturally authentic, warm, and inspiring. Use light emojis occasionally (🌶, 🍚, 🥢, 🍲, 🍝, 🍜, 🍱).
All responses must be in ${targetLanguage}.`
                            },
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: `Analyze this image and identify the dish in ${targetLanguage}. If it's Korean food, provide extra cultural context and the Korean name (한글). Otherwise, identify the dish and its cuisine. Provide a detailed, warm description entirely in ${targetLanguage}.`
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: `data:${currentImage.type};base64,${base64Image}`
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const data = await response.json();
                let analysis;
                const rawContent = data.choices[0].message.content;
                
                try {
                    // Try to parse as JSON first
                    // Clean the content - remove markdown code blocks if present
                    let cleanedContent = rawContent.trim();
                    if (cleanedContent.startsWith('```json')) {
                        cleanedContent = cleanedContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    } else if (cleanedContent.startsWith('```')) {
                        cleanedContent = cleanedContent.replace(/```\n?/g, '').trim();
                    }
                    
                    analysis = JSON.parse(cleanedContent);
                } catch (e) {
                    // If not JSON, try to extract information from text
                    const content = rawContent;
                    // Look for any dish indicators in the text
                    if (content.toLowerCase().includes('dish') || content.toLowerCase().includes('food') || content.toLowerCase().includes('korean') || content.toLowerCase().includes('한국')) {
                        // Extract dish name
                        const dishMatch = content.match(/([A-Za-z\s]+)\s*\(?한국어|한글\)?/i) || content.match(/([A-Za-z\s]{3,})/);
                        const isKorean = content.toLowerCase().includes('korean') || content.toLowerCase().includes('한국');
                        analysis = {
                            dish_detected: true,
                            is_korean: isKorean,
                            dish_name: dishMatch ? dishMatch[1].trim() : 'Dish',
                            dish_name_korean: isKorean ? '' : '',
                            cuisine: isKorean ? 'Korean' : 'Unknown',
                            confidence: 0.7,
                            description: content.substring(0, 300) + '...',
                            alternatives: []
                        };
                    } else {
                        analysis = {
                            dish_detected: false,
                            message: "I couldn't recognize any food in this image. Try another angle or make sure the food is clearly visible."
                        };
                    }
                }

                if (!analysis.dish_detected) {
                    const errorMessage = analysis.message || t.couldNotRecognize || "I couldn't recognize any food in this image. Try another angle or make sure the food is clearly visible.";
                    showError(errorMessage);
                    showLoading(false);
                    return;
                }

                // Process the result - all text is already in user's language from API
                currentDishData = {
                    name: analysis.dish_name || (lang === 'ko' ? '알 수 없는 요리' : lang === 'es' ? 'Plato Desconocido' : lang === 'fr' ? 'Plat Inconnu' : lang === 'zh' ? '未知菜肴' : 'Unknown Dish'),
                    nameKorean: analysis.is_korean ? (analysis.dish_name_korean || '') : '',
                    isKorean: analysis.is_korean || false,
                    cuisine: analysis.cuisine || (lang === 'ko' ? '알 수 없음' : lang === 'es' ? 'Desconocido' : lang === 'fr' ? 'Inconnu' : lang === 'zh' ? '未知' : 'Unknown'),
                    confidence: analysis.confidence || 0.5,
                    description: analysis.description || (lang === 'ko' ? '발견을 기다리는 맛있는 요리.' : lang === 'es' ? 'Un plato delicioso esperando ser descubierto.' : lang === 'fr' ? 'Un plat délicieux en attente d\'être découvert.' : lang === 'zh' ? '等待被发现的美味菜肴。' : 'A delicious dish waiting to be discovered.'),
                    alternatives: analysis.alternatives || []
                };

                displayResult(currentDishData);
                showLoading(false);
                
                // Setup recipe links
                setupRecipeLinks(currentDishData.name);
                
                addToHistory(currentDishData);

            } catch (error) {
                console.error('Analysis error:', error);
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                
                // More specific error message based on error type
                let errorMessage = t.analysisError || 'Looks like I can\'t reach the recipe data right now. Let\'s retry soon!';
                
                if (error.message && error.message.includes('API error')) {
                    errorMessage = t.apiError || 'Unable to connect to the analysis service. Please check your internet connection and try again.';
                } else if (error.message && error.message.includes('Failed to fetch')) {
                    errorMessage = t.networkError || 'Network error. Please check your internet connection and try again.';
                }
                
                showError(errorMessage);
                showLoading(false);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ============================================
        // RESULT DISPLAY
        // ============================================
        function displayResult(dishData) {
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            
            const resultSection = document.getElementById('resultSection');
            const dishName = document.getElementById('dishName');
            const confidenceBadge = document.getElementById('confidenceBadge');
            const dishDescription = document.getElementById('dishDescription');
            const alternativesSection = document.getElementById('alternativesSection');
            const alternativeChips = document.getElementById('alternativeChips');

            // Set dish name - display in user's language
            if (dishData.isKorean && dishData.nameKorean) {
                // For Korean dishes, show both translated name and Korean name
                dishName.textContent = `${dishData.name} (${dishData.nameKorean})`;
            } else {
                dishName.textContent = dishData.name;
                if (dishData.cuisine && dishData.cuisine !== 'Unknown' && dishData.cuisine !== '알 수 없음' && dishData.cuisine !== 'Desconocido' && dishData.cuisine !== 'Inconnu' && dishData.cuisine !== '未知') {
                    dishName.textContent += ` • ${dishData.cuisine}`;
                }
            }

            // Set confidence badge with translation
            const confidence = Math.round(dishData.confidence * 100);
            confidenceBadge.textContent = `${confidence}% ${t.confident || 'confident'}`;
            
            if (dishData.confidence >= 0.8) {
                confidenceBadge.className = 'confidence-badge';
            } else if (dishData.confidence >= 0.5) {
                confidenceBadge.className = 'confidence-badge medium';
            } else {
                confidenceBadge.className = 'confidence-badge low';
            }

            // Set description - already in user's language from API
            let descriptionText = dishData.description || '';
            // Remove any JSON artifacts or code blocks
            descriptionText = descriptionText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            // If description looks like JSON, try to extract meaningful text
            if (descriptionText.startsWith('{') || descriptionText.startsWith('[')) {
                try {
                    const parsed = JSON.parse(descriptionText);
                    descriptionText = parsed.description || parsed.text || descriptionText;
                } catch (e) {
                    // If parsing fails, just use the text as is but clean it up
                    descriptionText = descriptionText.replace(/[{}[\]]/g, '').replace(/"/g, '').trim();
                }
            }
            dishDescription.innerHTML = `<strong>${dishData.name}</strong><br><br>${descriptionText}`;

            // Show alternatives if confidence is low
            if (dishData.confidence < 0.5) {
                // Remove any existing low confidence message
                const existingMsg = dishDescription.parentNode.querySelector('.warm-message');
                if (existingMsg) existingMsg.remove();
                
                // Very low confidence - show encouraging message in user's language
                const lowConfidenceMsg = document.createElement('div');
                lowConfidenceMsg.className = 'warm-message';
                lowConfidenceMsg.style.marginTop = '1rem';
                const cuisineText = dishData.cuisine || '';
                // Construct message based on language
                let message = '';
                if (lang === 'ko') {
                    message = `완전히 확신할 수는 없지만, 이것은 <strong>${dishData.name}</strong>${cuisineText ? ` — ${cuisineText} 요리` : ''}일 수 있습니다. 어떤 것이 더 가까워 보이나요?`;
                } else if (lang === 'es') {
                    message = `No estoy completamente seguro, pero esto podría ser <strong>${dishData.name}</strong>${cuisineText ? ` — un plato ${cuisineText}` : ''}. ¿Cuál se parece más al tuyo?`;
                } else if (lang === 'fr') {
                    message = `Je ne suis pas complètement sûr, mais cela pourrait être <strong>${dishData.name}</strong>${cuisineText ? ` — un plat ${cuisineText}` : ''}. Lequel ressemble le plus au vôtre ?`;
                } else if (lang === 'zh') {
                    message = `我不完全确定，但这可能是 <strong>${dishData.name}</strong>${cuisineText ? ` — 一道${cuisineText}菜` : ''}。哪一个更接近您的？`;
                } else {
                    message = `I'm not completely sure, but this could be <strong>${dishData.name}</strong>${cuisineText ? ` — a ${cuisineText} dish` : ''}. Which one looks closer to yours?`;
                }
                lowConfidenceMsg.innerHTML = `<p>${message}</p>`;
                dishDescription.parentNode.insertBefore(lowConfidenceMsg, dishDescription.nextSibling);
            }
            
            if (dishData.confidence < 0.8 && dishData.alternatives && dishData.alternatives.length > 0) {
                alternativesSection.style.display = 'block';
                alternativeChips.innerHTML = '';
                dishData.alternatives.forEach(alt => {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.textContent = alt;
                    chip.addEventListener('click', () => {
                        // Could implement alternative selection here
                        const lang = getCurrentLanguage();
                        const t = translations[lang] || translations.en;
                        alert(t.alternativeSelected ? t.alternativeSelected.replace('${alt}', alt) : `You selected: ${alt}. This feature can be enhanced to search for this dish.`);
                    });
                    alternativeChips.appendChild(chip);
                });
            } else {
                alternativesSection.style.display = 'none';
            }

            // Update favorite button state
            updateFavoriteButtonState();

            // Show result section
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideResult() {
            document.getElementById('resultSection').style.display = 'none';
            // Reset favorite button when hiding results
            updateFavoriteButtonState();
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function showError(message) {
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'block';
            resultSection.innerHTML = `
                <div class="error-message">
                    <h3 style="margin-bottom: 0.5rem;">Oops! 🌶</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // ============================================
        // RECIPE LINKS
        // ============================================
        function setupRecipeLinks(dishName) {
            const recipeLinksContainer = document.getElementById('recipeLinks');
            if (!recipeLinksContainer) return;
            
            // Use just the dish name for search - no cuisine suffix needed
            const searchTerm = dishName;
            
            const encodedTerm = encodeURIComponent(searchTerm);
            
            // Recipe sites with their search URLs
            const recipeSites = [
                {
                    name: 'Maangchi',
                    url: `https://www.maangchi.com/search?q=${encodedTerm}`,
                    icon: '🍳'
                },
                {
                    name: 'Korean Bapsang',
                    url: `https://www.koreanbapsang.com/?s=${encodedTerm}`,
                    icon: '🥢'
                },
                {
                    name: 'Serious Eats',
                    url: `https://www.seriouseats.com/search?q=${encodedTerm}`,
                    icon: '🍽️'
                },
                {
                    name: 'AllRecipes',
                    url: `https://www.allrecipes.com/search?q=${encodedTerm}`,
                    icon: '📖'
                }
            ];
            
            // Create recipe links
            recipeLinksContainer.innerHTML = recipeSites.map(site => `
                <a href="${site.url}" class="recipe-link" target="_blank" rel="noopener noreferrer">
                    <span style="margin-right: 0.5rem;">${site.icon}</span>
                    <span>${site.name}</span>
                    <span style="margin-left: auto;">→</span>
                </a>
            `).join('');
        }

        // ============================================
        // HISTORY MANAGEMENT
        // ============================================
        function addToHistory(dishData) {
            let history = JSON.parse(localStorage.getItem('biteSightHistory') || '[]');
            
            // Save complete dish data including all result fields
            const historyItem = {
                name: dishData.name,
                nameKorean: dishData.nameKorean,
                isKorean: dishData.isKorean,
                cuisine: dishData.cuisine,
                confidence: dishData.confidence,
                description: dishData.description,
                alternatives: dishData.alternatives || [],
                thumbnail: document.getElementById('dishImage').src,
                imageSrc: document.getElementById('dishImage').src, // Save full image for restoration
                timestamp: new Date().toISOString()
            };

            // Remove duplicates
            history = history.filter(item => item.name !== dishData.name);
            
            // Add to beginning
            history.unshift(historyItem);
            
            // Keep only last 10
            history = history.slice(0, 10);
            
            localStorage.setItem('biteSightHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('biteSightHistory') || '[]');
            const historyGrid = document.getElementById('historyGrid');
            const warmMessage = document.getElementById('warmMessage');
            const warmMessageText = document.getElementById('warmMessageText');
            
            if (history.length === 0) {
                warmMessage.style.display = 'none';
                historyGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p>Your exploration history will appear here</p>
                    </div>
                `;
                return;
            }

            // Show warm message with recent dishes
            const recentDishes = history.slice(0, 3).map(item => item.nameKorean || item.name).join(', ');
            if (history.length >= 2) {
                warmMessageText.textContent = `You recently explored ${recentDishes} — want to save them for your cooking list?`;
                warmMessage.style.display = 'block';
            } else {
                warmMessage.style.display = 'none';
            }

            historyGrid.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadDishFromHistory('${item.name.replace(/'/g, "\\'")}')">
                    <img src="${item.thumbnail}" alt="${item.name}" class="item-thumbnail">
                    <div class="item-name">${item.nameKorean ? `${item.name}<br><small>${item.nameKorean}</small>` : item.name}</div>
                    <div class="item-time">${formatTime(item.timestamp)}</div>
                </div>
            `).join('');
        }

        function getCurrentLanguage() {
            const settings = JSON.parse(localStorage.getItem('biteSightSettings') || '{}');
            return settings.language || 'en';
        }

        function formatTime(timestamp) {
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return t.justNow;
            if (minutes < 60) return `${minutes}${t.minutesAgo}`;
            if (hours < 24) return `${hours}${t.hoursAgo}`;
            if (days < 7) return `${days}${t.daysAgo}`;
            return date.toLocaleDateString();
        }

        // ============================================
        // FAVORITES MANAGEMENT
        // ============================================
        function updateFavoriteButtonState() {
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            const favoriteBtn = document.getElementById('favoriteBtn');
            
            if (!currentDishData) {
                // Reset button if no dish data
                favoriteBtn.textContent = t.saveToFavorites;
                favoriteBtn.classList.remove('active');
                return;
            }

            const favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            const exists = favorites.find(f => f.name === currentDishData.name);
            
            if (exists) {
                favoriteBtn.textContent = t.saved;
                favoriteBtn.classList.add('active');
            } else {
                favoriteBtn.textContent = t.saveToFavorites;
                favoriteBtn.classList.remove('active');
            }
        }

        document.getElementById('favoriteBtn').addEventListener('click', () => {
            if (!currentDishData) return;
            
            let favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            
            // Save complete dish data including all result fields
            const favoriteItem = {
                name: currentDishData.name,
                nameKorean: currentDishData.nameKorean,
                isKorean: currentDishData.isKorean,
                cuisine: currentDishData.cuisine,
                confidence: currentDishData.confidence,
                description: currentDishData.description,
                alternatives: currentDishData.alternatives || [],
                thumbnail: document.getElementById('dishImage').src,
                imageSrc: document.getElementById('dishImage').src, // Save full image for restoration
                timestamp: new Date().toISOString()
            };

            // Check if already favorited
            const exists = favorites.find(f => f.name === currentDishData.name);
            if (exists) {
                favorites = favorites.filter(f => f.name !== currentDishData.name);
            } else {
                favorites.unshift(favoriteItem);
            }
            
            localStorage.setItem('biteSightFavorites', JSON.stringify(favorites));
            updateFavoriteButtonState();
            loadFavorites();
        });

        function loadFavorites() {
            const favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            const favoritesGrid = document.getElementById('favoritesGrid');
            
            if (favorites.length === 0) {
                favoritesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <p>Save dishes you love to revisit them later</p>
                    </div>
                `;
                return;
            }

            favoritesGrid.innerHTML = favorites.map(item => `
                <div class="favorite-item" onclick="loadDishFromFavorites('${item.name.replace(/'/g, "\\'")}')">
                    <img src="${item.thumbnail}" alt="${item.name}" class="item-thumbnail">
                    <div class="item-name">${item.nameKorean ? `${item.name}<br><small>${item.nameKorean}</small>` : item.name}</div>
                </div>
            `).join('');
        }

        // ============================================
        // SHARE FUNCTIONALITY
        // ============================================
        document.getElementById('shareBtn').addEventListener('click', async () => {
            if (!currentDishData) return;

            const shareData = {
                title: `I discovered ${currentDishData.name} with Ok Snap! 🍲`,
                text: `Check out this amazing dish: ${currentDishData.name}${currentDishData.cuisine && currentDishData.cuisine !== 'Unknown' ? ` (${currentDishData.cuisine})` : ''}`,
                url: window.location.href
            };

            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.log('Share cancelled');
                }
            } else {
                // Fallback: copy to clipboard
                const text = `${shareData.title}\n${shareData.text}\n${shareData.url}`;
                await navigator.clipboard.writeText(text);
                alert('Link copied to clipboard! Share it with your friends.');
            }
        });

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        function initializeAuth() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const closeModal = document.getElementById('closeModal');
            const loginModal = document.getElementById('loginModal');
            const showSignup = document.getElementById('showSignup');
            const showLogin = document.getElementById('showLogin');
            const emailLoginForm = document.getElementById('emailLoginForm');
            const emailSignupForm = document.getElementById('emailSignupForm');
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const googleSignupBtn = document.getElementById('googleSignupBtn');
            const modalTitle = document.getElementById('modalTitle');

            // Open modal
            loginBtn.addEventListener('click', () => {
                showLoginForm();
                loginModal.classList.add('active');
            });

            // Close modal
            closeModal.addEventListener('click', () => {
                loginModal.classList.remove('active');
                clearErrors();
            });

            loginModal.addEventListener('click', (e) => {
                if (e.target === loginModal) {
                    loginModal.classList.remove('active');
                    clearErrors();
                }
            });

            // Switch between login and signup
            showSignup.addEventListener('click', () => {
                showSignupForm();
            });

            showLogin.addEventListener('click', () => {
                showLoginForm();
            });

            // Email login
            emailLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');

                try {
                    clearErrors();
                    await auth.signInWithEmailAndPassword(email, password);
                    loginModal.classList.remove('active');
                    emailLoginForm.reset();
                } catch (error) {
                    errorDiv.textContent = getErrorMessage(error);
                }
            });

            // Email signup
            emailSignupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const errorDiv = document.getElementById('signupError');

                try {
                    clearErrors();
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: name });
                    loginModal.classList.remove('active');
                    emailSignupForm.reset();
                } catch (error) {
                    errorDiv.textContent = getErrorMessage(error);
                }
            });

            // Google login
            googleLoginBtn.addEventListener('click', async () => {
                try {
                    clearErrors();
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                    loginModal.classList.remove('active');
                } catch (error) {
                    document.getElementById('loginError').textContent = getErrorMessage(error);
                }
            });

            // Google signup (same as login)
            googleSignupBtn.addEventListener('click', async () => {
                try {
                    clearErrors();
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                    loginModal.classList.remove('active');
                } catch (error) {
                    document.getElementById('signupError').textContent = getErrorMessage(error);
                }
            });

            // Logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Logout error:', error);
                }
            });
        }

        function showLoginForm() {
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('modalTitle').textContent = t.login;
            clearErrors();
            // Re-apply translations to update form labels
            applyTranslations(lang);
        }

        function showSignupForm() {
            const lang = getCurrentLanguage();
            const t = translations[lang] || translations.en;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('modalTitle').textContent = t.signupTitle;
            clearErrors();
            // Re-apply translations to update form labels
            applyTranslations(lang);
        }

        function clearErrors() {
            document.getElementById('loginError').textContent = '';
            document.getElementById('signupError').textContent = '';
        }

        function getErrorMessage(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                    return 'No account found with this email.';
                case 'auth/wrong-password':
                    return 'Incorrect password.';
                case 'auth/email-already-in-use':
                    return 'This email is already registered.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/invalid-email':
                    return 'Invalid email address.';
                case 'auth/operation-not-allowed':
                    return 'This sign-in method is not enabled.';
                case 'auth/popup-closed-by-user':
                    return 'Sign-in popup was closed.';
                default:
                    return error.message || 'An error occurred. Please try again.';
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function loadDishFromHistory(name) {
            const history = JSON.parse(localStorage.getItem('biteSightHistory') || '[]');
            const historyItem = history.find(item => item.name === name);
            
            if (!historyItem) {
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                alert(t.historyItemNotFound || 'History item not found.');
                return;
            }
            
            // Restore the complete dish data (with fallbacks for old history items)
            currentDishData = {
                name: historyItem.name || '',
                nameKorean: historyItem.nameKorean || '',
                isKorean: historyItem.isKorean || false,
                cuisine: historyItem.cuisine || '',
                confidence: historyItem.confidence || 0.5,
                description: historyItem.description || '',
                alternatives: historyItem.alternatives || []
            };
            
            // Restore the image (use imageSrc if available, otherwise fallback to thumbnail)
            const dishImage = document.getElementById('dishImage');
            if (dishImage) {
                dishImage.src = historyItem.imageSrc || historyItem.thumbnail || '';
            }
            
            // Display the result exactly as it was
            displayResult(currentDishData);
            
            // Setup recipe links
            setupRecipeLinks(currentDishData.name);
            
            // Switch to discover tab to show the result
            switchTab('discover');
        }
        
        function loadDishFromFavorites(name) {
            const favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            const favoriteItem = favorites.find(item => item.name === name);
            
            if (!favoriteItem) {
                const lang = getCurrentLanguage();
                const t = translations[lang] || translations.en;
                alert(t.favoriteItemNotFound || 'Favorite item not found.');
                return;
            }
            
            // Restore the complete dish data (with fallbacks for old favorite items)
            currentDishData = {
                name: favoriteItem.name || '',
                nameKorean: favoriteItem.nameKorean || '',
                isKorean: favoriteItem.isKorean || false,
                cuisine: favoriteItem.cuisine || '',
                confidence: favoriteItem.confidence || 0.5,
                description: favoriteItem.description || '',
                alternatives: favoriteItem.alternatives || []
            };
            
            // Restore the image (use imageSrc if available, otherwise fallback to thumbnail)
            const dishImage = document.getElementById('dishImage');
            if (dishImage) {
                dishImage.src = favoriteItem.imageSrc || favoriteItem.thumbnail || '';
            }
            
            // Display the result exactly as it was
            displayResult(currentDishData);
            
            // Setup recipe links
            setupRecipeLinks(currentDishData.name);
            
            // Switch to discover tab to show the result
            switchTab('discover');
        }
    </script>
</body>
</html>
