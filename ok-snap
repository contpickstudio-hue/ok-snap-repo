<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiteSight - Discover Food Through Your Lens</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #d32f2f;
            --primary-dark: #b71c1c;
            --secondary: #ff6f00;
            --accent: #ffc107;
            --bg: #fafafa;
            --surface: #ffffff;
            --text: #212121;
            --text-light: #757575;
            --border: #e0e0e0;
            --success: #4caf50;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #fff5f5 0%, #fafafa 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            padding: 3rem 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            margin-bottom: 3rem;
            box-shadow: 0 4px 20px var(--shadow-lg);
            position: relative;
        }

        .header-content {
            position: relative;
        }

        .auth-section {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .login-btn {
            background: white;
            color: var(--primary);
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.95;
            font-weight: 300;
        }

        .upload-section {
            background: var(--surface);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 8px 30px var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed var(--border);
            border-radius: 15px;
            padding: 4rem 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg);
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #fff9f9;
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: #ffeaea;
            transform: scale(1.02);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            opacity: 0.6;
        }

        .upload-text {
            font-size: 1.3rem;
            color: var(--text);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .upload-hint {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        #fileInput {
            display: none;
        }

        .upload-options {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .camera-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(255, 111, 0, 0.3);
        }

        .camera-btn:hover {
            background: #e65100;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 111, 0, 0.4);
        }

        .camera-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Camera Modal */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-container {
            position: relative;
            width: 90%;
            max-width: 600px;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #cameraVideo {
            width: 100%;
            display: block;
            max-height: 80vh;
            object-fit: contain;
        }

        .camera-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding: 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            align-items: center;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 5px solid white;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
        }

        .capture-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 255, 255, 0.5);
        }

        .capture-btn:active {
            transform: scale(0.95);
        }

        .capture-btn::after {
            content: '';
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
        }

        .camera-close-btn, .camera-flip-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 0.8rem 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .camera-close-btn:hover, .camera-flip-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .camera-error {
            color: white;
            text-align: center;
            padding: 2rem;
        }

        .camera-error h3 {
            margin-bottom: 1rem;
        }

        #previewContainer {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .preview-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .remove-preview {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .remove-preview:hover {
            background: rgba(211, 47, 47, 0.9);
            transform: scale(1.1);
        }

        #uploadPlaceholder {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
            margin-top: 1.5rem;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            display: none;
            background: var(--surface);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 8px 30px var(--shadow);
            margin-bottom: 2rem;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
        }

        .result-title {
            font-size: 2rem;
            color: var(--primary);
            font-weight: 700;
        }

        .confidence-badge {
            background: linear-gradient(135deg, var(--success) 0%, #66bb6a 100%);
            color: white;
            padding: 0.5rem 1.2rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .confidence-badge.medium {
            background: linear-gradient(135deg, var(--secondary) 0%, #ff8f00 100%);
        }

        .confidence-badge.low {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .dish-image {
            width: 100%;
            max-width: 500px;
            border-radius: 15px;
            margin: 0 auto 2rem;
            display: block;
            box-shadow: 0 8px 25px var(--shadow);
        }

        .dish-description {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text);
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .alternatives {
            margin: 2rem 0;
        }

        .alternatives-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .alternative-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .chip {
            background: var(--bg);
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .chip:hover {
            border-color: var(--primary);
            background: #ffeaea;
            transform: translateY(-2px);
        }

        .recipe-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border);
        }

        .recipe-link {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
            margin-right: 1rem;
            margin-bottom: 1rem;
        }

        .recipe-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 0.8rem 1.8rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        .btn-secondary.active {
            background: var(--primary);
            color: white;
        }

        .history-section, .favorites-section {
            background: var(--surface);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 30px var(--shadow);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-grid, .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.5rem;
        }

        .history-item, .favorite-item {
            background: var(--bg);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .history-item:hover, .favorite-item:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .item-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.8rem;
        }

        .item-name {
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
            margin-bottom: 0.3rem;
        }

        .item-time {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            opacity: 0.3;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            border-left: 4px solid var(--primary);
            padding: 1.5rem;
            border-radius: 8px;
            color: #c62828;
            margin: 2rem 0;
        }

        .warm-message {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            border-left: 4px solid var(--secondary);
            font-style: italic;
            color: #e65100;
        }

        /* Login Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: var(--bg);
            color: var(--text);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }

        .form-input {
            padding: 0.9rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }

        .auth-divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
            color: var(--text-light);
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .auth-divider::before {
            left: 0;
        }

        .auth-divider::after {
            right: 0;
        }

        .google-btn {
            background: white;
            color: var(--text);
            border: 2px solid var(--border);
            padding: 0.9rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            transition: all 0.3s ease;
        }

        .google-btn:hover {
            border-color: var(--primary);
            background: var(--bg);
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .error-text {
            color: var(--primary);
            font-size: 0.85rem;
            margin-top: -0.5rem;
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .auth-switch a {
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .auth-section {
                position: static;
                justify-content: center;
                margin-bottom: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .upload-section {
                padding: 2rem 1.5rem;
            }

            .result-section {
                padding: 1.5rem;
            }

            .history-grid, .favorites-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .modal {
                padding: 2rem 1.5rem;
            }

            .upload-options {
                flex-direction: column;
            }

            .camera-container {
                width: 100%;
                max-width: 100%;
                border-radius: 0;
            }

            .camera-controls {
                padding: 1.5rem;
            }

            .capture-btn {
                width: 60px;
                height: 60px;
            }

            .capture-btn::after {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="auth-section" id="authSection">
                    <div class="user-profile" id="userProfile" style="display: none;">
                        <img class="user-avatar" id="userAvatar" alt="User">
                        <span class="user-name" id="userName"></span>
                        <button class="login-btn" id="logoutBtn" style="display: none;">Logout</button>
                    </div>
                    <button class="login-btn" id="loginBtn">Login</button>
                </div>
                <h1>üç≤ BiteSight</h1>
                <p>Every meal has a story. Let's uncover the one in your photo. <br><small style="opacity: 0.9; font-size: 0.9em;">Special expertise in Korean cuisine üå∂</small></p>
            </div>
        </div>
    </header>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Login</h2>
                <button class="close-modal" id="closeModal">√ó</button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <form class="auth-form" id="emailLoginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="error-text" id="loginError"></div>
                    <button type="submit" class="btn">Login</button>
                </form>
                
                <div class="auth-divider">or</div>
                
                <button class="google-btn" id="googleLoginBtn">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>
                
                <div class="auth-switch">
                    Don't have an account? <a id="showSignup">Sign up</a>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <form class="auth-form" id="emailSignupForm">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" id="signupName" required placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="signupPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                    </div>
                    <div class="error-text" id="signupError"></div>
                    <button type="submit" class="btn">Sign Up</button>
                </form>
                
                <div class="auth-divider">or</div>
                
                <button class="google-btn" id="googleSignupBtn">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>
                
                <div class="auth-switch">
                    Already have an account? <a id="showLogin">Login</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Upload Section -->
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div id="previewContainer" style="display: none;" onclick="event.stopPropagation()">
                    <img id="previewImage" class="preview-image" alt="Preview">
                    <button type="button" class="remove-preview" id="removePreview" title="Remove image">√ó</button>
                </div>
                <div id="uploadPlaceholder">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <div class="upload-text">Upload a photo of food</div>
                    <div class="upload-hint">Drag and drop or click to browse ‚Ä¢ Korean dishes emphasized</div>
                </div>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <div class="upload-options">
                <button class="btn" id="analyzeBtn" disabled>Discover Your Dish</button>
                <button class="camera-btn" id="cameraBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    Use Camera
                </button>
            </div>
        </div>

        <!-- Camera Modal -->
        <div class="camera-modal" id="cameraModal">
            <div class="camera-container">
                <video id="cameraVideo" autoplay playsinline></video>
                <div class="camera-controls">
                    <button class="camera-close-btn" id="closeCameraBtn">Close</button>
                    <button class="capture-btn" id="captureBtn" title="Capture photo"></button>
                    <button class="camera-flip-btn" id="flipCameraBtn">Flip</button>
                </div>
                <div class="camera-error" id="cameraError" style="display: none;">
                    <h3>Camera Access Denied</h3>
                    <p>Please allow camera access to use this feature.</p>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: var(--text-light); font-size: 1.1rem;">Analyzing your photo... This might take a moment.</p>
        </div>

        <!-- Result Section -->
        <div class="result-section" id="resultSection">
            <div class="result-header">
                <h2 class="result-title" id="dishName"></h2>
                <span class="confidence-badge" id="confidenceBadge"></span>
            </div>
            <img class="dish-image" id="dishImage" alt="Uploaded dish">
            <div class="dish-description" id="dishDescription"></div>
            <div class="alternatives" id="alternativesSection" style="display: none;">
                <div class="alternatives-title">Could also be:</div>
                <div class="alternative-chips" id="alternativeChips"></div>
            </div>
            <div class="recipe-section">
                <h3 style="margin-bottom: 1rem; color: var(--text);">Ready to cook?</h3>
                <a href="#" class="recipe-link" id="recipeLink" target="_blank">View Recipe & Cultural Story ‚Üí</a>
                <div class="action-buttons">
                    <button class="btn-secondary" id="favoriteBtn">‚ù§Ô∏è Save to Favorites</button>
                    <button class="btn-secondary" id="shareBtn">üì§ Share Discovery</button>
                </div>
            </div>
        </div>

        <!-- Warm Message (shown when user has history) -->
        <div class="warm-message" id="warmMessage" style="display: none;">
            <p id="warmMessageText"></p>
        </div>

        <!-- History Section -->
        <div class="history-section">
            <h2 class="section-title">üìú Your Recent Discoveries</h2>
            <div class="history-grid" id="historyGrid">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <p>Your exploration history will appear here</p>
                </div>
            </div>
        </div>

        <!-- Favorites Section -->
        <div class="favorites-section">
            <h2 class="section-title">‚≠ê Your Favorite Dishes</h2>
            <div class="favorites-grid" id="favoritesGrid">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                    <p>Save dishes you love to revisit them later</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - Add your API keys here
        // ============================================
        const CONFIG = {
            // Get your OpenAI API key from: https://platform.openai.com/api-keys
            OPENAI_API_KEY: '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',
            
            // Hansik Archive API (Korean food database)
            // You may need to register at their website for an API key
            HANSIK_API_KEY: 'YOUR_HANSIK_API_KEY_HERE',
            HANSIK_API_URL: 'https://api.hansikarchive.org/api/v1',
            
            // Edamam API (Nutrition and recipes)
            // Register at: https://developer.edamam.com/
            EDAMAM_APP_ID: '8708d123',
            EDAMAM_APP_KEY: 'e95114275a9a9d66f2a4d42862bb8701',
            EDAMAM_API_URL: 'https://api.edamam.com/api/recipes/v2',

            // Firebase Configuration
            // IMPORTANT: You need the WEB APP config, not the service account JSON!
            // Steps to get the correct config:
            // 1. Go to https://console.firebase.google.com/
            // 2. Select your project: ok-snap-4677f
            // 3. Click the gear icon > Project Settings
            // 4. Scroll down to "Your apps" section
            // 5. If you don't have a web app, click the </> icon to add one
            // 6. Copy the config object (it should look like: const firebaseConfig = { apiKey: "AIza...", ... })
            // 7. The apiKey should start with "AIza..." NOT be a private key!
            FIREBASE_CONFIG: {
                apiKey: "AIzaSyAVo4jOkM_oqxtY3Olb2GSybqXf3uPr3u0", // Should start with "AIza..." - get from Firebase Console web app config
                authDomain: "ok-snap-4677f.firebaseapp.com",
                projectId: "ok-snap-4677f",
                storageBucket: "ok-snap-4677f.firebasestorage.app",
                messagingSenderId: "504422705809",
                appId: "1:504422705809:web:07ea84d18cd99686caed30" // This is different from projectId - get from Firebase Console
            }
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let currentImage = null;
        let currentDishData = null;
        let auth = null;
        let currentUser = null;
        let cameraStream = null;
        let facingMode = 'environment'; // 'user' for front, 'environment' for back

        // ============================================
        // FIREBASE INITIALIZATION
        // ============================================
        function initializeFirebase() {
            // Check if Firebase config is valid
            const config = CONFIG.FIREBASE_CONFIG;
            if (!config || !config.apiKey || config.apiKey.includes('YOUR_') || config.apiKey.includes('BEGIN PRIVATE KEY')) {
                console.warn('Firebase not configured correctly. Login features will not work.');
                console.warn('Please get your Firebase web app config from: https://console.firebase.google.com/');
                console.warn('The apiKey should start with "AIza..." not be a private key.');
                return false;
            }

            try {
                firebase.initializeApp(CONFIG.FIREBASE_CONFIG);
                auth = firebase.auth();
                
                // Test Firebase connection
                console.log('Firebase initialized successfully');
                console.log('Project:', config.projectId);
                
                // Listen for auth state changes
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    updateAuthUI();
                    if (user) {
                        console.log('User logged in:', user.email);
                    } else {
                        console.log('No user logged in');
                    }
                });
                
                // Test auth availability
                if (auth) {
                    console.log('Firebase Auth is ready');
                    console.log('‚úÖ Firebase is configured correctly!');
                    console.log('You can now test login functionality.');
                }
                
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                console.error('Error details:', error.message);
                alert('Firebase configuration error. Please check your config values.\n\nError: ' + error.message);
                return false;
            }
        }

        // ============================================
        // AUTHENTICATION UI
        // ============================================
        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const userProfile = document.getElementById('userProfile');
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');
            const logoutBtn = document.getElementById('logoutBtn');

            if (currentUser) {
                loginBtn.style.display = 'none';
                userProfile.style.display = 'flex';
                userName.textContent = currentUser.displayName || currentUser.email || 'User';
                userAvatar.src = currentUser.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(userName.textContent) + '&background=d32f2f&color=fff';
                logoutBtn.style.display = 'block';
            } else {
                loginBtn.style.display = 'block';
                userProfile.style.display = 'none';
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            initializeUpload();
            initializeCamera();
            initializeAuth();
            loadHistory();
            loadFavorites();
            
            // Handle remove preview button
            const removePreview = document.getElementById('removePreview');
            if (removePreview) {
                removePreview.addEventListener('click', (e) => {
                    e.stopPropagation();
                    resetUpload();
                });
            }
        });

        // ============================================
        // UPLOAD HANDLING
        // ============================================
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const analyzeBtn = document.getElementById('analyzeBtn');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            analyzeBtn.addEventListener('click', analyzeImage);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file.');
                return;
            }

            currentImage = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                // Show preview in upload area
                const previewContainer = document.getElementById('previewContainer');
                const previewImage = document.getElementById('previewImage');
                const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
                uploadPlaceholder.style.display = 'none';
                
                // Also set it for the result section (will be shown after analysis)
                document.getElementById('dishImage').src = e.target.result;
                
                document.getElementById('analyzeBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            currentImage = null;
            currentDishData = null;
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('uploadPlaceholder').style.display = 'flex';
            document.getElementById('fileInput').value = '';
            document.getElementById('analyzeBtn').disabled = true;
            hideResult();
        }

        // ============================================
        // CAMERA FUNCTIONALITY
        // ============================================
        function initializeCamera() {
            const cameraBtn = document.getElementById('cameraBtn');
            const closeCameraBtn = document.getElementById('closeCameraBtn');
            const captureBtn = document.getElementById('captureBtn');
            const flipCameraBtn = document.getElementById('flipCameraBtn');
            const cameraModal = document.getElementById('cameraModal');

            cameraBtn.addEventListener('click', openCamera);
            closeCameraBtn.addEventListener('click', closeCamera);
            captureBtn.addEventListener('click', capturePhoto);
            flipCameraBtn.addEventListener('click', flipCamera);
        }

        async function openCamera() {
            const cameraModal = document.getElementById('cameraModal');
            const cameraVideo = document.getElementById('cameraVideo');
            const cameraError = document.getElementById('cameraError');

            cameraModal.classList.add('active');
            cameraError.style.display = 'none';

            try {
                // Stop any existing stream
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }

                // Request camera access
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                cameraVideo.play();
            } catch (error) {
                console.error('Camera error:', error);
                cameraError.style.display = 'block';
                cameraVideo.style.display = 'none';
                
                let errorMessage = 'Unable to access camera. ';
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Please allow camera access in your browser settings.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on your device.';
                } else {
                    errorMessage += error.message;
                }
                cameraError.querySelector('p').textContent = errorMessage;
            }
        }

        function closeCamera() {
            const cameraModal = document.getElementById('cameraModal');
            cameraModal.classList.remove('active');

            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const cameraVideo = document.getElementById('cameraVideo');
            cameraVideo.srcObject = null;
        }

        function capturePhoto() {
            const cameraVideo = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            // Set canvas dimensions to match video
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;

            // Draw video frame to canvas
            context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);

            // Convert canvas to blob
            canvas.toBlob((blob) => {
                if (blob) {
                    // Create a File object from the blob
                    const file = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
                    
                    // Use the existing handleFile function
                    handleFile(file);
                    
                    // Close camera
                    closeCamera();
                }
            }, 'image/jpeg', 0.95);
        }

        async function flipCamera() {
            // Toggle between front and back camera
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            
            // Restart camera with new facing mode
            const cameraVideo = document.getElementById('cameraVideo');
            
            // Stop current stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            try {
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                cameraVideo.play();
            } catch (error) {
                console.error('Camera flip error:', error);
                // If flip fails, try to revert
                facingMode = facingMode === 'user' ? 'environment' : 'user';
            }
        }

        // ============================================
        // IMAGE ANALYSIS WITH OPENAI VISION
        // ============================================
        async function analyzeImage() {
            if (!currentImage) {
                showError('Please select an image first.');
                return;
            }

            if (CONFIG.OPENAI_API_KEY === 'YOUR_OPENAI_API_KEY_HERE') {
                showError('Please configure your OpenAI API key in the CONFIG section of the code.');
                return;
            }

            showLoading(true);
            hideResult();

            try {
                // Convert image to base64
                const base64Image = await fileToBase64(currentImage);

                // Call OpenAI Vision API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: `You are BiteSight, a food recognition expert with special expertise in Korean cuisine. You identify dishes from all cuisines, but have deeper knowledge and cultural context for Korean food (Hansik).
                                
                                Analyze images and identify ANY dish you see, with special emphasis and detail for Korean dishes. For Korean dishes, always include the Korean name (ÌïúÍ∏Ä).
                                
                                Respond in valid JSON format only. Structure:
                                {
                                    "dish_detected": true/false,
                                    "is_korean": true/false,  // true if Korean dish, false otherwise
                                    "dish_name": "English name",
                                    "dish_name_korean": "ÌïúÍ∏Ä name" or "",  // Only include if is_korean is true
                                    "cuisine": "Korean/Italian/Japanese/etc",
                                    "confidence": 0.0-1.0,
                                    "description": "Beautiful, warm description with colors, textures, plating, cultural context. For Korean dishes, include cultural significance. Write like a friendly food guide, not robotic.",
                                    "alternatives": ["alt1", "alt2", "alt3"] // only if confidence < 0.8
                                }
                                
                                If no dish detected: {"dish_detected": false, "message": "I couldn't recognize any food in this image. Try another angle or make sure the food is clearly visible."}
                                
                                Be culturally authentic, warm, and inspiring. Use light emojis occasionally (üå∂, üçö, ü•¢, üç≤, üçù, üçú, üç±).`
                            },
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'Analyze this image and identify the dish. If it\'s Korean food, provide extra cultural context and the Korean name. Otherwise, identify the dish and its cuisine. Provide a detailed, warm description.'
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: `data:${currentImage.type};base64,${base64Image}`
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const data = await response.json();
                let analysis;
                const rawContent = data.choices[0].message.content;
                
                try {
                    // Try to parse as JSON first
                    // Clean the content - remove markdown code blocks if present
                    let cleanedContent = rawContent.trim();
                    if (cleanedContent.startsWith('```json')) {
                        cleanedContent = cleanedContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    } else if (cleanedContent.startsWith('```')) {
                        cleanedContent = cleanedContent.replace(/```\n?/g, '').trim();
                    }
                    
                    analysis = JSON.parse(cleanedContent);
                } catch (e) {
                    // If not JSON, try to extract information from text
                    const content = rawContent;
                    // Look for any dish indicators in the text
                    if (content.toLowerCase().includes('dish') || content.toLowerCase().includes('food') || content.toLowerCase().includes('korean') || content.toLowerCase().includes('ÌïúÍµ≠')) {
                        // Extract dish name
                        const dishMatch = content.match(/([A-Za-z\s]+)\s*\(?ÌïúÍµ≠Ïñ¥|ÌïúÍ∏Ä\)?/i) || content.match(/([A-Za-z\s]{3,})/);
                        const isKorean = content.toLowerCase().includes('korean') || content.toLowerCase().includes('ÌïúÍµ≠');
                        analysis = {
                            dish_detected: true,
                            is_korean: isKorean,
                            dish_name: dishMatch ? dishMatch[1].trim() : 'Dish',
                            dish_name_korean: isKorean ? '' : '',
                            cuisine: isKorean ? 'Korean' : 'Unknown',
                            confidence: 0.7,
                            description: content.substring(0, 300) + '...',
                            alternatives: []
                        };
                    } else {
                        analysis = {
                            dish_detected: false,
                            message: "I couldn't recognize any food in this image. Try another angle or make sure the food is clearly visible."
                        };
                    }
                }

                if (!analysis.dish_detected) {
                    showError(analysis.message || "I couldn't recognize any food in this image. Try another angle or make sure the food is clearly visible.");
                    showLoading(false);
                    return;
                }

                // Process the result
                currentDishData = {
                    name: analysis.dish_name || 'Unknown Dish',
                    nameKorean: analysis.is_korean ? (analysis.dish_name_korean || '') : '',
                    isKorean: analysis.is_korean || false,
                    cuisine: analysis.cuisine || 'Unknown',
                    confidence: analysis.confidence || 0.5,
                    description: analysis.description || 'A delicious dish waiting to be discovered.',
                    alternatives: analysis.alternatives || []
                };

                displayResult(currentDishData);
                await fetchRecipe(currentDishData.name);
                addToHistory(currentDishData);
                showLoading(false);

            } catch (error) {
                console.error('Analysis error:', error);
                showError('Looks like I can\'t reach the recipe data right now. Let\'s retry soon!');
                showLoading(false);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ============================================
        // RESULT DISPLAY
        // ============================================
        function displayResult(dishData) {
            const resultSection = document.getElementById('resultSection');
            const dishName = document.getElementById('dishName');
            const confidenceBadge = document.getElementById('confidenceBadge');
            const dishDescription = document.getElementById('dishDescription');
            const alternativesSection = document.getElementById('alternativesSection');
            const alternativeChips = document.getElementById('alternativeChips');

            // Set dish name
            if (dishData.isKorean && dishData.nameKorean) {
                dishName.textContent = `${dishData.name} (${dishData.nameKorean})`;
            } else {
                dishName.textContent = dishData.name;
                if (dishData.cuisine && dishData.cuisine !== 'Unknown') {
                    dishName.textContent += ` ‚Ä¢ ${dishData.cuisine}`;
                }
            }

            // Set confidence badge
            const confidence = Math.round(dishData.confidence * 100);
            confidenceBadge.textContent = `${confidence}% confident`;
            
            if (dishData.confidence >= 0.8) {
                confidenceBadge.className = 'confidence-badge';
            } else if (dishData.confidence >= 0.5) {
                confidenceBadge.className = 'confidence-badge medium';
            } else {
                confidenceBadge.className = 'confidence-badge low';
            }

            // Set description - ensure it's plain text, not JSON
            let descriptionText = dishData.description || '';
            // Remove any JSON artifacts or code blocks
            descriptionText = descriptionText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            // If description looks like JSON, try to extract meaningful text
            if (descriptionText.startsWith('{') || descriptionText.startsWith('[')) {
                try {
                    const parsed = JSON.parse(descriptionText);
                    descriptionText = parsed.description || parsed.text || descriptionText;
                } catch (e) {
                    // If parsing fails, just use the text as is but clean it up
                    descriptionText = descriptionText.replace(/[{}[\]]/g, '').replace(/"/g, '').trim();
                }
            }
            dishDescription.innerHTML = `<strong>${dishData.name}</strong><br><br>${descriptionText}`;

            // Show alternatives if confidence is low
            if (dishData.confidence < 0.5) {
                // Very low confidence - show encouraging message
                const lowConfidenceMsg = document.createElement('div');
                lowConfidenceMsg.className = 'warm-message';
                lowConfidenceMsg.style.marginTop = '1rem';
                const cuisineText = dishData.isKorean ? 'Korean' : dishData.cuisine || '';
                lowConfidenceMsg.innerHTML = `<p>I'm not completely sure, but this could be <strong>${dishData.name}</strong>${cuisineText ? ` ‚Äî a ${cuisineText} dish` : ''}. Which one looks closer to yours?</p>`;
                dishDescription.parentNode.insertBefore(lowConfidenceMsg, dishDescription.nextSibling);
            }
            
            if (dishData.confidence < 0.8 && dishData.alternatives && dishData.alternatives.length > 0) {
                alternativesSection.style.display = 'block';
                alternativeChips.innerHTML = '';
                dishData.alternatives.forEach(alt => {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.textContent = alt;
                    chip.addEventListener('click', () => {
                        // Could implement alternative selection here
                        alert(`You selected: ${alt}. This feature can be enhanced to search for this dish.`);
                    });
                    alternativeChips.appendChild(chip);
                });
            } else {
                alternativesSection.style.display = 'none';
            }

            // Update favorite button state
            updateFavoriteButtonState();

            // Show result section
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideResult() {
            document.getElementById('resultSection').style.display = 'none';
            // Reset favorite button when hiding results
            updateFavoriteButtonState();
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function showError(message) {
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'block';
            resultSection.innerHTML = `
                <div class="error-message">
                    <h3 style="margin-bottom: 0.5rem;">Oops! üå∂</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // ============================================
        // RECIPE FETCHING
        // ============================================
        async function fetchRecipe(dishName) {
            const recipeLink = document.getElementById('recipeLink');
            recipeLink.href = '#';
            recipeLink.textContent = 'Loading recipe...';

            try {
                // Try Hansik Archive first
                let recipeUrl = null;
                
                if (CONFIG.HANSIK_API_KEY !== 'YOUR_HANSIK_API_KEY_HERE') {
                    try {
                        const hansikUrl = `${CONFIG.HANSIK_API_URL}/search?q=${encodeURIComponent(dishName)}&key=${CONFIG.HANSIK_API_KEY}`;
                        // Note: This is a placeholder - actual API endpoint may differ
                        // You'll need to check Hansik Archive API documentation
                        recipeUrl = hansikUrl;
                    } catch (e) {
                        console.log('Hansik API not available, trying Edamam...');
                    }
                }

                // Fallback to Edamam
                if (!recipeUrl && CONFIG.EDAMAM_APP_ID !== 'YOUR_EDAMAM_APP_ID_HERE') {
                    try {
                        // Add cuisine to search if available
                        const searchTerm = currentDishData && currentDishData.isKorean 
                            ? `${dishName} korean` 
                            : currentDishData && currentDishData.cuisine && currentDishData.cuisine !== 'Unknown'
                            ? `${dishName} ${currentDishData.cuisine.toLowerCase()}`
                            : dishName;
                        
                        const edamamUrl = `${CONFIG.EDAMAM_API_URL}?type=public&q=${encodeURIComponent(searchTerm)}&app_id=${CONFIG.EDAMAM_APP_ID}&app_key=${CONFIG.EDAMAM_APP_KEY}`;
                        const response = await fetch(edamamUrl);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.hits && data.hits.length > 0) {
                                recipeUrl = data.hits[0].recipe.url;
                            }
                        }
                    } catch (e) {
                        console.log('Edamam API error:', e);
                    }
                }

                // If no API available, use a search link
                if (!recipeUrl) {
                    const searchTerm = currentDishData && currentDishData.isKorean 
                        ? `${dishName} korean recipe` 
                        : currentDishData && currentDishData.cuisine && currentDishData.cuisine !== 'Unknown'
                        ? `${dishName} ${currentDishData.cuisine.toLowerCase()} recipe`
                        : `${dishName} recipe`;
                    recipeUrl = `https://www.google.com/search?q=${encodeURIComponent(searchTerm)}`;
                }

                recipeLink.href = recipeUrl;
                recipeLink.textContent = currentDishData && currentDishData.isKorean 
                    ? 'View Recipe & Cultural Story ‚Üí' 
                    : 'View Recipe ‚Üí';

            } catch (error) {
                console.error('Recipe fetch error:', error);
                const searchTerm = currentDishData && currentDishData.isKorean 
                    ? `${dishName} korean recipe` 
                    : `${dishName} recipe`;
                recipeLink.href = `https://www.google.com/search?q=${encodeURIComponent(searchTerm)}`;
                recipeLink.textContent = 'Search Recipe Online ‚Üí';
            }
        }

        // ============================================
        // HISTORY MANAGEMENT
        // ============================================
        function addToHistory(dishData) {
            let history = JSON.parse(localStorage.getItem('biteSightHistory') || '[]');
            
            const historyItem = {
                name: dishData.name,
                nameKorean: dishData.nameKorean,
                thumbnail: document.getElementById('dishImage').src,
                timestamp: new Date().toISOString()
            };

            // Remove duplicates
            history = history.filter(item => item.name !== dishData.name);
            
            // Add to beginning
            history.unshift(historyItem);
            
            // Keep only last 10
            history = history.slice(0, 10);
            
            localStorage.setItem('biteSightHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('biteSightHistory') || '[]');
            const historyGrid = document.getElementById('historyGrid');
            const warmMessage = document.getElementById('warmMessage');
            const warmMessageText = document.getElementById('warmMessageText');
            
            if (history.length === 0) {
                warmMessage.style.display = 'none';
                historyGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p>Your exploration history will appear here</p>
                    </div>
                `;
                return;
            }

            // Show warm message with recent dishes
            const recentDishes = history.slice(0, 3).map(item => item.nameKorean || item.name).join(', ');
            if (history.length >= 2) {
                warmMessageText.textContent = `You recently explored ${recentDishes} ‚Äî want to save them for your cooking list?`;
                warmMessage.style.display = 'block';
            } else {
                warmMessage.style.display = 'none';
            }

            historyGrid.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadDishFromHistory('${item.name}')">
                    <img src="${item.thumbnail}" alt="${item.name}" class="item-thumbnail">
                    <div class="item-name">${item.nameKorean ? `${item.name}<br><small>${item.nameKorean}</small>` : item.name}</div>
                    <div class="item-time">${formatTime(item.timestamp)}</div>
                </div>
            `).join('');
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // ============================================
        // FAVORITES MANAGEMENT
        // ============================================
        function updateFavoriteButtonState() {
            if (!currentDishData) {
                // Reset button if no dish data
                const favoriteBtn = document.getElementById('favoriteBtn');
                favoriteBtn.textContent = '‚ù§Ô∏è Save to Favorites';
                favoriteBtn.classList.remove('active');
                return;
            }

            const favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            const exists = favorites.find(f => f.name === currentDishData.name);
            const favoriteBtn = document.getElementById('favoriteBtn');
            
            if (exists) {
                favoriteBtn.textContent = '‚ù§Ô∏è Saved!';
                favoriteBtn.classList.add('active');
            } else {
                favoriteBtn.textContent = '‚ù§Ô∏è Save to Favorites';
                favoriteBtn.classList.remove('active');
            }
        }

        document.getElementById('favoriteBtn').addEventListener('click', () => {
            if (!currentDishData) return;
            
            let favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            
            const favoriteItem = {
                name: currentDishData.name,
                nameKorean: currentDishData.nameKorean,
                thumbnail: document.getElementById('dishImage').src,
                timestamp: new Date().toISOString()
            };

            // Check if already favorited
            const exists = favorites.find(f => f.name === currentDishData.name);
            if (exists) {
                favorites = favorites.filter(f => f.name !== currentDishData.name);
            } else {
                favorites.unshift(favoriteItem);
            }
            
            localStorage.setItem('biteSightFavorites', JSON.stringify(favorites));
            updateFavoriteButtonState();
            loadFavorites();
        });

        function loadFavorites() {
            const favorites = JSON.parse(localStorage.getItem('biteSightFavorites') || '[]');
            const favoritesGrid = document.getElementById('favoritesGrid');
            
            if (favorites.length === 0) {
                favoritesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <p>Save dishes you love to revisit them later</p>
                    </div>
                `;
                return;
            }

            favoritesGrid.innerHTML = favorites.map(item => `
                <div class="favorite-item">
                    <img src="${item.thumbnail}" alt="${item.name}" class="item-thumbnail">
                    <div class="item-name">${item.nameKorean ? `${item.name}<br><small>${item.nameKorean}</small>` : item.name}</div>
                </div>
            `).join('');
        }

        // ============================================
        // SHARE FUNCTIONALITY
        // ============================================
        document.getElementById('shareBtn').addEventListener('click', async () => {
            if (!currentDishData) return;

            const shareData = {
                title: `I discovered ${currentDishData.name} with BiteSight! üç≤`,
                text: `Check out this amazing dish: ${currentDishData.name}${currentDishData.cuisine && currentDishData.cuisine !== 'Unknown' ? ` (${currentDishData.cuisine})` : ''}`,
                url: window.location.href
            };

            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.log('Share cancelled');
                }
            } else {
                // Fallback: copy to clipboard
                const text = `${shareData.title}\n${shareData.text}\n${shareData.url}`;
                await navigator.clipboard.writeText(text);
                alert('Link copied to clipboard! Share it with your friends.');
            }
        });

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        function initializeAuth() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const closeModal = document.getElementById('closeModal');
            const loginModal = document.getElementById('loginModal');
            const showSignup = document.getElementById('showSignup');
            const showLogin = document.getElementById('showLogin');
            const emailLoginForm = document.getElementById('emailLoginForm');
            const emailSignupForm = document.getElementById('emailSignupForm');
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const googleSignupBtn = document.getElementById('googleSignupBtn');
            const modalTitle = document.getElementById('modalTitle');

            // Open modal
            loginBtn.addEventListener('click', () => {
                showLoginForm();
                loginModal.classList.add('active');
            });

            // Close modal
            closeModal.addEventListener('click', () => {
                loginModal.classList.remove('active');
                clearErrors();
            });

            loginModal.addEventListener('click', (e) => {
                if (e.target === loginModal) {
                    loginModal.classList.remove('active');
                    clearErrors();
                }
            });

            // Switch between login and signup
            showSignup.addEventListener('click', () => {
                showSignupForm();
            });

            showLogin.addEventListener('click', () => {
                showLoginForm();
            });

            // Email login
            emailLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');

                try {
                    clearErrors();
                    await auth.signInWithEmailAndPassword(email, password);
                    loginModal.classList.remove('active');
                    emailLoginForm.reset();
                } catch (error) {
                    errorDiv.textContent = getErrorMessage(error);
                }
            });

            // Email signup
            emailSignupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const errorDiv = document.getElementById('signupError');

                try {
                    clearErrors();
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: name });
                    loginModal.classList.remove('active');
                    emailSignupForm.reset();
                } catch (error) {
                    errorDiv.textContent = getErrorMessage(error);
                }
            });

            // Google login
            googleLoginBtn.addEventListener('click', async () => {
                try {
                    clearErrors();
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                    loginModal.classList.remove('active');
                } catch (error) {
                    document.getElementById('loginError').textContent = getErrorMessage(error);
                }
            });

            // Google signup (same as login)
            googleSignupBtn.addEventListener('click', async () => {
                try {
                    clearErrors();
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                    loginModal.classList.remove('active');
                } catch (error) {
                    document.getElementById('signupError').textContent = getErrorMessage(error);
                }
            });

            // Logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Logout error:', error);
                }
            });
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('modalTitle').textContent = 'Login';
            clearErrors();
        }

        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('modalTitle').textContent = 'Sign Up';
            clearErrors();
        }

        function clearErrors() {
            document.getElementById('loginError').textContent = '';
            document.getElementById('signupError').textContent = '';
        }

        function getErrorMessage(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                    return 'No account found with this email.';
                case 'auth/wrong-password':
                    return 'Incorrect password.';
                case 'auth/email-already-in-use':
                    return 'This email is already registered.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/invalid-email':
                    return 'Invalid email address.';
                case 'auth/operation-not-allowed':
                    return 'This sign-in method is not enabled.';
                case 'auth/popup-closed-by-user':
                    return 'Sign-in popup was closed.';
                default:
                    return error.message || 'An error occurred. Please try again.';
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function loadDishFromHistory(name) {
            // This could be enhanced to reload dish data
            alert(`Loading ${name}... This feature can be enhanced to show full details.`);
        }
    </script>
</body>
</html>
