<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="OK-Snap Recipe Blog - Explore our collection of Korean recipes, cooking tips, and food stories.">
    <title>Recipe Blog - OK-Snap</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo">OK-Snap</h1>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="blog.html" class="nav-link active">Blog</a>
                    <a href="about.html" class="nav-link">About</a>
                    <a href="contact.html" class="nav-link">Contact</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- Blog Listing View -->
        <section id="blogListing" class="blog-listing">
            <div class="page-header">
                <div class="container">
                    <h1 class="page-title">Recipe Blog</h1>
                    <p class="page-subtitle">Discover authentic Korean recipes and cooking stories</p>
                </div>
            </div>

            <section class="blog-section">
                <div class="container">
                    <div class="posts-grid" id="blogPosts">
                        <!-- Posts will be loaded dynamically from Supabase -->
                    </div>
                </div>
            </section>
        </section>

        <!-- Individual Blog Post View -->
        <section id="blogPostView" class="blog-post-view" style="display: none;">
            <div class="container">
                <article class="blog-post" id="blogPostContent">
                    <!-- Blog content will be loaded dynamically from Supabase -->
                </article>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 OK-Snap. All rights reserved.</p>
        </div>
    </footer>

    <script src="scripts.js"></script>
    <script>
        // Configuration object for URLs
        const CONFIG = {
            API_BASE: null,
            PUBLIC_SITE_URL: null
        };
        
        // Load configuration from API endpoint (non-blocking)
        (async function loadConfig() {
            try {
                let configBaseUrl = 'https://ok-snap-identifier.vercel.app';
                if (typeof window !== 'undefined' && window.location) {
                    const origin = window.location.origin;
                    if (origin.includes('localhost') || origin.includes('vercel.app')) {
                        configBaseUrl = origin;
                    }
                }
                const response = await fetch(`${configBaseUrl}/api/config`);
                if (response.ok) {
                    const configData = await response.json();
                    if (configData.API_BASE_URL) CONFIG.API_BASE = configData.API_BASE_URL;
                    if (configData.PUBLIC_SITE_URL) CONFIG.PUBLIC_SITE_URL = configData.PUBLIC_SITE_URL;
                }
            } catch (error) {
                console.debug('Config endpoint not available, using fallbacks');
            }
        })();
        
        // Get API base URL
        function getApiBase() {
            // If config loaded from endpoint, use it
            if (CONFIG && CONFIG.API_BASE) {
                return CONFIG.API_BASE;
            }
            // Fallback logic
            if (typeof window !== 'undefined' && window.location) {
                const origin = window.location.origin;
                if (origin.includes('localhost') || origin.includes('vercel.app')) {
                    return origin;
                }
            }
            // Final fallback
            return 'https://ok-snap-identifier.vercel.app';
        }

        // Check if we should show a single blog post (from URL query parameter)
        function checkForBlogPost() {
            const urlParams = new URLSearchParams(window.location.search);
            const slug = urlParams.get('slug');
            
            if (slug) {
                loadBlogPost(slug);
            } else {
                loadBlogPosts();
            }
        }

        // Load blog posts list from Supabase
        async function loadBlogPosts() {
            const postsGrid = document.getElementById('blogPosts');
            const blogListing = document.getElementById('blogListing');
            const blogPostView = document.getElementById('blogPostView');
            
            // Show listing, hide post view
            if (blogListing) blogListing.style.display = 'block';
            if (blogPostView) blogPostView.style.display = 'none';
            
            try {
                const apiBase = getApiBase();
                const response = await fetch(`${apiBase}/api/blogs`);
                
                if (response.ok) {
                    const blogs = await response.json();
                    if (Array.isArray(blogs) && blogs.length > 0) {
                        console.log(`[blog.html] Loaded ${blogs.length} blogs from Supabase`);
                        renderBlogPosts(blogs);
                        return;
                    }
                }
            } catch (error) {
                console.error('[blog.html] Failed to fetch blogs from Supabase:', error);
            }
            
            // Fallback: Try recipes-json API
            try {
                const apiBase = getApiBase();
                const response = await fetch(`${apiBase}/api/recipes-json`);
                
                if (response.ok) {
                    const recipes = await response.json();
                    if (Array.isArray(recipes) && recipes.length > 0) {
                        console.log(`[blog.html] Loaded ${recipes.length} recipes from recipes-json API`);
                        renderBlogPosts(recipes);
                        return;
                    }
                }
            } catch (error) {
                console.error('[blog.html] Failed to fetch from recipes-json:', error);
            }
            
            // No blogs found
            postsGrid.innerHTML = '<p class="no-posts">No blog posts yet. Check back soon!</p>';
        }
        
        // Load a single blog post from Supabase
        async function loadBlogPost(slug) {
            const blogListing = document.getElementById('blogListing');
            const blogPostView = document.getElementById('blogPostView');
            const blogPostContent = document.getElementById('blogPostContent');
            
            // Show post view, hide listing
            if (blogListing) blogListing.style.display = 'none';
            if (blogPostView) blogPostView.style.display = 'block';
            
            try {
                const apiBase = getApiBase();
                const response = await fetch(`${apiBase}/api/blogs/${slug}`);
                
                if (response.ok) {
                    const blog = await response.json();
                    console.log('[blog.html] Loaded blog post from Supabase:', blog.slug);
                    renderBlogPost(blog);
                } else if (response.status === 404) {
                    blogPostContent.innerHTML = `
                        <div class="blog-post-header">
                            <h1 class="blog-post-title">Blog Post Not Found</h1>
                            <p>The blog post you're looking for doesn't exist.</p>
                            <a href="blog.html" class="btn btn-secondary">Back to Blog</a>
                        </div>
                    `;
                } else {
                    throw new Error(`Failed to fetch blog: ${response.status}`);
                }
            } catch (error) {
                console.error('[blog.html] Failed to fetch blog post:', error);
                blogPostContent.innerHTML = `
                    <div class="blog-post-header">
                        <h1 class="blog-post-title">Error Loading Blog Post</h1>
                        <p>${error.message}</p>
                        <a href="blog.html" class="btn btn-secondary">Back to Blog</a>
                    </div>
                `;
            }
        }
        
        // Render blog posts list
        function renderBlogPosts(blogs) {
            const postsGrid = document.getElementById('blogPosts');
            postsGrid.innerHTML = blogs.map(blog => {
                const slug = blog.slug || (blog.name ? blog.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') : '');
                const title = blog.title || blog.name || 'Untitled Recipe';
                const date = blog.createdAt ? new Date(blog.createdAt).toLocaleDateString() : 'Date unknown';
                const imageUrl = blog.imageUrl || blog.image_url;
                
                return `
                    <article class="post-card">
                        ${imageUrl ? `<div class="post-image"><img src="${imageUrl}" alt="${title}" loading="lazy"></div>` : ''}
                        <div class="post-content">
                            <h2 class="post-title"><a href="blog.html?slug=${slug}">${title}</a></h2>
                            ${blog.nameKorean ? `<p class="post-subtitle">${blog.nameKorean}</p>` : ''}
                            <p class="post-date">Published: ${date}</p>
                            <a href="blog.html?slug=${slug}" class="btn btn-secondary">Read More</a>
                        </div>
                    </article>
                `;
            }).join('');
        }
        
        // Render single blog post
        function renderBlogPost(blog) {
            const blogPostContent = document.getElementById('blogPostContent');
            const date = blog.createdAt ? new Date(blog.createdAt).toLocaleDateString() : 'Date unknown';
            
            blogPostContent.innerHTML = `
                <div class="blog-post-header">
                    <h1 class="blog-post-title">${blog.title || blog.name}${blog.nameKorean ? ` (${blog.nameKorean})` : ''}</h1>
                    <div class="blog-post-meta">
                        <span>Published: ${date}</span>
                        ${blog.cuisine ? `<span> • ${blog.cuisine}</span>` : ''}
                    </div>
                </div>
                ${blog.imageUrl || blog.image_url ? `
                    <div class="blog-featured-image">
                        <img src="${blog.imageUrl || blog.image_url}" alt="${blog.title || blog.name}" style="width: 100%; max-width: 800px; height: auto; border-radius: 12px; margin: 2rem auto; display: block; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                    </div>
                ` : ''}
                <div class="blog-post-content">
                    ${blog.content || '<p>Content not available.</p>'}
                </div>
                <div class="blog-post-footer" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee;">
                    <a href="blog.html" class="btn btn-secondary">← Back to Blog</a>
                </div>
            `;
        }
        
        // Initialize on page load
        checkForBlogPost();
    </script>
</body>
</html>

